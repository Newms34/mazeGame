var socket=io();console.log("Socket",socket);var app=angular.module("mazeGame",[]).controller("maze-con",function($scope,$http,$q,$interval,$window,combatFac,UIFac){$scope.width=6,$scope.height=6,$scope.path=[],$scope.backtraceNum,$scope.currCell,$scope.bombsLeft=5,$scope.cellsDone=0,$scope.moveReady=!1,$scope.cells=[],$scope.invActive=!1,$scope.setActive=!1,$scope.intTarg,$scope.playerItems=[],$scope.possRoomConts=["loot","mons","npcs","jewl"," ","exit"," "," ","mons","mons"],$scope.uName="",($scope.checkPhone=function(){var isMobile=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(isMobile=!0),isMobile&&($window.location.href="./mobile")})(),$scope.cell=function(id,cont){this.id=id,this.x=id.split("-")[0],this.y=id.split("-")[1],this.east=!0,this.west=!0,this.north=!0,this.south=!0,this.visited=!1,this.pViz=!1,this.has=cont},$scope.dmgType=combatFac.getDmgType,$scope.cell.prototype.dig=function(dir,newCell){switch(console.log("Digging in direction",dir,"from old cell",this,"to new cell",newCell),dir){case"n":this.north=!1,newCell.south=!1;break;case"e":this.east=!1,newCell.west=!1;break;case"s":this.south=!1,newCell.north=!1;break;default:this.west=!1,newCell.east=!1}console.log("After excavation in direction",dir,"from old cell",this,"to new cell",newCell)},$scope.cell.prototype.checkCell=function(dir){var posArr=this.id.split("-"),x=parseInt(posArr[0]),y=parseInt(posArr[1]);switch(dir){case"n":y--;break;case"e":x++;break;case"s":y++;break;default:x--}var newCellName=x+"-"+y,pos=$scope.cellNames.indexOf(newCellName);return-1==pos?"e":$scope.cells[pos].visited?"v":newCellName},$scope.cellNames=[],$scope.makeMaze=function(){$scope.cells=[],$scope.cellNames=[],$scope.path=[],$scope.cellsDone=0,$scope.bombsLeft=5,console.log("Generating maze of dimensions",$scope.width,":",$scope.height);for(var x=0;x<$scope.width;x++)for(var y=0;y<$scope.height;y++){var rItem=$scope.possRoomConts[Math.floor(Math.random()*$scope.possRoomConts.length)];"exit"==rItem&&(console.log("room has exit"),$scope.possRoomConts.splice(5,1)),$scope.cells.push(new $scope.cell(x+"-"+y,rItem)),$scope.cellNames.push(x+"-"+y)}for(console.log("cells:",$scope.cells),$scope.currCell="0-0";$scope.cellsDone<$scope.cellNames.length;){$scope.path.push($scope.currCell);for(var targDir,posDirs=["n","e","s","w"],pos=$scope.cellNames.indexOf($scope.currCell),good=!1;!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=$scope.cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1));if($scope.cells[pos].visited=!0,good||(good=$scope.backTrace()),!good)break;$scope.currCell;$scope.currCell=good;var newPos=$scope.cellNames.indexOf($scope.currCell);$scope.cells[pos].dig(posDirs[targDir],$scope.cells[newPos]),console.log("Cell is now",$scope.currCell),$scope.cellsDone++}$scope.moveReady=!0,$scope.playerCell="0-0",$scope.popCells()},$scope.popCells=function(){$scope.cells.forEach(function(cel){"mons"==cel.has&&$http.get("/getRanMons/"+cel.id).then(function(res){console.log("This room contains an enemy:",res.data.mons),$scope.cells[$scope.cellNames.indexOf(res.data.cell)].has=res.data.mons})})},$scope.compareCell=function(id){return id==$scope.playerCell},$scope.backTrace=function(){for(var good=!1;!good;){if($scope.path.pop(),!$scope.path.length)return!1;$scope.currCell=$scope.path[$scope.path.length-1];for(var targDir,posDirs=["n","e","s","w"],pos=$scope.cellNames.indexOf($scope.currCell);!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=$scope.cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1))}return good},$scope.Inventory=[],$scope.Skills=[],$scope.Bestiary=[],$scope.Quests=[],$scope.currUINum=0,$scope.UIPans=["Inventory","Skills","Bestiary","Quests"],$scope.currUIObjs=[],$scope.currUIBg="../img/UI/inv.jpg",$scope.currUIPan=$scope.UIPans[$scope.currUINum],$scope.chInv=function(dir){console.log(dir,$scope.currUINum),!dir&&$scope.currUINum>0?$scope.currUINum--:dir?1==dir&&$scope.currUINum<$scope.UIPans.length-1?$scope.currUINum++:1==dir&&($scope.currUINum=0):$scope.currUINum=$scope.UIPans.length-1,$scope.currUIPan=$scope.UIPans[$scope.currUINum],console.log(UIFac,UIFac.getUIObj),UIFac.getUIObj($scope.currUIPan,$scope[$scope.currUIPan]).then(function(uiRes){$scope.currUIObjs=uiRes.data,console.log("UI OBJS:",$scope.currUIObjs)}),$scope.currUIBg=UIFac.getUIBg($scope.currUIPan)},$scope.chInv(-1),$scope.bombOn=!1,$scope.roomRot=0,$scope.playerFacing=0,window.onkeydown=function(e){if($scope.moveReady){var currCell=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)],x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],dir="north";dir=$scope.playerFacing<45||$scope.playerFacing>315?"north":$scope.playerFacing>=45&&$scope.playerFacing<135?"west":$scope.playerFacing>=225&&$scope.playerFacing<315?"east":"south";var isMoveKey=!1,canMove=!1;if(87==e.which||38==e.which&&!$scope.moving){if(isMoveKey=!0,canMove=!1,currCell[dir]?$scope.bombOn&&(canMove=!0,$scope.bomb(dir),$scope.bombsLeft--):canMove=!0,canMove)switch(dir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}console.log("Attempting to move",dir)}else if(83==e.which||40==e.which&&!$scope.moving){isMoveKey=!0;var revDir;switch(dir){case"north":revDir="south";break;case"south":revDir="north";break;case"east":revDir="west";break;default:revDir="east"}if(canMove=!1,currCell[revDir]?$scope.bombOn&&(canMove=!0,$scope.bomb(revDir),$scope.bombsLeft--):canMove=!0,canMove)switch(revDir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}}else 68==e.which||39==e.which?(isMoveKey=!0,$scope.roomRot-=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):65==e.which||37==e.which?(isMoveKey=!0,$scope.roomRot+=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):66==e.which&&$scope.bombsLeft&&!$scope.bombOn?$scope.bombOn=!0:66==e.which&&$scope.bombOn?$scope.bombOn=!1:82==e.which?$scope.rotOn=!$scope.rotOn:73==e.which?(console.log("i pressed and damage type 3 is",combatFac.getDmgType(3)),$scope.invActive=!$scope.invActive):192==e.which&&($scope.setActive=!$scope.setActive);isMoveKey&&e.preventDefault(),$scope.playerCell=x+"-"+y,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].pViz=!0,console.log("CURRENT ROOM CONTENTS:",$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has),$scope.intTarg="object"==typeof $scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has?$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has:!1,$scope.$digest(),87!=e.which&&38!=e.which&&83!=e.which&&40!=e.which||!canMove||$scope.moving||$scope.moveAni()}},$scope.moving=!1,$scope.moveAni=function(){$scope.moving=!0,$("body").fadeOut(500,function(){$("body").fadeIn(500,function(){$scope.moving=!1})})},$scope.turnSpeed=0,window.onmousemove=function(e){$scope.$digest();var horiz=(e.x||e.clientX)/$(window).width();if(Math.abs(horiz-.5)>.3){var lOrR=horiz>.5?-1:1,turnVal=(Math.abs(horiz-.5)-.3)/.2;$scope.turnSpeed=6*lOrR*turnVal/1.5}else $scope.turnSpeed=0},$scope.mouseTurnTimer=$interval(function(){$scope.roomRot+=$scope.turnSpeed,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360},50),$scope.bomb=function(dir){var x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],otherDir="";switch(dir){case"north":y--,otherDir="south";break;case"east":x++,otherDir="west";break;case"south":y++,otherDir="north";break;default:x--,otherDir="east"}var bombInCell=x+"-"+y;$scope.cells[$scope.cellNames.indexOf(bombInCell)][otherDir]=!1,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]=!1,$scope.bombOn=!1},$scope.rotOn=!0,$scope.vertRot=85,$scope.getWallStatus=function(dir){var roomWall=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]?"./img/wall.jpg":"./img/door.jpg";return roomWall},$scope.makeMaze(),console.log("UI",document.querySelector("#uiloader")),$("#uiloader").draggable({constrain:"body"}),$scope.inpPhone=function(){$scope.moveReady=!1,bootbox.prompt("Enter a name (you get this by visiting the site on your phone)!",function(result){null!==result&&" "!=result&&socket.emit("chkName",{n:result}),$scope.moveReady=!0})},socket.on("chkNameRes",function(nm){nm.n&&($scope.uName=nm.n),console.log("Name:",nm.n)}),$scope.phoneMovTimer,socket.on("movOut",function(mvOb){mvOb.n==$scope.uName&&(mvOb.x<-50&&($scope.phoneMovTimer=setTimeout(function(){console.log("time (L)",(new Date).getTime());var e=new Event("keydown");e.which=65,window.onkeydown(e)},500)),mvOb.x>50&&($scope.phoneMovTimer=setTimeout(function(){console.log("time (R)",(new Date).getTime());var e=new Event("keydown");e.which=68,window.onkeydown(e)},500)),mvOb.y<-50&&($scope.phoneMovTimer=setTimeout(function(){console.log("time (F)",(new Date).getTime());var e=new Event("keydown");e.which=87,window.onkeydown(e)},500)),mvOb.y>50&&($scope.phoneMovTimer=setTimeout(function(){console.log("time (B)",(new Date).getTime());var e=new Event("keydown");e.which=83,window.onkeydown(e)},500)))})});app.controller("mob-con",function($scope,$http,$q,$interval,$window){$scope.currRotX=0,$scope.currRotY=0,$scope.rotX=0,$scope.rotY=0,$scope.uName="retrieving...",$scope.getUn=function(){var nounStart=String.fromCharCode(65+Math.floor(25*Math.random())),adjStart=String.fromCharCode(65+Math.floor(25*Math.random()));$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+nounStart+"&cmlimit=500&cmtitle=Category:Nouns",success:function(nounRes){for(var noun=" ";-1!=noun.indexOf(" ");)noun=nounRes.query.categorymembers[Math.floor(Math.random()*nounRes.query.categorymembers.length)].title,console.log(noun,noun.indexOf(" "));console.log("final noun:",noun),$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+adjStart+"&cmlimit=500&cmtitle=Category:Adjectives",success:function(adjRes){for(var adj=" ";-1!=adj.indexOf(" ");)adj=adjRes.query.categorymembers[Math.floor(Math.random()*adjRes.query.categorymembers.length)].title,console.log(adj,adj.indexOf(" "));$scope.uName=adj+" "+noun,$scope.$digest()}})}})},$window.onmousemove=function($event){"retrieving..."!=$scope.uName&&($scope.rotX=Math.floor(200*($event.x/$(window).width()-.5)),$scope.rotY=Math.floor(200*($event.y/$(window).height()-.5)),$scope.$digest());var mov={x:$scope.rotX,y:$scope.rotY,n:$scope.uName};socket.emit("movData",mov)},$window.addEventListener("deviceorientation",function($event){"retrieving..."!=$scope.uName&&($scope.rotX=Math.floor($event.gamma/90*120),$scope.rotY=Math.floor($event.beta/90*120),$scope.$digest());var mov={x:$scope.rotX,y:$scope.rotY,n:$scope.uName};socket.emit("movData",mov)}),$scope.getUn()}),app.factory("combatFac",function($http){var dmgTypes=["Physical","Fire","Ice","Poison","Dark","Holy"];return{getDmgType:function(typeNum){return dmgTypes[parseInt(typeNum)]}}}),app.factory("mazeFac",function($http){return{}}),app.factory("socketFac",function($rootScope){var socket=io.connect();return{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}}),app.factory("UIFac",function($http,$q){return{getUIObj:function(whichUI,UIStuff){var p=$http.get("/"+whichUI).success(function(res){return res});return p},getUIBg:function(which){var UIBgs={Inventory:"../img/UI/inv.jpg",Skills:"",Bestiary:"",Quests:""};return UIBgs[which]},sendUserUI:function(which){var p=$http.get("/user/"+whichUI).success(function(res){return res});return p}}});