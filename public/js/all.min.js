"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},app=angular.module("mazeGame",["ngTouch"]).controller("log-con",["$scope","$http","$q","$timeout","$window","userFact",function(e,t,n,o,r,a){e.hazLogd=!1,e.newUsr=function(){if(e.regForm.pwd.$viewValue!=e.regForm.pwdTwo.$viewValue)sandalchest.alert("Your passwords don&rsquo;t match!",function(){});else{var n={user:e.regForm.username.$viewValue,password:e.regForm.pwd.$viewValue};t.post("/user/new",n).then(function(t){"saved!"==t.data&&e.login(!0)})}},e.passMatch=!0,e.passStr=0,e.isNew=!1,e.checkPwdStr=function(){e.regForm.pwd.$viewValue&&(e.passStr=a.checkPwdStr(e.regForm.pwd.$viewValue)),console.log("pwd strength",e.passStr)},e.checkPwds=function(){e.passMatch=a.checkPwdMatch(e.regForm.pwd.$viewValue,e.regForm.pwdTwo.$viewValue)},e.dupName=!1,e.nameCheck=function(){var t=e.regForm.username.$viewValue;console.log("userFact",a.checkName,"name",t),a.checkName(t).then(function(t){e.dupName=t})},e.login=function(t){t?a.login({name:e.regForm.username.$viewValue,pwd:e.regForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):sandalchest.alert("Either your username or password is not correct!")}):a.login({name:e.logForm.username.$viewValue,pwd:e.logForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):sandalchest.alert("Either your username or password is not correct!")})},e.play=function(){r.location.href="./"},e.passInf=function(){sandalchest.alert('<h3>Password Strength</h3><hr/>Here are a few things to include for a stronger password:<ul><li>A lowercase letter</li><li>An uppercase letter</li><li>A number</li><li>A non alpha-numeric symbol (something like "@" or "$")</li></ul>Longer passwords are also generally better!')},e.upd=[],e.getNews=function(){t.get("/other/news").then(function(t){e.upd=t.data.split(/[\n\r]/)})},e.getNews(),e.parseInt=parseInt}]),socket=io();app.controller("maze-con",["$scope","$http","$q","$interval","$timeout","$window","mazeFac","combatFac","UIFac","userFact","econFac",function(e,t,n,o,r,a,l,i,s,c,m){e.width=6,e.height=6,e.path=[],e.backtraceNum,e.currCell,e.bombsLeft=5,e.cellsDone=0,e.moveReady=!1,e.cells=[],e.cellNames=[],e.invActive=!1,e.setActive=!1,e.intTarg,e.lvl=1,e.playerItems=[],e.questList=[],e.doneQuest=[],e.maxHp=0,e.currHp=0,e.maxEn=0,e.currEn=0,e.isStunned=!1,e.inCombat=!1,e.merchy={},e.name="",e.currSkillNum=0,e.uName="",(e.checkPhone=function(){var e=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(e=!0),e?a.location.href="./mobile":c.checkLogin().then(function(e){console.log("RESPONSE FROM CHECK LOGIN:",e),e||(a.location.href="./login")})})(),e.fillCells=function(){console.log("cells:",e.cells);for(var t=[],o=[],r=[],a=[],i=0;i<e.cells.length;i++)"mons"==e.cells[i].has?t.push(l.popCell(e.lvl,e.cells[i].id)):"npcs"==e.cells[i].has&&(console.log(e.cells[i].id,"has an npc."),o.push(m.getNpc(e.cells[i].id)));n.all(t).then(function(t){t.forEach(function(t){e.cells[e.cellNames.indexOf(t.cell)].has=t.mons})}),n.all(o).then(function(t){t.forEach(function(t){console.log("DATA INTO PROMPMERCINVS",t),e.cells[e.cellNames.indexOf(t.id)].has=t.data,t.data.isMerch&&1==t.data.isMerch&&r.push(m.merchInv(t.data.inv,t.id))}),n.all(r).then(function(t){t.forEach(function(t){console.log("INV",t),e.cells[e.cellNames.indexOf(t.id)].has.inv=t.inv,a.push(m.getQuests(e.name,t.id,e.lvl))}),n.all(a).then(function(t){console.log(t),t.forEach(function(t){e.cells[e.cellNames.indexOf(t.id)].has.quest=t.q,console.log("NPC HAS QUEST:",t.q,t.id)})})})})},e.doMaze=function(t,n){var o=l.makeMaze(t,n);e.cells=o.cells,e.path=o.path,e.cellNames=o.names,e.bombsLeft=5,e.moveReady=!0,e.playerCell="0-0",e.fillCells()},e.getUsrData=function(){t.get("/user/currUsrData").then(function(t){console.log("CURR USR DATA","undefined"==typeof t?"undefined":_typeof(t),t),e.playerItems=t.data.equip,e.lvl=t.data.lvl,e.questList=t.data.inProg,e.doneQuest=t.data.questDone,e.maxHp=t.data.maxHp,e.currHp=t.data.currHp,e.maxEn=t.data.maxEn,e.currEn=t.data.currEn,e.isStunned=t.data.isStunned,e.name=t.data.name,m.merchInv(e.playerItems.inv).then(function(n){for(var o=0;o<n.length;o++)console.log("REPLACING",e.playerItems.inv[o].item,"WITH",n[o]),e.playerItems.inv[o].item=n[o];t.data.currentLevel&&t.data.currentLevel.loc&&null!=t.data.currentLevel.loc&&""!=t.data.currentLevel.loc?(e.cells=t.data.currentLevel.data,e.cellNames=t.data.currentLevel.names,e.playerCell=t.data.currentLevel.loc,e.moveReady=!0):(console.log("User does not already have level data saved!"),e.doMaze(e.width,e.height))})})},e.getUsrData(),e.getInvName=function(e){var t="";return e.item?(e.item.name?t=e.item.name:e.item.length&&e.item instanceof Array&&e.item.length>2&&(t=e.item[0].pre+" "+e.item[1].name+" "+e.item[2].post),t):"ERROR!"},e.dmgType=i.getDmgType,e.compareCell=function(t){return t==e.playerCell},e.bodyBoxes=[{name:"head",x:81,y:1,imgUrl:"./img/UI/head.jpg"},{name:"chest",x:80,y:115,imgUrl:"./img/UI/chest.jpg"},{name:"legs",x:82,y:361,imgUrl:"./img/UI/legs.jpg"},{name:"hands",x:1,y:285,imgUrl:"./img/UI/hands.jpg"},{name:"feet",x:79,y:510,imgUrl:"./img/UI/feet.jpg"},{name:"weap",x:158,y:284,imgUrl:"./img/UI/weap.jpg"}],e.Skills=[],e.Bestiary=[],e.Quests=[],e.currUINum=0,e.UIPans=["Inventory","Skills","Bestiary","Quests","Menu"],e.currUIObjs=[],e.currUIBg="../img/UI/inv.jpg",e.currUIPan=e.UIPans[e.currUINum],e.chInv=function(t){!t&&e.currUINum>0?e.currUINum--:t?1==t&&e.currUINum<e.UIPans.length-1?e.currUINum++:1==t&&(e.currUINum=0):e.currUINum=e.UIPans.length-1,e.currUIPan=e.UIPans[e.currUINum],"Menu"!==e.currUIPan&&"Inventory"!==e.currUIPan?s.getUIObj(e.currUIPan,e[e.currUIPan]).then(function(t){e.currUIObjs=t.data,"Bestiary"==e.currUIPan&&e.currUIObjs.forEach(function(e){e.imgUrl="/img"+e.imgUrl}),console.log("UI OBJS:",e.currUIObjs)}):"Inventory"==e.currUIPan&&s.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv}),e.currUIBg=s.getUIBg(e.currUIPan)},e.chInv(1),e.bombOn=!1,e.roomRot=0,e.playerFacing=0,window.onkeydown=function(t){if(e.moveReady&&73!==t.which){var n=e.cells[e.cellNames.indexOf(e.playerCell)],o=e.playerCell.split("-")[0],r=e.playerCell.split("-")[1],a="north";a=e.playerFacing<45||e.playerFacing>315?"north":e.playerFacing>=45&&e.playerFacing<135?"west":e.playerFacing>=225&&e.playerFacing<315?"east":"south";var l=!1,s=!1;if(87==t.which||38==t.which&&!e.moving){if(l=!0,s=!1,n[a]?e.bombOn&&(s=!0,e.bomb(a),e.bombsLeft--):s=!0,s)switch(a){case"north":r--;break;case"south":r++;break;case"east":o++;break;default:o--}console.log("Attempting to move",a)}else if(83==t.which||40==t.which&&!e.moving){l=!0;var c;switch(a){case"north":c="south";break;case"south":c="north";break;case"east":c="west";break;default:c="east"}if(s=!1,n[c]?e.bombOn&&(s=!0,e.bomb(c),e.bombsLeft--):s=!0,s)switch(c){case"north":r--;break;case"south":r++;break;case"east":o++;break;default:o--}}else 68==t.which||39==t.which?(l=!0,e.roomRot-=5,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360):65==t.which||37==t.which?(l=!0,e.roomRot+=5,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360):66==t.which&&e.bombsLeft&&!e.bombOn?e.bombOn=!0:66==t.which&&e.bombOn?e.bombOn=!1:82==t.which?e.rotOn=!e.rotOn:192==t.which&&(e.setActive=!e.setActive);l&&t.preventDefault(),87!=t.which&&38!=t.which&&83!=t.which&&40!=t.which||!s||e.moving||(e.playerCell=o+"-"+r,e.cells[e.cellNames.indexOf(e.playerCell)].pViz=!0,e.intTarg="object"==_typeof(e.cells[e.cellNames.indexOf(e.playerCell)].has)&&!e.cells[e.cellNames.indexOf(e.playerCell)].has.inv&&e.cells[e.cellNames.indexOf(e.playerCell)].has,e.intTarg&&(console.log("cell cons (probly mons):",e.intTarg),e.moveReady=!1,e.inCombat=!0,i.combatReady()),"object"==_typeof(e.cells[e.cellNames.indexOf(e.playerCell)].has)&&e.cells[e.cellNames.indexOf(e.playerCell)].has.inv?(e.currNpc=e.cells[e.cellNames.indexOf(e.playerCell)].has,e.merchy.prepNpc(),e.isNearMerch=e.cells[e.cellNames.indexOf(e.playerCell)].has.inv):e.currNpc=null,e.$digest(),e.moveAni())}else 73==t.which&&(console.log("key i was pressed"),e.invActive=!e.invActive,e.invActive?e.moveReady=!1:e.moveReady=!0,e.$digest())},e.moving=!1,e.moveAni=function(t){e.moving=!0,$("body").fadeOut(500,function(){$("body").fadeIn(500,function(){if(e.moving=!1,t&&0!==t){e.lvl++;var n={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:"",data:[],names:[]}};console.log("new lvl!:",e.lvl),s.saveGame(n,!1,!0)}})})},e.turnSpeed=0,window.onmousemove=function(t){e.$digest();var n=(t.x||t.clientX)/$(window).width();if(Math.abs(n-.5)>.3){var o=n>.5?-1:1,r=(Math.abs(n-.5)-.3)/.2;e.turnSpeed=6*o*r/1.5}else e.turnSpeed=0},e.mouseTurnTimer=o(function(){e.roomRot+=e.turnSpeed,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360},50),e.bomb=function(t){var n=e.playerCell.split("-")[0],o=e.playerCell.split("-")[1],r="";switch(t){case"north":o--,r="south";break;case"east":n++,r="west";break;case"south":o++,r="north";break;default:n--,r="east"}var a=n+"-"+o;e.cells[e.cellNames.indexOf(a)][r]=!1,e.cells[e.cellNames.indexOf(e.playerCell)][t]=!1,e.bombOn=!1},e.rotOn=!0,e.vertRot=85,e.getWallStatus=function(t){try{var n=e.cells[e.cellNames.indexOf(e.playerCell)][t]?"./img/wall.jpg":"./img/door.jpg"}catch(o){}return n},e.isExit=function(){try{var t="exit"==e.cells[e.cellNames.indexOf(e.playerCell)].has?"./img/exit.png":"./img/ground.jpg"}catch(n){}return t},e.noMove=function(e){e.stopPropagation()},e.floorCursor=function(){return"exit"==e.cells[e.cellNames.indexOf(e.playerCell)].has?"pointer":"auto"},$("#uiloader").draggable({constrain:"body"}),e.inpPhone=function(){e.moveReady=!1,sandalchest.prompt("Enter a name (you get this by visiting the site on your phone)!",function(t){null!==t&&" "!=t&&socket.emit("chkName",{n:t}),e.moveReady=!0})},socket.on("chkNameRes",function(t){t.n&&(e.uName=t.n),console.log("Name:",t.n)}),e.travelOkay=!0,e.phoneMovTimer,socket.on("movOut",function(t){if(t.n==e.uName){var n=null,o=null;"l"==t.x?(n=new Event("keydown"),n.which=65,window.onkeydown(n)):"r"==t.x&&(n=new Event("keydown"),n.which=68,window.onkeydown(n)),"f"==t.y&&e.travelOkay?(o=new Event("keydown"),o.which=87,window.onkeydown(o),e.travelOkay=!1,e.phoneMovTimer=r(function(){e.travelOkay=!0},1e3)):"b"==t.y&&e.travelOkay&&(o=new Event("keydown"),o.which=83,window.onkeydown(o),e.travelOkay=!1,e.phoneMovTimer=r(function(){e.travelOkay=!0},1e3))}}),e.getUIInfo=function(e){var t;console.log("getUIInfo:",e),t=e.item&&e.item.length&&e.item.length>2?e.item[0].pre+" "+e.item[1].name+" "+e.item[2].post:e.name&&e.desc?e.name:e.item[0].name;var n;n=e.item&&e.item.length&&e.item.length>2?e.item[1].desc+"<br/>"+e.item[0].description+"<br/>"+e.item[2].description:e.name&&e.desc?e.desc:e.item[0].desc,sandalchest.dialog("<h3>"+t+"</h3>","<p>"+n+'</p><p id="moreInf" style="display:none;"></p>',{buttons:[{text:"Close",close:!0},{text:"More Info",close:!1,click:function(){return"none"==$("#moreInf").css("display")?s.moreInfo(e):s.lessInf(),!1}}]})},e.levelDown=function(){sandalchest.confirm("Ready to go to the next level?",function(t){t&&null!==t&&e.moveAni(1)})},e.saveGame=function(t){var n={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}};console.log("save data to ui fac:",n),s.saveGame(n,!1,t)},e.saveAndLogout=function(){var t={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}};s.saveGame(t,!0,!1)},e.logout=s.logout,e.reset=s.reset,e.trunc=function(e){return Math.floor(10*e)/10},e.isNearMerch=!1,e.equipItem=function(t,n){if(2==t.lootType)return void alert("JUNK REWARD");console.log("EL",t);var o=t.item&&t.item[1]&&"undefined"!=typeof t.item[1].slot?t.item[1].slot:-1;if(t.item&&t.item.length>2&&o!=-1);else{if(!(t.item&&t.item.length>2))return;o=5}var r=angular.copy(e.bodyBoxes[o]),a={lootType:"weap"==r.name?1:0,item:angular.copy(r.itFullInfo),num:1};e.bodyBoxes[o].itFullInfo=t.item,e.bodyBoxes[o].itName=e.bodyBoxes[o].itFullInfo[0].pre+" "+e.bodyBoxes[o].itFullInfo[1].name+" "+e.bodyBoxes[o].itFullInfo[2].post,console.log("LOCATOR",o,"NAME:",e.bodyBoxes[o].name,"FROM",e.bodyBoxes[o],"TO",e.playerItems[e.bodyBoxes[o].name],"OLD ITEM:",r);for(var l=0;l<e.playerItems[e.bodyBoxes[o].name].length;l++)e.playerItems[e.bodyBoxes[o].name][l]=e.bodyBoxes[o].itFullInfo[l].num;e.playerItems.inv.splice(n,1);"undefined"!=typeof a.item&&e.playerItems.inv.push(a),s.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv})},e.contMenOn=!1,window.oncontextmenu=function(t){"Inventory"==e.currUIPan&&"currUIEl ng-binding ng-scope"==t.target.className&&(t.preventDefault(),t.stopPropagation(),e.contMenOn=s.getContMen(angular.element(t.target).scope(),t.x,t.y),e.$apply())},window.onclick=function(t){console.log(t.target,t.target.id,"contexMen"==t.target.id),t.button&&0!==t.button||"contexMen"==t.target.id||(e.contMenOn=!1)},e.trashItem=function(t,n){sandalchest.confirm("Are you sure you wish to destroy this "+(t.item.length>1?t.item[0].pre+" "+t.item[1].name+" "+t.item[2].post:t.item[0].name)+"?",function(o){console.log("RES",o,t.name),o&&null!==o&&(e.playerItems.inv.splice(n,1),s.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv}))})}}]),app.controller("mob-con",["$scope","$http","$q","$interval","$swipe","$window","UIFac",function(e,t,n,o,r,a,l){e.currRotX=0,e.currRotY=0,e.rotX=null,e.rotY=null,e.uName="retrieving...",e.uiOpts=["Inventory","Skills","Bestiary","Quests","Menu"],e.prevUI="Quests",e.currUI="Menu",e.nextUI="Inventory",e.uiObjs=[],e.getUn=function(){var t=String.fromCharCode(65+Math.floor(25*Math.random())),n=String.fromCharCode(65+Math.floor(25*Math.random()));$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+t+"&cmlimit=500&cmtitle=Category:Nouns",success:function(t){for(var o=" ";o.indexOf(" ")!=-1;)o=t.query.categorymembers[Math.floor(Math.random()*t.query.categorymembers.length)].title;console.log("final noun:",o),$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+n+"&cmlimit=500&cmtitle=Category:Adjectives",success:function(t){for(var n=" ";n.indexOf(" ")!=-1;)n=t.query.categorymembers[Math.floor(Math.random()*t.query.categorymembers.length)].title;e.uName=n.toLowerCase()+" "+o.toLowerCase(),e.movObj.n=e.uName,socket.emit("movData",e.movObj),e.$digest()}})}})},e.getUn(),e.sendMove=o(function(){"retrieving..."!=e.uName&&e.isMoving&&socket.emit("movData",e.movObj)},75),e.isMoving=!1,e.movObj={x:e.rotX,y:e.rotY,n:null},a.addEventListener("deviceorientation",function(t){if("retrieving..."!=e.uName){var n=Math.floor(t.gamma/90*120),o=Math.floor(t.beta/90*120);e.isMoving=!1,n>50?(e.rotX="r",e.isMoving=!0):n<-50?(e.rotX="l",e.isMoving=!0):e.rotX=null,o<-35?(e.rotY="f",e.isMoving=!0):o>35?(e.rotY="b",e.isMoving=!0):e.rotY=null,e.movObj={x:e.rotX,y:e.rotY,n:e.uName}}}),e.ringSize=275,e.currRingRot=0,e.rngChTimer,e.rngChOkay=!0,e.ringChAni=function(t,n){if(!e.rngChOkay)return!1;if([].slice.call($(".RingUIEl")).length)$(".RingUIEl").animate({transform:"rotateY(0deg) translateZ("+e.ringSize+"px);"},{duration:500,complete:function(){e.currUI=e.uiOpts[t],console.log("switched from",e.uiOpts[n],"to",e.uiOpts[t]),t<n?(e.nextUI=e.uiOpts[n],n?e.prevUI=e.uiOpts[n-1]:e.prevUI=e.uiOpts[e.uiOpts.length-1]):(e.prevUI=e.uiOpts[n],t<e.uiOpts.length-2?e.nextUI=e.uiOpts[t+1]:e.nextUI=e.uiOpts[0]),console.log("NEW UI OBJECTS:",l.getRingObjs(t)),console.log("num ui objs"),e.currRingRot=0;var o=l.getRingObjs(t);console.log("DATA",o),e.uiObjs=o.objs,e.rotPer=o.rot}});else{e.currUI=e.uiOpts[t],console.log("switched from",e.uiOpts[n],"to",e.uiOpts[t]),t<n?(e.nextUI=e.uiOpts[n],n?e.prevUI=e.uiOpts[n-1]:e.prevUI=e.uiOpts[e.uiOpts.length-1]):(e.prevUI=e.uiOpts[n],t<e.uiOpts.length-2?e.nextUI=e.uiOpts[t+1]:e.nextUI=e.uiOpts[0]),console.log("NEW UI OBJECTS:",l.getRingObjs(t)),console.log("num ui objs"),e.currRingRot=0;var o=l.getRingObjs(t);console.log("DATA",o),e.uiObjs=o.objs,e.rotPer=o.rot}e.rngChOkay=!1,e.rngChTimer=setTimeout(function(){e.rngChOkay=!0},1e3)},e.uiObjs=l.getRingObjs(0),e.chMenRng=function(t){var n=e.uiOpts.indexOf(e.currUI),o=n;t&&0!==t?n<e.uiOpts.length-1?n++:n=0:n&&0!==n?n--:n=e.uiOpts.length-1,console.log("changing menu ring:",t,n,o),e.ringChAni(n,o)},e.oldX,e.oldY,e.noScroll=function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1},e.parseTouch=function(t){if(e.noScroll(t),!e.oldX||!e.oldY)return e.oldX=t.x,e.oldY=t.y,!1;var n=t.x-e.oldX,o=t.y-e.oldY;if(e.oldX=t.x,e.oldY=t.y,Math.abs(n)>Math.abs(o))e.currRingRot=l.PlatinumSpinningRings(e.currRingRot,n);else{if(!(Math.abs(o)>10))return!1;e.chMenRng(o>0?0:1)}},e.chMenRng(1),e.chMenRng(1),r.bind($("body#mob"),{move:e.parseTouch})}]),app.factory("combatFac",["$http",function(e){var t=["Physical","Fire","Ice","Poison","Dark","Holy"];return{getDmgType:function(e){return t[parseInt(e)]},combatReady:function(){$("#combat-box #enemy .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .energy-bar .stat-bar-stat").css("width","100%")},getSkillInf:function(e,t){sandalchest.dialog(e[t].name,e[t].desc,{buttons:[{text:"Okay",close:!0}]})},updateBars:function(e,t,n,o,r,a){e=parseInt(e),t=parseInt(t),n=parseInt(n),o=parseInt(o),r=parseInt(r),a=parseInt(a);var l=parseInt(100*t/e),i=parseInt(100*o/n),s=parseInt(100*a/r);console.log(s,l,i),$("#combat-box #enemy .health-bar .stat-bar-stat").css("width",s+"%"),$("#combat-box #player .health-bar .stat-bar-stat").css("width",l+"%"),$("#combat-box #player .energy-bar .stat-bar-stat").css("width",i+"%")},getItems:function(){return e.get("/item/allItems").then(function(e){return e})},rollLoot:function(t){return e.get("/item/byLvl/"+t.lvl).then(function(e){return e.data})}}}]),app.controller("comb-con",["$scope","$http","$q","$timeout","$window","combatFac",function(e,t,o,r,a,l){e.comb={},e.comb.skills,e.comb.playersTurn=!1,e.comb.itemStats,e.comb.attackEffects=[],e.inCombat=!0,e.comb.lastDefeated=null,e.comb.prepComb=function(){e.comb.lastDefeated=e.intTarg.name,e.comb.battleStatus={status:!1,title:"NONE",txt:"NONE",btn:"YOU SHOULD NOT BE HERE"},e.intTarg.currHp=e.intTarg.hp,$(".pre-battle").hide(250),l.getItems().then(function(t){e.comb.itemStats=t.data,e.currPRegens=[],e.currPDegens=[],e.currMRegens=[],e.currMDegens=[],e.comb.monsTurn()})},e.comb.skillCh=function(t){t?e.currSkillNum<e.comb.skills.length-1?e.currSkillNum++:e.currSkillNum=0:e.currSkillNum>0?e.currSkillNum--:e.currSkillNum=e.comb.skills.length-1},e.comb.getAllSkills=function(){t.get("/item/Skills").then(function(t){console.log("ALL SKILLS",t.data),e.comb.skills=t.data})},e.currPRegens=[],e.currPDegens=[],e.currMRegens=[],e.currMDegens=[],e.monsStunned=!1,e.comb.fleeMult=1,e.pStunned=!1,e.comb.getAllSkills(),e.comb.showSkillInf=function(){l.getSkillInf(e.comb.skills,e.currSkillNum)},e.comb.attemptFlee=function(){e.comb.fleeMult=1,e.$parent.intTarg.lvl/e.lvl>3?e.comb.fleeMult=4:e.$parent.intTarg.lvl/e.lvl<.2?e.comb.fleeMult=1.2:e.comb.fleeMult=1+e.$parent.intTarg.lvl/e.lvl,Math.random()>.7?(e.comb.fleeMult=1,e.comb.flee()):sandalchest.alert("You attempt to flee the "+e.intTarg.name+", but fail! It attacks!",function(t){e.comb.playersTurn=!1,e.comb.monsTurn()})},e.comb.wait=function(){e.comb.updateDoTs(),e.currHp<=0?e.comb.dieP():(e.comb.playersTurn=!1,e.comb.monsTurn())},e.comb.attack=function(){e.comb.attackEffects=[];var t=parseInt(e.comb.calcDmg(1));e.intTarg.currHp-=t,l.updateBars(e.maxHp,e.currHp,e.maxEn,e.currEn,e.$parent.intTarg.hp,e.$parent.intTarg.currHp),e.comb.updateDoTs();var n="You attack for "+t+" "+l.getDmgType(e.comb.skills[e.currSkillNum].type)+" damage, using "+e.comb.skills[e.currSkillNum].name+"!";if(e.comb.attackEffects.length){var o="nova"==e.comb.attackEffects;o&&e.comb.attackEffects.shift();for(var r=" Your attack is a ",a=0;a<e.comb.attackEffects.length-1;a++)r+=e.comb.attackEffects[a]+", ";r+=e.comb.attackEffects.length>1?"and "+e.comb.attackEffects[e.comb.attackEffects.length-1]+" one.":e.comb.attackEffects[e.comb.attackEffects.length-1]+" one.",n+=r}sandalchest.alert(n,function(t){e.intTarg.currHp<=0?e.comb.dieM():(e.comb.playersTurn=!1,e.comb.monsTurn())})},e.comb.DoT=function(e,t,n){this.dur="undefined"!=typeof n?n:5,this.name=e,this.amt=t},e.comb.checkDoTDup=function(e,t){for(var n=0;n<e.length;n++)if(e[n].name==t)return!1;return!0},e.resetDoTDur=function(t,n,o){for(var r=0;r<e[t].length;r++)if(e[t][r].name==n){e[t][r].dur="undefined"!=typeof o?o:5;break}},e.comb.calcDmg=function(t){var n=e.comb.itemStats[1],o=e.comb.itemStats[0],r=e.comb.itemStats[2],a=e.comb.itemStats[3];console.log("WEAP IDS",e.$parent.playerItems.weap,"WEAPS",n,"ARMOR",o,"AFFIXES",r,"JUNK",a);var i=e.$parent.playerItems.weap[1]!=-1&&[r[e.$parent.playerItems.weap[0]],n[e.$parent.playerItems.weap[1]],r[e.$parent.playerItems.weap[2]]];console.log(i[0].pre+" "+i[1].name+" "+i[2].post,i);var s,c,m,u=0,p=0,g=!1;if(m=e.$parent.intTarg.lvl/e.lvl>2?2:e.$parent.intTarg.lvl/e.lvl<.5?.5:e.$parent.intTarg.lvl/e.lvl,t){if(!e.pStunned&&e.comb.skills[e.currSkillNum].energy<=e.currEn){s=e.comb.skills[e.currSkillNum].type,i[0].dmgType!=-1&&(s=i[0].dmgType),i[2].dmgType!=-1&&(s=i[2].dmgType);var h=i?Math.floor(Math.random()*(i[1].max-i[1].min))+i[1].min:0;(Math.random()<i[0].brut||Math.random()<i[2].brut)&&(h*=1.7,e.comb.attackEffects.push("brutal"));var d=e.comb.skills[e.currSkillNum].burst;if(console.log("ATTACKED USING A SKILL"),console.log("SKILL WAS:",e.comb.skills[e.currSkillNum]),e.comb.skills[e.currSkillNum].degen){var f=Math.random()<i[0].crue||Math.random()<i[2].crue?10:5;f>5&&e.comb.attackEffects.push("cruel"),e.comb.checkDoTDup(e.currMDegens,e.$parent.intTarg.name+"-"+e.comb.skills[e.currSkillNum].name+"-degen")?e.currMDegens.push(new e.comb.DoT(e.$parent.intTarg.name+"-"+e.comb.skills[e.currSkillNum].name+"-degen",e.comb.skills[e.currSkillNum].degen,f)):e.resetDoTDur("currMDegens",e.$parent.intTarg.name+"-"+e.comb.skills[e.currSkillNum].name+"-degen",f)}if(e.comb.skills[e.currSkillNum].regen){var b=Math.random()<i[0].rejuv||Math.random()<i[2].rejuv?10:5;b>5&&e.comb.attackEffects.push("rejuvenating"),e.comb.checkDoTDup(e.currPRegens,"player-"+e.comb.skills[e.currSkillNum].name+"-regen")?e.currPRegens.push(new e.comb.DoT("player-"+e.comb.skills[e.currSkillNum].name+"-regen",e.comb.skills[e.currSkillNum].regen,b)):e.resetDoTDur("currPRegens","player-"+e.comb.skills[e.currSkillNum].name+"-regen",b)}if(e.comb.skills[e.currSkillNum].heal){var y=Math.random()<i[0].bene||Math.random()<i[2].bene?2:1;b>5&&e.comb.attackEffects.push("benedictive"),e.currHp+=e.comb.skills[e.currSkillNum].heal*y,e.currHp>e.maxHp&&(e.currHp=e.maxHp)}(e.comb.skills[e.currSkillNum].stuns||Math.random()<i[0].stunCh||Math.random()<i[2].stunCh)&&(e.monsStunned=!0,e.comb.attackEffects.push("stunning"));var v=Math.random()<i[0].novaChance||Math.random()<i[2].novaChance?.5*h:0;if(v&&e.comb.attackEffects.unshift("nova"),e.intTarg.res.indexOf(i[0].novaType)==-1&&e.intTarg.res.indexOf(i[1].novaType)==-1||(v=Math.floor(v/3)),(Math.random()<i[0].conf||Math.random()<i[2].conf)&&(e.monsConf=!0,e.comb.attackEffects.push("confusing")),i[0].vamp>0||i[2].vamp>0){e.comb.attackEffects.push("life-stealing");var k=.1*Math.random()+.05;e.currHp+=(h+d)*k,e.currHp>e.maxHp&&(e.currHp=e.maxHp)}return e.currEn-=e.comb.skills[e.currSkillNum].energy,d+h+v}e.comb.skills[e.currSkillNum].energy>e.currEn?sandalChest.alert("You don't have enough energy to use "+e.comb.skills[e.currSkillNum].name+"."):sandalChest.alert("You've been stunned! You can't attack this turn.")}else if(e.monsStunned)e.monsStunned=!1;else{s=e.$parent.intTarg.type,u=m*(Math.ceil(Math.random()*(e.$parent.intTarg.max-e.$parent.intTarg.min))+e.$parent.intTarg.min);var w={head:{freq:1},chest:{freq:5},hands:{freq:3},legs:{freq:2},feet:{freq:1}},I=e.comb.freqGen(w),x=I[Math.floor(Math.random()*I.length)],T=0;e.playerItems[x]&&e.playerItems[x][1]&&e.playerItems[x][1]>-1&&(T=o[e.playerItems[x][1]].def);var M=0;if(i[1].def&&(M+=i[1].def),console.log("Now running inv item defense",e.playerItems.inv),e.playerItems.inv&&e.playerItems.inv.length){console.log("----Checking defense items:----");for(var O=0;O<e.playerItems.inv.length;O++)0==e.playerItems.inv[O].lootType&&(console.log("CHECKING DEFENSE ON ITEM:",e.playerItems.inv[O]),M+=e.playerItems.inv[O].item[1].def||0),e.playerItems.inv[O].item&&e.playerItems.inv[O].item[1]&&e.playerItems.inv[O].item[1].res&&e.playerItems.inv[O].item[1].res.indexOf(s)!=-1&&(g=!0)}p=T+M}return c=u/(3*Math.log10(p+1)||1),g?c/=3:(1!=i[0].defChanges[l.getDmgType(s)]&&1!=i[2].defChanges[l.getDmgType(s)]||(c/=3),i[0].defChanges[l.getDmgType(s)]!=-1&&i[2].defChanges[l.getDmgType(s)]!=-1||(c=1.5*c)),e.comb.fleeMult*c},e.comb.freqGen=function(e){for(var t=Object.keys(e),n=[],o=0;o<t.length;o++)for(var r=0;r<e[t[o]].freq;r++)n+=t[o];return n},e.comb.acceptStatus=function(){var t="Victory!"==e.comb.battleStatus.title;$(".pre-battle").show(10),e.comb.battleStatus={status:!1,title:" ",txt:" ",url:"./img/paper.jpg"},t?(l.rollLoot(e.intTarg).then(function(t){console.log("FROM ROLL LOOT",t);var n="",o={};"junk"==t.type?(n=t.loot.name,o.lootType=2,o.num=t.num,o.item=t.loot,e.playerItems.inv.push(o)):(o.lootType=t.type,o.num=t.num,o.item=[t.loot.pre,t.loot.base,t.loot.post],n=t.loot.pre.pre+" "+t.loot.base.name+" "+t.loot.post.post,e.playerItems.inv.push(o)),sandalchest.alert("After killing the "+e.comb.lastDefeated+", you recieve "+n+"!")}),angular.element("body").scope().cells[angular.element("body").scope().cellNames.indexOf(angular.element("body").scope().playerCell)].has=""):(angular.element("body").scope().playerCell="0-0",angular.element("body").scope().intTarg.currHp=angular.element("body").scope().hp,e.$parent.intTarg.currHp=e.$parent.intTarg.hp),e.inCombat=!1,angular.element("body").scope().inCombat=!1,angular.element("body").scope().intTarg=!1,angular.element("body").scope().moveReady=!0,angular.element("body").scope().currHp=angular.element("body").scope().maxHp,angular.element("body").scope().currEn=angular.element("body").scope().maxEn,e.currHp=e.maxHp,e.currEn=e.maxEn,l.updateBars(e.maxHp,e.currHp,e.maxEn,e.currEn,e.$parent.intTarg.hp,e.$parent.intTarg.currHp),angular.element("body").scope().$apply()},e.comb.battleEndMsgs={win:["Onward!","To victory!","Forward"],lose:["Retry!","I'll be back!","Another time then..."],flee:["I'm not a coward!","I'll be back...","Another time then...","A close one!"]},e.comb.dieP=function(){e.comb.battleStatus={status:!0,title:"Defeat!",txt:"You've been defeated!",url:"./img/assets/Defeat.jpg",btn:e.comb.battleEndMsgs.lose[Math.floor(Math.random()*e.comb.battleEndMsgs.lose.length)]}},e.comb.dieM=function(){e.comb.battleStatus={status:!0,title:"Victory!",txt:"You are victorious! The "+e.intTarg.name+" lies defeated at your feet.",url:"./img/assets/Victory.jpg",btn:e.comb.battleEndMsgs.win[Math.floor(Math.random()*e.comb.battleEndMsgs.win.length)]}},e.comb.flee=function(){console.log("flee worked!"),e.comb.battleStatus={status:!0,title:"Flee!",txt:"You've successfully fled the "+e.intTarg.name+".",url:"./img/assets/flee.jpg",btn:e.comb.battleEndMsgs.flee[Math.floor(Math.random()*e.comb.battleEndMsgs.flee.length)]}},e.comb.updateDoTs=function(){for(n=0;n<e.currPRegens;n++)e.currHp+=e.currPRegens[n].amt,e.currPRegens[n].dur--,e.currPRegens[n].dur||e.currPRegens.splice(n,1);for(e.currHp>e.maxHp&&(e.currHp=e.maxHp),n=0;n<e.currPDegens;n++)e.currHp-=e.currPDegens[n].amt,e.currPDegens[n].dur--,e.currPDegens[n].dur||e.currPDegens.splice(n,1);for(n=0;n<e.currMRegens;n++)e.intTarg.currHp+=e.currMRegens[n].amt,e.currMRegens[n].dur--,e.currMRegens[n].dur||e.currMRegens.splice(n,1);for(e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.intTarg.hp),n=0;n<e.currMDegens;n++)e.intTarg.currHp+=e.currMDegens[n].amt,e.currMDegens[n].dur--,e.currMDegens[n].dur||e.currMDegens.splice(n,1)},e.comb.monsTurn=function(){if(console.log("monster taking turn!"),e.monsStunned)sandalchest.alert(e.$parent.intTarg.name+" is stunned this turn!",function(){e.comb.playersTurn=!0,e.comb.fleeMult=1});else{var t=parseInt(e.comb.calcDmg()),n=Math.random()<.5&&e.monsConf;n?(e.monsConf=!1,e.intTarg.currHp-=t,l.updateBars(e.maxHp,e.currHp,e.maxEn,e.currEn,e.$parent.intTarg.hp,e.$parent.intTarg.currHp),sandalchest.alert(e.$parent.intTarg.name+" is confused, and attacks itself for "+t+" "+l.getDmgType(e.$parent.intTarg.type)+"!",function(){e.comb.updateDoTs(),e.intTarg.currHp<=0?e.comb.dieM():(e.comb.playersTurn=!0,e.comb.fleeMult=1,e.currEn+=2,e.currEn>e.maxEn&&(e.currEn=e.maxEn))})):e.intTarg.currHp/e.intTarg.hp>.5&&Math.random<e.intTarg.healCh?sandalchest.alert("The "+e.intTarg.name+" heals!",function(){var t=e.intTarg.hp*(.07+Math.random()/10);e.intTarg.currHp+=t,e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.currHp),e.comb.playersTurn=!0,e.comb.fleeMult=1}):e.intTarg.currHp/e.intTarg.hp>.5&&-3.6*(e.intTarg.currHp/e.intTarg.hp)+3>Math.random()?sandalchest.alert("The "+e.intTarg.name+" heals!",function(){var t=e.intTarg.hp*(.07+Math.random()/10);e.intTarg.currHp+=t,e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.currHp),e.comb.playersTurn=!0,e.comb.fleeMult=1}):(Math.random()<e.$parent.intTarg.stunCh&&(e.pStunned=!0),
e.currHp-=t,l.updateBars(e.maxHp,e.currHp,e.maxEn,e.currEn,e.$parent.intTarg.hp,e.$parent.intTarg.currHp),sandalchest.alert(e.$parent.intTarg.name+" attacks for "+t+" "+l.getDmgType(e.$parent.intTarg.type)+"!",function(){e.comb.updateDoTs(),console.log("triggered cb for mons attack"),e.currHp<=0?e.comb.dieP():(e.comb.playersTurn=!0,e.comb.fleeMult=1,e.currEn+=2,e.currEn>e.maxEn&&(e.currEn=e.maxEn))}))}}}]),app.factory("econFac",["$http","$q",function(e,t){return{merchInv:function(t,n){return e.get("/item/allItems/").then(function(e){return console.log("GETTING ITEM DATA:invArr",t,e),t.forEach(function(t){if(0!=t.lootType&&(1!=t.lootType||3!=t.item.length))throw new Error("FOUND JUNK "+JSON.stringify(t)+" in inventory of merch!");for(var n=0;n<e.data[2].length;n++)t.item[0]==e.data[2][n].num&&(t.item[0]=angular.copy(e.data[2][n])),t.item[2]==e.data[2][n].num&&(t.item[2]=angular.copy(e.data[2][n]));if(0==t.lootType)for(var n=0;n<e.data[0].length;n++)t.item[1]==e.data[0][n].num&&(t.item[1]=angular.copy(e.data[0][n]));else for(var n=0;n<e.data[1].length;n++)t.item[1]==e.data[1][n].num&&(t.item[1]=angular.copy(e.data[1][n]))}),console.log("POPULATED MERCH INV",t),{inv:t,id:n}})},getNpc:function(t){return e.get("/other/oneNpc/"+t).then(function(e){return{data:e.data.data,id:e.data.i}})},getQuests:function(t,n,o){var r=n.split("-");return e.get("/quest/npcQ/"+r[0]+"/"+r[1]+"/"+o+"/"+t).then(function(e){return e.data})}}}]),app.factory("mazeFac",["$http",function(e){var t=function(e,t){this.id=e,this.x=e.split("-")[0],this.y=e.split("-")[1],this.east=!0,this.west=!0,this.north=!0,this.south=!0,this.visited=!1,this.pViz=!1,this.has=t},n=[],o=0,r=[],a="",l=[],i=["loot","mons","npcs","jewl"," ","exit"," "," ","mons","mons"],s=function(){for(var e=!1;!e;){if(l.pop(),!l.length)return!1;a=l[l.length-1];for(var t,o=["n","e","s","w"],i=n.indexOf(a);!e&&o.length;)t=Math.floor(Math.random()*o.length),e=r[i].checkCell(o[t]),"e"!=e&&"v"!=e||(e=!1,o.splice(t,1))}return e};return t.prototype.dig=function(e,t){switch(e){case"n":this.north=!1,t.south=!1;break;case"e":this.east=!1,t.west=!1;break;case"s":this.south=!1,t.north=!1;break;default:this.west=!1,t.east=!1}},t.prototype.checkCell=function(e){var t=this.id.split("-"),o=parseInt(t[0]),a=parseInt(t[1]);switch(e){case"n":a--;break;case"e":o++;break;case"s":a++;break;default:o--}var l=o+"-"+a,i=n.indexOf(l);return i==-1?"e":r[i].visited?"v":l},{popCell:function(t,n){return e.get("/item/beastie/"+t+"/"+n).then(function(e){return e.data})},makeMaze:function(e,c){r=[],n=[],l=[],o=0,didEx=!1;for(var m=0;m<e;m++)for(var u=0;u<c;u++){for(var p=i[Math.floor(Math.random()*i.length)];(0===m||0===u)&&"exit"==p;)p=i[Math.floor(Math.random()*i.length)];"exit"==p&&(didEx=!0,i.splice(5,1)),r.push(new t(m+"-"+u,p)),n.push(m+"-"+u)}for(didEx||(r[Math.floor(Math.random()*r.length)].has="exit"),a="0-0";o<n.length;){l.push(a);for(var g,h=["n","e","s","w"],d=n.indexOf(a),f=!1;!f&&h.length;)g=Math.floor(Math.random()*h.length),f=r[d].checkCell(h[g]),"e"!=f&&"v"!=f||(f=!1,h.splice(g,1));if(r[d].visited=!0,f||(f=s()),!f)break;a=f;var b=n.indexOf(a);r[d].dig(h[g],r[b]),o++}return{cells:r,names:n,path:l}}}}]),app.controller("merch-cont",["$scope","$http","$q","$timeout","$window","econFac","UIFac",function(e,t,n,o,r,a,l){console.log("THING RUNNING"),e.merchy.prepNpc=function(){e.merchy.buy=!0,e.merchy.merch=e.currNpc,e.merchy.merch.sez=e.merchy.merch.gossip[Math.floor(Math.random()*e.merchy.merch.gossip.length)]},e.merchy.itemForPlayer=null,e.acceptQuest=function(){console.log(e.$parent.name,e.merchy.merch.quest.name)},e.merchy.exchange=function(t,n,o){e.moveReady=!1,angular.element("body").scope().moveReady=!1,console.log(t);var r=t.item[0].pre+" "+t.item[1].name+"s "+t.item[2].post,a=Math.floor(t.item[1].cost*(10+t.item[0].cost+t.item[2].cost))/10;console.log("ITEM DATA TO EXCHANGE",t,"and dir:",n),sandalchest.dialog((n?"Sell":"Buy")+" Items","How many "+r+" do you want to "+(n?"sell":"buy")+"?<hr/><input type=number value=1 min=1 max="+t.num+" id='numExch'>",{buttons:[{text:(n?"Sell":"Buy")+" Items",close:!0,click:function(){var i=parseInt($("#numExch").val());if(n&&"false"!=n)i<t.num?e.playerItems.inv[o].num-=i:e.playerItems.inv.splice(o,1),e.playerItems.gold+=a*i*.9;else if(i*a<e.playerItems.gold){i<t.num?e.merchy.merch.inv[o].num-=i:e.merchy.merch.inv.splice(o,1);for(var s=-1,c=0;c<e.playerItems.inv.length;c++){var m=e.playerItems.inv[c].item[0].pre+" "+e.playerItems.inv[c].item[1].name+"s "+e.playerItems.inv[c].item[2].post;r==m&&(s=c)}if(s!=-1)e.playerItems.inv[s].num+=i;else{e.merchy.itemForPlayer=angular.copy(t),console.log("ITEM FOR PLAYER",e.merchy.itemForPlayer),e.merchy.itemForPlayer.num=i,e.playerItems.inv.push(e.merchy.itemForPlayer)}e.playerItems.gold-=a*i}else sandalchest.alert("You don't have enough money to afford "+i+" "+r+"s!");l.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv}),angular.element("body").scope().moveReady=!0,e.moveReady=!0}},{text:"Cancel",close:!0,click:function(){angular.element("body").scope().moveReady=!0,e.moveReady=!0}}]})}}]),app.factory("socketFac",["$rootScope",function(e){var t=io.connect();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,r){t.emit(n,o,function(){var n=arguments;e.$apply(function(){r&&r.apply(t,n)})})}}}]),app.factory("UIFac",["$http","$q","$location","$window","combatFac",function(e,t,n,o,r){return{getUIObj:function(t,n){var o=e.get("/item/"+t).success(function(e){return e});return o},getUIBg:function(e){var t={Inventory:"../img/UI/inv.jpg",Skills:"",Bestiary:"",Quests:""};return t[e]},moreInfo:function(t){var n=["Physical","Fire","Ice","Poison","Dark","Holy"],o='<ul class="moreInfList">';if(console.log(t,!!t.item,t.item),t.item&&(t.item[1].slot||0==t.item[1].slot)){var a;switch(t.item[1].slot){case 0:a="head";break;case 1:a="torso";break;case 2:a="pants";break;case 3:a="hands";break;case 4:a="feet";break;default:a="accessory"}o+="<li>Type:"+a+"</li>",o+="<li>Defense:"+t.item[1].def||"None</li>",o+="<li>Cost:"+t.item[1].cost+" coins</li>",o+="<li>Level:"+t.item[1].itemLvl+"</li>",o+="<li>Resistance:";for(var l=[],i=[],s=0;s<t.item[1].res.length;s++)l.indexOf(n[t.item[1].res[s]])==-1&&l.push(n[t.item[1].res[s]]);for(var c in t.item[0].defChanges)1==t.item[0].defChanges[c]&&l.indexOf(t.item[0].defChanges[c])==-1?l.push(t.item[0].defChanges[c]):t.item[0].defChanges[c]==-1&&vuln.indexOf(t.item[0].defChanges[c])==-1&&vuln.push(t.item[0].defChanges[c]);for(var c in t.item[2].defChanges)1==t.item[2].defChanges[c]&&l.indexOf(t.item[2].defChanges[c])==-1?l.push(t.item[2].defChanges[c]):t.item[2].defChanges[c]==-1&&vuln.indexOf(t.item[2].defChanges[c])==-1&&vuln.push(t.item[2].defChanges[c]);o+=(l.length?l.join(", "):"none")+"</li>",o+="<li>Vulnerabilities:"+(i.length?i.join(", "):"none")+"</li>"}else if(t.giver||0===t.giver)e.get("/item/getGiver/"+t.giver).then(function(e){console.log("results from quest-giver search",e.data[0]),o+="<li>Level:"+t.lvl+"</li>",o+="<li>Given by:"+e.data[0].Name+"</li>",o+="</ul>",$("#moreInf").html(o),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info")});else if(t.energy||0===t.energy)o+="<li>Damage Type:"+r.getDmgType(t.type)+"</li>",o+="<li>Energy:"+t.energy+"</li>",o+=t.heal?"<li>Heal (burst):"+t.heal+" hp</li>":"",o+=t.regen?"<li>Heal (regeneration):"+t.regen+" hp/turn</li>":"",o+=t.burst?"<li>Damage:"+t.burst+" hp</li>":"",o+=t.degen?"<li>Degeneration:"+t.degen+" hp/turn</li>":"",o+=t.stuns?"<li>Stuns</li>":"";else if(t.maxHp)o+="What are you doing? You broke the game!";else if(t.item&&!t.item[1].slot)o+=t.item[1].max?"<li>Damage:"+t.item[1].min+"-"+t.item[1].max+" hp</li>":"",o+=t.item[1].def?"<li>Defense:"+t.item[1].def+"</li>":"",o+="<li>Level:"+t.item[1].itemLvl+"</li>",o+="<li>Cost:"+t.item[1].cost+" coins</li>";else{var m=!0;if(o+="<li>Level:"+t.lvl+"</li>",o+="<li>Hp:"+t.hp+" hp</li>",o+="<li>Dmg:"+t.min+"-"+t.max+" hp</li>",o+="<li>Damage Type:"+r.getDmgType(t.type)+"</li>",o+="<li>Resistance:",t.res&&t.res.length){o+="<ul>";for(var s=0;s<t.res.length;s++)o+="<li> "+r.getDmgType(t.res[s])+" </li>";o+="</ul>"}else o+="<span> none </span></li>"}t.giver||0==t.giver||(o+="</ul>",$("#moreInf").html(o),m&&$("#moreInf").css({background:"linear-gradient(rgba(241,241,212,.4),rgba(241,241,212,.4)),url("+t.imgUrl+")","background-size":"contain","background-repeat":"no-repeat","background-position":"right"}),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info"))},lessInf:function(){$("#moreInf").hide(200),$("div.modal-footer > button.btn.btn-info").html("More info")},saveGame:function(t,n,r){for(var a=0;a<t.equip.inv.length;a++){if(console.log("ITEM:",t.equip.inv[a]),t.equip.inv[a].item instanceof Array||"object"!=_typeof(t.equip.inv[a].item))for(var l=0;l<t.equip.inv[a].item.length;l++)t.equip.inv[a].item[l]=t.equip.inv[a].item[l].num;else t.equip.inv[a].item=[t.equip.inv[a].item.num];console.log("Inventory reducified!:",JSON.stringify(t.equip.inv))}e.post("/user/save",t).then(function(t){n&&t?e.get("/user/logout").then(function(e){window.location.href="./login"}):r&&t?o.location.reload():sandalchest.alert("Saved!","Your game has been saved!")})},logout:function(t){sandalchest.confirm("Logout","<span id='resetWarn'>WARNING:</span> You will lose all progress since your last save! Are you sure you wanna stop playing and log out?",function(t){t&&null!==t&&e.get("/user/logout").then(function(e){window.location.href="./login"})})},reset:function(){var t=Math.floor(50*Math.random()),n=Math.floor(50*Math.random());sandalchest.dialog("Reset Account","<div id='resetWarn'>WARNING:</div> Resetting your account is a <i>permanent</i> move. <br/>If you still wish to reset your game account, enter your username and password below, and solve the math question below and click the appropriate button. Be aware that this decision <i>cannot</i> be reversed!<hr/>Username:<input type='text' id='rmun'><br/>Password:<input type='password' id='rmpw'><hr/>Math Check:<br/>"+t+" + "+n+" = <input type='number' id='mathChk'> ",{buttons:[{text:"YES, reset.",close:!1,click:function(){return parseInt($("#mathChk").val())==t+n&&(credObj={name:$("#rmun").val(),pass:$("#rmpw").val()},void e.post("/user/reset",credObj).then(function(e){return!!e&&(window.location.replace("./login"),!0)}))}},{text:"NO, don't.",close:!0}]})},resetLevel:function(){sandalchest.confirm("Are you sure you wanna reset this level?",function(t){t&&e.get("/resetLevel").then(function(e){o.location.reload()})})},getRingObjs:function(e){var t;switch(e){case 0:t=[{name:"head",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"chest",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"hands",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"legs",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"feet",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"ring",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 1:t=[{name:"Change Skill",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Skill Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Attack",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Retreat",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Wait",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Player Status",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 2:t=[{name:"Current Creature Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"All Creatures Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Search Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Vanquished Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 3:t=[{name:"Current Side Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Legendary Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Old Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Main Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Stats",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;default:t=[{name:"Save",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Save and Logout",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Logout without saving",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Reset Account",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Stats",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"About",imgUrl:"",fn:function(){console.log("clicked this!")}}]}var n={objs:t,rot:360/t.length};return console.log("ring data",n),n},PlatinumSpinningRings:function(e,t){return e+t},doPlayerInv:function(t,n){return e.get("/item/allItems").then(function(e){for(var o in t)if("gold"!=o&&"inv"!=o){for(var r=-1,a=0;a<n.length;a++)if(n[a].name==o){r=a;break}t[o].indexOf(-1)==-1?(console.log("item isnt undefined!",t[o]),n[r].itName=e.data[2][t[o][0]].pre+" "+("weap"==o?e.data[1][t[o][1]].name:e.data[0][t[o][1]].name)+" "+e.data[2][t[o][2]].post,n[r].itFullInfo=[e.data[2][t[o][0]],"weap"==o?e.data[1][t[o][1]]:e.data[0][t[o][1]],e.data[2][t[o][2]]]):n[r].itName="none"}return n})},getContMen:function(e,t,n){return{x:t,y:n,el:e.UIEl,num:e.$index}}}}]),app.factory("userFact",["$http",function(e){return{checkPwdStr:function(e){console.log("password:",e);var t=new RegExp("[A-Z]","g"),n=new RegExp("[a-z]","g"),o=new RegExp("[0-9]","g"),r=new RegExp("\\W","g"),a=0;e.search(t)!=-1&&a++,e.search(n)!=-1&&a++,e.search(o)!=-1&&a++,e.search(r)!=-1&&a++;var l=e.length;return l>16?a+=6:l>11?a+=4:l>6&&(a+=2),a},checkPwdMatch:function(e,t){return e==t},checkName:function(t){return console.log("NAME TO BACKEND",t),e.get("/user/nameOkay/"+t).then(function(e){return console.log("NAME RESPONSE:",e.data),"okay"!=e.data})},login:function(t){return console.log("credentials in factory",t),e.post("/user/login",t).then(function(e){return console.log("response from backend:",e),"yes"==e.data})},checkLogin:function(){return e.get("/user/chkLog").then(function(e){return console.log("CHECKLOG RESULTS",e),e.data})}}}]);