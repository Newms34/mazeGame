var app=angular.module("mazeGame",[]).controller("log-con",function($scope,$http,$q,$timeout,$window,userFact){$scope.hazLogd=!1,$scope.newUsr=function(){if($scope.regForm.pwd.$viewValue!=$scope.regForm.pwdTwo.$viewValue)bootbox.alert("Your passwords don&rsquo;t match!",function(){});else{var userInf={user:$scope.regForm.username.$viewValue,password:$scope.regForm.pwd.$viewValue};$http.post("/user/new",userInf).then(function(res){"saved!"==res.data&&$scope.login(!0)})}},$scope.passMatch=!0,$scope.passStr=0,$scope.isNew=!1,$scope.checkPwdStr=function(){$scope.regForm.pwd.$viewValue&&($scope.passStr=userFact.checkPwdStr($scope.regForm.pwd.$viewValue)),console.log("pwd strength",$scope.passStr)},$scope.checkPwds=function(){$scope.passMatch=userFact.checkPwdMatch($scope.regForm.pwd.$viewValue,$scope.regForm.pwdTwo.$viewValue)},$scope.dupName=!1,$scope.nameCheck=function(){var name=$scope.regForm.username.$viewValue;console.log("userFact",userFact.checkName,"name",name),userFact.checkName(name).then(function(resp){$scope.dupName=resp})},$scope.login=function(n){n?userFact.login({name:$scope.regForm.username.$viewValue,pwd:$scope.regForm.pwd.$viewValue}).then(function(lRes){lRes?($scope.hazLogd=!0,$scope.getNews()):bootbox.alert("Either your username or password is not correct!")}):userFact.login({name:$scope.logForm.username.$viewValue,pwd:$scope.logForm.pwd.$viewValue}).then(function(lRes){lRes?($scope.hazLogd=!0,$scope.getNews()):bootbox.alert("Either your username or password is not correct!")})},$scope.play=function(){$window.location.href="./"},$scope.passInf=function(){bootbox.alert('<h3>Password Strength</h3><hr/>Here are a few things to include for a stronger password:<ul><li>A lowercase letter</li><li>An uppercase letter</li><li>A number</li><li>A non alpha-numeric symbol (something like "@" or "$")</li></ul>Longer passwords are also generally better!')},$scope.upd=[],$scope.getNews=function(){$http.get("/other/news").then(function(res){$scope.upd=res.data.split(/[\n\r]/)})},$scope.getNews(),$scope.parseInt=parseInt}),socket=io();app.controller("maze-con",function($scope,$http,$q,$interval,$timeout,$window,mazeFac,combatFac,UIFac,userFact,econFac){$scope.width=6,$scope.height=6,$scope.path=[],$scope.backtraceNum,$scope.currCell,$scope.bombsLeft=5,$scope.cellsDone=0,$scope.moveReady=!1,$scope.cells=[],$scope.cellNames=[],$scope.invActive=!1,$scope.setActive=!1,$scope.intTarg,$scope.lvl=1,$scope.playerItems=[],$scope.questList=[],$scope.doneQuest=[],$scope.maxHp=0,$scope.currHp=0,$scope.maxEn=0,$scope.currEn=0,$scope.isStunned=!1,$scope.inCombat=!1,$scope.merchy={},$scope.name="",$scope.getUsrData=function(){$http.get("/user/currUsrData").then(function(d){console.log("CURR USR DATA",typeof d,d),$scope.playerItems=d.data.equip,$scope.lvl=d.data.lvl,$scope.questList=d.data.inProg,$scope.doneQuest=d.data.questDone,$scope.maxHp=d.data.maxHp,$scope.currHp=d.data.currHp,$scope.maxEn=d.data.maxEn,$scope.currEn=d.data.currEn,$scope.isStunned=d.data.isStunned,$scope.name=d.data.name,econFac.merchInv($scope.playerItems.inv).then(function(r){for(var ep=0;ep<r.length;ep++)console.log("REPLACING",$scope.playerItems.inv[ep].item,"WITH",r[ep]),$scope.playerItems.inv[ep].item=r[ep]})})},$scope.currSkillNum=0,$scope.getUsrData(),$scope.uName="",($scope.checkPhone=function(){var isMobile=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(isMobile=!0),isMobile?$window.location.href="./mobile":userFact.checkLogin().then(function(resp){console.log("RESPONSE FROM CHECK LOGIN:",resp),resp||($window.location.href="./login")})})(),$scope.getInvName=function(el){var name="";return el.item?name=el.item.length&&el.item.length>2?el.item[0].pre+" "+el.item[1].name+" "+el.item[2].post:el.item[0].name:"ERROR!"},$scope.fillCells=function(){for(var i=0;i<$scope.cells.length;i++)"mons"==$scope.cells[i].has?mazeFac.popCell($scope.lvl,$scope.cells[i].id).then(function(m){$scope.cells[$scope.cellNames.indexOf(m.cell)].has=m.mons}):"npcs"==$scope.cells[i].has&&(console.log($scope.cells[i].id,"has an npc."),econFac.getNpc($scope.cells[i].id).then(function(r){$scope.cells[$scope.cellNames.indexOf(r.id)].has=r.data,r.data.isMerch&&1==r.data.isMerch&&econFac.merchInv(r.data.inv,r.id).then(function(inv){$scope.cells[$scope.cellNames.indexOf(inv.id)].has.inv=inv.inv})}))},$scope.dmgType=combatFac.getDmgType,$scope.doMaze=function(w,h){var mazeObj=mazeFac.makeMaze(w,h);$scope.cells=mazeObj.cells,$scope.path=mazeObj.path,$scope.cellNames=mazeObj.names,$scope.bombsLeft=5,$scope.moveReady=!0,$scope.playerCell="0-0",$scope.fillCells()}($scope.width,$scope.height),$scope.compareCell=function(id){return id==$scope.playerCell},$scope.bodyBoxes=[{name:"head",x:81,y:1},{name:"chest",x:80,y:115},{name:"legs",x:82,y:361},{name:"hands",x:1,y:285},{name:"feet",x:79,y:510},{name:"weap",x:158,y:284}],$scope.Skills=[],$scope.Bestiary=[],$scope.Quests=[],$scope.currUINum=0,$scope.UIPans=["Inventory","Skills","Bestiary","Quests","Menu"],$scope.currUIObjs=[],$scope.currUIBg="../img/UI/inv.jpg",$scope.currUIPan=$scope.UIPans[$scope.currUINum],$scope.chInv=function(dir){!dir&&$scope.currUINum>0?$scope.currUINum--:dir?1==dir&&$scope.currUINum<$scope.UIPans.length-1?$scope.currUINum++:1==dir&&($scope.currUINum=0):$scope.currUINum=$scope.UIPans.length-1,$scope.currUIPan=$scope.UIPans[$scope.currUINum],"Menu"!==$scope.currUIPan&&"Inventory"!==$scope.currUIPan?UIFac.getUIObj($scope.currUIPan,$scope[$scope.currUIPan]).then(function(uiRes){$scope.currUIObjs=uiRes.data,console.log("UI OBJS:",$scope.currUIObjs)}):"Inventory"==$scope.currUIPan&&UIFac.doPlayerInv($scope.playerItems,$scope.bodyBoxes).then(function(s){$scope.bodyBoxes=s,$scope.currUIObjs=$scope.playerItems.inv}),$scope.currUIBg=UIFac.getUIBg($scope.currUIPan)},$scope.chInv(1),$scope.bombOn=!1,$scope.roomRot=0,$scope.playerFacing=0,window.onkeydown=function(e){if($scope.moveReady&&73!==e.which){var currCell=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)],x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],dir="north";dir=$scope.playerFacing<45||$scope.playerFacing>315?"north":$scope.playerFacing>=45&&$scope.playerFacing<135?"west":$scope.playerFacing>=225&&$scope.playerFacing<315?"east":"south";var isMoveKey=!1,canMove=!1;if(87==e.which||38==e.which&&!$scope.moving){if(isMoveKey=!0,canMove=!1,currCell[dir]?$scope.bombOn&&(canMove=!0,$scope.bomb(dir),$scope.bombsLeft--):canMove=!0,canMove)switch(dir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}console.log("Attempting to move",dir)}else if(83==e.which||40==e.which&&!$scope.moving){isMoveKey=!0;var revDir;switch(dir){case"north":revDir="south";break;case"south":revDir="north";break;case"east":revDir="west";break;default:revDir="east"}if(canMove=!1,currCell[revDir]?$scope.bombOn&&(canMove=!0,$scope.bomb(revDir),$scope.bombsLeft--):canMove=!0,canMove)switch(revDir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}}else 68==e.which||39==e.which?(isMoveKey=!0,$scope.roomRot-=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):65==e.which||37==e.which?(isMoveKey=!0,$scope.roomRot+=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):66==e.which&&$scope.bombsLeft&&!$scope.bombOn?$scope.bombOn=!0:66==e.which&&$scope.bombOn?$scope.bombOn=!1:82==e.which?$scope.rotOn=!$scope.rotOn:192==e.which&&($scope.setActive=!$scope.setActive);isMoveKey&&e.preventDefault(),87!=e.which&&38!=e.which&&83!=e.which&&40!=e.which||!canMove||$scope.moving||($scope.playerCell=x+"-"+y,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].pViz=!0,$scope.intTarg="object"==typeof $scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has&&!$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has.inv&&$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has,$scope.intTarg&&(console.log("cell cons (probly mons):",$scope.intTarg),$scope.moveReady=!1,$scope.inCombat=!0,combatFac.combatReady()),"object"==typeof $scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has&&$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has.inv?($scope.currNpc=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has,$scope.merchy.prepNpc()):$scope.currNpc=null,$scope.$digest(),$scope.moveAni())}else 73==e.which&&(console.log("key i was pressed"),$scope.invActive=!$scope.invActive,$scope.invActive?$scope.moveReady=!1:$scope.moveReady=!0,$scope.$digest())},$scope.moving=!1,$scope.moveAni=function(ex){$scope.moving=!0,$("body").fadeOut(500,function(){$("body").fadeIn(500,function(){$scope.moving=!1,ex&&0!==ex&&($scope.lvl++,console.log("new lvl!:",$scope.lvl),$scope.saveGame(!0))})})},$scope.turnSpeed=0,window.onmousemove=function(e){$scope.$digest();var horiz=(e.x||e.clientX)/$(window).width();if(Math.abs(horiz-.5)>.3){var lOrR=horiz>.5?-1:1,turnVal=(Math.abs(horiz-.5)-.3)/.2;$scope.turnSpeed=6*lOrR*turnVal/1.5}else $scope.turnSpeed=0},$scope.mouseTurnTimer=$interval(function(){$scope.roomRot+=$scope.turnSpeed,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360},50),$scope.bomb=function(dir){var x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],otherDir="";switch(dir){case"north":y--,otherDir="south";break;case"east":x++,otherDir="west";break;case"south":y++,otherDir="north";break;default:x--,otherDir="east"}var bombInCell=x+"-"+y;$scope.cells[$scope.cellNames.indexOf(bombInCell)][otherDir]=!1,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]=!1,$scope.bombOn=!1},$scope.rotOn=!0,$scope.vertRot=85,$scope.getWallStatus=function(dir){var roomWall=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]?"./img/wall.jpg":"./img/door.jpg";return roomWall},$scope.isExit=function(){var tex="exit"==$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has?"./img/exit.png":"./img/ground.jpg";return tex},$scope.noMove=function($event){$event.stopPropagation()},$scope.floorCursor=function(){return"exit"==$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has?"pointer":"auto"},$("#uiloader").draggable({constrain:"body"}),$scope.inpPhone=function(){$scope.moveReady=!1,bootbox.prompt("Enter a name (you get this by visiting the site on your phone)!",function(result){null!==result&&" "!=result&&socket.emit("chkName",{n:result}),$scope.moveReady=!0})},socket.on("chkNameRes",function(nm){nm.n&&($scope.uName=nm.n),console.log("Name:",nm.n)}),$scope.travelOkay=!0,$scope.phoneMovTimer,socket.on("movOut",function(mvOb){if(mvOb.n==$scope.uName){var ex=null,ey=null;"l"==mvOb.x?(ex=new Event("keydown"),ex.which=65,window.onkeydown(ex)):"r"==mvOb.x&&(ex=new Event("keydown"),ex.which=68,window.onkeydown(ex)),"f"==mvOb.y&&$scope.travelOkay?(ey=new Event("keydown"),ey.which=87,window.onkeydown(ey),$scope.travelOkay=!1,$scope.phoneMovTimer=$timeout(function(){$scope.travelOkay=!0},1e3)):"b"==mvOb.y&&$scope.travelOkay&&(ey=new Event("keydown"),ey.which=83,window.onkeydown(ey),$scope.travelOkay=!1,$scope.phoneMovTimer=$timeout(function(){$scope.travelOkay=!0},1e3))}}),$scope.getUIInfo=function(el){var name;name=el.item.length&&el.item.length>2?el.item[0].pre+" "+el.item[1].name+" "+el.item[2].post:el.item[0].name;var desc;desc=el.item.length&&el.item.length>2?el.item[1].desc+"<br/>"+el.item[0].description+"<br/>"+el.item[2].description:el.item[0].desc,bootbox.dialog({title:"<h3>"+name+"</h3>",message:"<p>"+desc+'</p><p id="moreInf" style="display:none;"></p>',buttons:{success:{label:"Close",className:"btn-primary"},info:{label:"More info",className:"btn-info",callback:function(){return"none"==$("#moreInf").css("display")?UIFac.moreInfo(el):UIFac.lessInf(),!1}}}})},$scope.levelDown=function(){bootbox.confirm("Ready to go to the next level?",function(res){res&&null!==res&&$scope.moveAni(1)})},$scope.saveGame=function(reload){var data={name:$scope.name,lvl:$scope.lvl,equip:$scope.playerItems,questDone:$scope.questList||[],inProf:$scope.doneQuest,maxHp:$scope.maxHp,currHp:$scope.currHp,maxEn:$scope.maxEn,currEn:$scope.currEn,isStunned:$scope.isStunned};UIFac.saveGame(data,!1,reload)},$scope.saveAndLogout=function(){var data={name:$scope.name,lvl:$scope.lvl,equip:$scope.playerItems,questDone:$scope.questList||[],inProf:$scope.doneQuest,maxHp:$scope.maxHp,currHp:$scope.currHp,maxEn:$scope.maxEn,currEn:$scope.currEn,isStunned:$scope.isStunned};UIFac.saveGame(data,!0,!1)},$scope.logout=UIFac.logout,$scope.reset=UIFac.reset,$scope.trunc=function(n){return Math.floor(10*n)/10},$scope.isNearMerch=!1,$scope.equipItem=function(el,numb){console.log("EL",el);var whereNum=el.item&&el.item[1]&&"undefined"!=typeof el.item[1].slot?el.item[1].slot:-1;if(el.item&&el.item.length>2&&whereNum!=-1);else{if(!(el.item&&el.item.length>2))return;whereNum=5}var oldItem=angular.copy($scope.bodyBoxes[whereNum]),oldItemInv={lootType:"weap"==oldItem.name?1:0,item:angular.copy(oldItem.itFullInfo),num:1};$scope.bodyBoxes[whereNum].itFullInfo=el.item,$scope.bodyBoxes[whereNum].itName=$scope.bodyBoxes[whereNum].itFullInfo[0].pre+" "+$scope.bodyBoxes[whereNum].itFullInfo[1].name+" "+$scope.bodyBoxes[whereNum].itFullInfo[2].post,console.log("LOCATOR",whereNum,"NAME:",$scope.bodyBoxes[whereNum].name,"FROM",$scope.bodyBoxes[whereNum],"TO",$scope.playerItems[$scope.bodyBoxes[whereNum].name],"OLD ITEM:",oldItem);for(var i=0;i<$scope.playerItems[$scope.bodyBoxes[whereNum].name].length;i++)$scope.playerItems[$scope.bodyBoxes[whereNum].name][i]=$scope.bodyBoxes[whereNum].itFullInfo[i].num;$scope.playerItems.inv.splice(numb,1);"undefined"!=typeof oldItemInv.item&&$scope.playerItems.inv.push(oldItemInv),UIFac.doPlayerInv($scope.playerItems,$scope.bodyBoxes).then(function(s){$scope.bodyBoxes=s,$scope.currUIObjs=$scope.playerItems.inv})},$scope.contMenOn=!1,window.oncontextmenu=function(e){"Inventory"==$scope.currUIPan&&"currUIEl ng-binding ng-scope"==e.target.className&&(e.preventDefault(),e.stopPropagation(),$scope.contMenOn=UIFac.getContMen(angular.element(e.target).scope(),e.x,e.y),$scope.$apply())},window.onclick=function(e){console.log(e.target,e.target.id,"contexMen"==e.target.id),e.button&&0!==e.button||"contexMen"==e.target.id||($scope.contMenOn=!1)},$scope.trashItem=function(el,numb){bootbox.confirm("Are you sure you wish to destroy this "+(el.item.length>1?el.item[0].pre+" "+el.item[1].name+" "+el.item[2].post:el.item[0].name)+"?",function(res){console.log("RES",res,el.name),res&&null!==res&&($scope.playerItems.inv.splice(numb,1),UIFac.doPlayerInv($scope.playerItems,$scope.bodyBoxes).then(function(s){$scope.bodyBoxes=s,$scope.currUIObjs=$scope.playerItems.inv}))})}}),app.controller("mob-con",function($scope,$http,$q,$interval,$swipe,$window,UIFac){$scope.currRotX=0,$scope.currRotY=0,$scope.rotX=null,$scope.rotY=null,$scope.uName="retrieving...",$scope.uiOpts=["Inventory","Skills","Bestiary","Quests","Menu"],$scope.prevUI="Quests",$scope.currUI="Menu",$scope.nextUI="Inventory",$scope.uiObjs=[],$scope.getUn=function(){var nounStart=String.fromCharCode(65+Math.floor(25*Math.random())),adjStart=String.fromCharCode(65+Math.floor(25*Math.random()));$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+nounStart+"&cmlimit=500&cmtitle=Category:Nouns",success:function(nounRes){for(var noun=" ";noun.indexOf(" ")!=-1;)noun=nounRes.query.categorymembers[Math.floor(Math.random()*nounRes.query.categorymembers.length)].title;console.log("final noun:",noun),$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+adjStart+"&cmlimit=500&cmtitle=Category:Adjectives",success:function(adjRes){for(var adj=" ";adj.indexOf(" ")!=-1;)adj=adjRes.query.categorymembers[Math.floor(Math.random()*adjRes.query.categorymembers.length)].title;$scope.uName=adj.toLowerCase()+" "+noun.toLowerCase(),$scope.movObj.n=$scope.uName,socket.emit("movData",$scope.movObj),$scope.$digest()}})}})},$scope.getUn(),$scope.sendMove=$interval(function(){"retrieving..."!=$scope.uName&&$scope.isMoving&&socket.emit("movData",$scope.movObj)},75),$scope.isMoving=!1,$scope.movObj={x:$scope.rotX,y:$scope.rotY,n:null},$window.addEventListener("deviceorientation",function($event){if("retrieving..."!=$scope.uName){var rotX=Math.floor($event.gamma/90*120),rotY=Math.floor($event.beta/90*120);$scope.isMoving=!1,rotX>50?($scope.rotX="r",$scope.isMoving=!0):rotX<-50?($scope.rotX="l",$scope.isMoving=!0):$scope.rotX=null,rotY<-35?($scope.rotY="f",$scope.isMoving=!0):rotY>35?($scope.rotY="b",$scope.isMoving=!0):$scope.rotY=null,$scope.movObj={x:$scope.rotX,y:$scope.rotY,n:$scope.uName}}}),$scope.ringSize=275,$scope.currRingRot=0,$scope.rngChTimer,$scope.rngChOkay=!0,$scope.ringChAni=function(newR,oldR){if(!$scope.rngChOkay)return!1;if([].slice.call($(".RingUIEl")).length)$(".RingUIEl").animate({transform:"rotateY(0deg) translateZ("+$scope.ringSize+"px);"},{duration:500,complete:function(){$scope.currUI=$scope.uiOpts[newR],console.log("switched from",$scope.uiOpts[oldR],"to",$scope.uiOpts[newR]),newR<oldR?($scope.nextUI=$scope.uiOpts[oldR],oldR?$scope.prevUI=$scope.uiOpts[oldR-1]:$scope.prevUI=$scope.uiOpts[$scope.uiOpts.length-1]):($scope.prevUI=$scope.uiOpts[oldR],newR<$scope.uiOpts.length-2?$scope.nextUI=$scope.uiOpts[newR+1]:$scope.nextUI=$scope.uiOpts[0]),console.log("NEW UI OBJECTS:",UIFac.getRingObjs(newR)),console.log("num ui objs"),$scope.currRingRot=0;var rData=UIFac.getRingObjs(newR);console.log("DATA",rData),$scope.uiObjs=rData.objs,$scope.rotPer=rData.rot}});else{$scope.currUI=$scope.uiOpts[newR],console.log("switched from",$scope.uiOpts[oldR],"to",$scope.uiOpts[newR]),newR<oldR?($scope.nextUI=$scope.uiOpts[oldR],oldR?$scope.prevUI=$scope.uiOpts[oldR-1]:$scope.prevUI=$scope.uiOpts[$scope.uiOpts.length-1]):($scope.prevUI=$scope.uiOpts[oldR],newR<$scope.uiOpts.length-2?$scope.nextUI=$scope.uiOpts[newR+1]:$scope.nextUI=$scope.uiOpts[0]),console.log("NEW UI OBJECTS:",UIFac.getRingObjs(newR)),console.log("num ui objs"),$scope.currRingRot=0;var rData=UIFac.getRingObjs(newR);console.log("DATA",rData),$scope.uiObjs=rData.objs,$scope.rotPer=rData.rot}$scope.rngChOkay=!1,$scope.rngChTimer=setTimeout(function(){$scope.rngChOkay=!0},1e3)},$scope.uiObjs=UIFac.getRingObjs(0),$scope.chMenRng=function(dir){var currMenItem=$scope.uiOpts.indexOf($scope.currUI),oldRing=currMenItem;dir&&0!==dir?currMenItem<$scope.uiOpts.length-1?currMenItem++:currMenItem=0:currMenItem&&0!==currMenItem?currMenItem--:currMenItem=$scope.uiOpts.length-1,console.log("changing menu ring:",dir,currMenItem,oldRing),$scope.ringChAni(currMenItem,oldRing)},$scope.oldX,$scope.oldY,$scope.noScroll=function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1},$scope.parseTouch=function(e){if($scope.noScroll(e),!$scope.oldX||!$scope.oldY)return $scope.oldX=e.x,$scope.oldY=e.y,!1;var dx=e.x-$scope.oldX,dy=e.y-$scope.oldY;if($scope.oldX=e.x,$scope.oldY=e.y,Math.abs(dx)>Math.abs(dy))$scope.currRingRot=UIFac.PlatinumSpinningRings($scope.currRingRot,dx);else{if(!(Math.abs(dy)>10))return!1;$scope.chMenRng(dy>0?0:1)}},$scope.chMenRng(1),$scope.chMenRng(1),$swipe.bind($("body#mob"),{move:$scope.parseTouch})}),app.factory("combatFac",function($http){var dmgTypes=["Physical","Fire","Ice","Poison","Dark","Holy"];return{getDmgType:function(typeNum){return dmgTypes[parseInt(typeNum)]},combatReady:function(){$("#combat-box #enemy .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .energy-bar .stat-bar-stat").css("width","100%")},getSkillInf:function(all,n){bootbox.dialog({message:all[n].desc,title:all[n].name,buttons:{main:{label:"Okay",className:"btn-primary"}}})},updateBars:function(pm,pc,pem,pec,mm,mc){pm=parseInt(pm),pc=parseInt(pc),pem=parseInt(pem),pec=parseInt(pec),mm=parseInt(mm),mc=parseInt(mc);var phperc=parseInt(100*pc/pm),penperc=parseInt(100*pec/pem),mhperc=parseInt(100*mc/mm);console.log(mhperc,phperc,penperc),$("#combat-box #enemy .health-bar .stat-bar-stat").css("width",mhperc+"%"),$("#combat-box #player .health-bar .stat-bar-stat").css("width",phperc+"%"),$("#combat-box #player .energy-bar .stat-bar-stat").css("width",penperc+"%")},getItems:function(){return $http.get("/item/allItems").then(function(s){return s})},rollLoot:function(mons){return $http.get("/item/byLvl/"+mons.lvl).then(function(i){return i.data})}}}),app.controller("comb-con",function($scope,$http,$q,$timeout,$window,combatFac){$scope.comb={},$scope.comb.skills,$scope.comb.playersTurn=!1,$scope.comb.itemStats,$scope.comb.attackEffects=[],$scope.inCombat=!0,$scope.comb.prepComb=function(){$scope.comb.battleStatus={status:!1,title:"NONE",txt:"NONE"},$scope.intTarg.currHp=$scope.intTarg.hp,$(".pre-battle").hide(250),combatFac.getItems().then(function(r){console.log(r),$scope.comb.itemStats=r.data,$scope.comb.monsTurn()})},$scope.comb.skillCh=function(dir){dir?$scope.currSkillNum<$scope.comb.skills.length-1?$scope.currSkillNum++:$scope.currSkillNum=0:$scope.currSkillNum>0?$scope.currSkillNum--:$scope.currSkillNum=$scope.comb.skills.length-1},$scope.comb.getAllSkills=function(){$http.get("/item/Skills").then(function(s){console.log(s.data),$scope.comb.skills=s.data})},$scope.currPRegens=[],$scope.currPDegens=[],$scope.currMRegens=[],$scope.currMDegens=[],$scope.monsStunned=!1,$scope.pStunned=!1,$scope.comb.getAllSkills(),$scope.comb.showSkillInf=function(){combatFac.getSkillInf($scope.comb.skills,$scope.currSkillNum)},$scope.comb.attemptFlee=function(){},$scope.comb.wait=function(){$scope.comb.updateDoTs(),$scope.currHp<=0?$scope.comb.dieP():($scope.comb.playersTurn=!1,$scope.comb.monsTurn())},$scope.comb.attack=function(){$scope.comb.attackEffects=[];var pDmg=parseInt($scope.comb.calcDmg(1));$scope.intTarg.currHp-=pDmg,combatFac.updateBars($scope.maxHp,$scope.currHp,$scope.maxEn,$scope.currEn,$scope.$parent.intTarg.hp,$scope.$parent.intTarg.currHp),$scope.comb.updateDoTs();var attackInfoStr="You attack for "+pDmg+" "+combatFac.getDmgType($scope.comb.skills[$scope.currSkillNum].type)+" damage, using "+$scope.comb.skills[$scope.currSkillNum].name+"!";if($scope.comb.attackEffects.length){var novaHit="nova"==$scope.comb.attackEffects;novaHit&&$scope.comb.attackEffects.shift();for(var efStr=" Your attack is a ",i=0;i<$scope.comb.attackEffects.length-1;i++)efStr+=$scope.comb.attackEffects[i]+", ";efStr+=$scope.comb.attackEffects.length>1?"and "+$scope.comb.attackEffects[$scope.comb.attackEffects.length-1]+" one.":$scope.comb.attackEffects[$scope.comb.attackEffects.length-1]+" one.",attackInfoStr+=efStr}bootbox.alert(attackInfoStr,function(r){$scope.intTarg.currHp<=0?$scope.comb.dieM():($scope.comb.playersTurn=!1,$scope.comb.monsTurn())})},$scope.comb.DoT=function(name,amt,dur){this.dur="undefined"!=typeof dur?dur:5,this.name=name,this.amt=amt},$scope.comb.checkDoTDup=function(arr,name){for(var i=0;i<arr.length;i++)if(arr[i].name==name)return!1;return!0},$scope.resetDoTDur=function(arrName,name,dur){for(var i=0;i<$scope[arrName].length;i++)if($scope[arrName][i].name==name){$scope[arrName][i].dur="undefined"!=typeof dur?dur:5;break}},$scope.comb.calcDmg=function(d){var allWeaps=$scope.comb.itemStats[1],allArm=$scope.comb.itemStats[0],allAff=$scope.comb.itemStats[2];console.log("WEAP IDS",$scope.$parent.playerItems.weap,"WEAPS",allWeaps,"ARMOR",allArm,"Affixes",allAff);var playerWeap=$scope.$parent.playerItems.weap[1]!=-1&&[allAff[$scope.$parent.playerItems.weap[0]],allWeaps[$scope.$parent.playerItems.weap[1]],allAff[$scope.$parent.playerItems.weap[2]]];console.log(playerWeap[0].pre+" "+playerWeap[1].name+" "+playerWeap[2].post,playerWeap);var dtype,dmg,lvlDif,totalRawD=0,totalRawA=0,activeRes=!1;if(lvlDif=$scope.$parent.intTarg.lvl/$scope.lvl>2?2:$scope.$parent.intTarg.lvl/$scope.lvl<.5?.5:$scope.$parent.intTarg.lvl/$scope.lvl,d){if(!$scope.pStunned){dtype=$scope.comb.skills[$scope.currSkillNum].type,playerWeap[0].dmgType!=-1&&(dtype=playerWeap[0].dmgType),playerWeap[2].dmgType!=-1&&(dtype=playerWeap[2].dmgType);var weapDmg=playerWeap?Math.floor(Math.random()*(playerWeap[1].max-playerWeap[1].min))+playerWeap[1].min:0;(Math.random()<playerWeap[0].brut||Math.random()<playerWeap[2].brut)&&(weapDmg*=1.7,$scope.comb.attackEffects.push("brutal"));var skillDmg=$scope.comb.skills[$scope.currSkillNum].burst;if($scope.comb.skills[$scope.currSkillNum].degen){var crueDur=Math.random()<playerWeap[0].crue||Math.random()<playerWeap[2].crue?10:5;crueDur>5&&$scope.comb.attackEffects.push("cruel"),$scope.comb.checkDoTDup($scope.currMDegens,$scope.$parent.intTarg.name+"-"+$scope.comb.skills[$scope.currSkillNum].name+"-degen")?$scope.currMDegens.push(new $scope.comb.DoT($scope.$parent.intTarg.name+"-"+$scope.comb.skills[$scope.currSkillNum].name+"-degen",$scope.comb.skills[$scope.currSkillNum].degen,crueDur)):$scope.resetDoTDur("currMDegens",$scope.$parent.intTarg.name+"-"+$scope.comb.skills[$scope.currSkillNum].name+"-degen",crueDur)}if($scope.comb.skills[$scope.currSkillNum].regen){var rejuvDur=Math.random()<playerWeap[0].rejuv||Math.random()<playerWeap[2].rejuv?10:5;rejuvDur>5&&$scope.comb.attackEffects.push("rejuvenating"),$scope.comb.checkDoTDup($scope.currPRegens,"player-"+$scope.comb.skills[$scope.currSkillNum].name+"-regen")?$scope.currPRegens.push(new $scope.comb.DoT("player-"+$scope.comb.skills[$scope.currSkillNum].name+"-regen",$scope.comb.skills[$scope.currSkillNum].regen,rejuvDur)):$scope.resetDoTDur("currPRegens","player-"+$scope.comb.skills[$scope.currSkillNum].name+"-regen",rejuvDur)}if($scope.comb.skills[$scope.currSkillNum].heal){var beneMult=Math.random()<playerWeap[0].bene||Math.random()<playerWeap[2].bene?2:1;rejuvDur>5&&$scope.comb.attackEffects.push("benedictive"),$scope.currHp+=$scope.comb.skills[$scope.currSkillNum].heal*beneMult,$scope.currHp>$scope.maxHp&&($scope.currHp=$scope.maxHp)}($scope.comb.skills[$scope.currSkillNum].stuns||Math.random()<playerWeap[0].stunCh||Math.random()<playerWeap[2].stunCh)&&($scope.monsStunned=!0,$scope.comb.attackEffects.push("stunning"));var novaDmg=Math.random()<playerWeap[0].novaChance||Math.random()<playerWeap[2].novaChance?.5*weapDmg:0;if(novaDmg&&$scope.comb.attackEffects.unshift("nova"),$scope.intTarg.res.indexOf(playerWeap[0].novaType)==-1&&$scope.intTarg.res.indexOf(playerWeap[1].novaType)==-1||(novaDmg=Math.floor(novaDmg/3)),(Math.random()<playerWeap[0].conf||Math.random()<playerWeap[2].conf)&&($scope.monsConf=!0,$scope.comb.attackEffects.push("confusing")),playerWeap[0].vamp>0||playerWeap[2].vamp>0){$scope.comb.attackEffects.push("life-stealing");var vampPerc=.1*Math.random()+.05;$scope.currHp+=(weapDmg+skillDmg)*vampPerc,$scope.currHp>$scope.maxHp&&($scope.currHp=$scope.maxHp)}return skillDmg+weapDmg+novaDmg}bootbox.alert("You've been stunned! You can't attack this turn.")}else if($scope.monsStunned)$scope.monsStunned=!1;else{dtype=$scope.$parent.intTarg.type,totalRawD=lvlDif*(Math.ceil(Math.random()*($scope.$parent.intTarg.max-$scope.$parent.intTarg.min))+$scope.$parent.intTarg.min);var parts={head:{freq:1},chest:{freq:5},hands:{freq:3},legs:{freq:2},feet:{freq:1}},partFreqs=$scope.comb.freqGen(parts),thePart=partFreqs[Math.floor(Math.random()*partFreqs.length)],partHitA=$scope.playerItems[thePart]&&0!=$scope.playerItems[thePart][1].def?$scope.playerItems[thePart][1].def:0,bonusA=0;if(playerWeap[1].def&&(bonusA+=playerWeap[1].def),$scope.playerItems.inv&&$scope.playerItems.inv.length)for(var resd=0;resd<$scope.playerItems.inv.length;resd++)console.log("CHECKING DEFENSE ON ITEM:",$scope.playerItems.inv[resd]),bonusA+=$scope.playerItems.inv[resd].item[1].def||0,$scope.playerItems.inv[resd].item[1].res&&$scope.playerItems.inv[resd].item[1].res.indexOf(dtype)!=-1&&(activeRes=!0);totalRawA=partHitA+bonusA;for(var p in parts)$scope.playerItems[p].res&&$scope.playerItems[p].res.indexOf(dtype)!=-1&&(activeRes=!0)}return dmg=totalRawD/(3*Math.log10(totalRawA+1)||1),activeRes?dmg/=3:(1!=playerWeap[0].defChanges[combatFac.getDmgType(dtype)]&&1!=playerWeap[2].defChanges[combatFac.getDmgType(dtype)]||(dmg/=3),playerWeap[0].defChanges[combatFac.getDmgType(dtype)]!=-1&&playerWeap[2].defChanges[combatFac.getDmgType(dtype)]!=-1||(dmg=1.5*dmg)),dmg},$scope.comb.freqGen=function(obj){for(var els=Object.keys(obj),outArr=[],i=0;i<els.length;i++)for(var j=0;j<obj[els[i]].freq;j++)outArr+=els[i];return outArr},$scope.comb.acceptStatus=function(){var vic="Victory!"==$scope.comb.battleStatus.title;$(".pre-battle").show(10),$scope.comb.battleStatus={status:!1,title:" ",txt:" ",url:"./img/paper.jpg"},vic?(combatFac.rollLoot($scope.intTarg).then(function(items){console.log("FROM ROLL LOOT",items);var iName="",lootObj={};"junk"==items.type?iName=items.loot.name:(lootObj.lootType=items.type,lootObj.num=items.num,lootObj.item=[items.loot.pre,items.loot.base,items.loot.post],iName=items.loot.pre.pre+" "+items.loot.base.name+" "+items.loot.post.post,$scope.playerItems.inv.push(lootObj)),bootbox.alert("After killing the "+$scope.intTarg.name+", you recieve "+iName+"!")}),angular.element("body").scope().cells[angular.element("body").scope().cellNames.indexOf(angular.element("body").scope().playerCell)].has=""):(angular.element("body").scope().playerCell="0-0",angular.element("body").scope().intTarg.currHp=angular.element("body").scope().hp,$scope.$parent.intTarg.currHp=$scope.$parent.intTarg.hp),$scope.inCombat=!1,angular.element("body").scope().inCombat=!1,angular.element("body").scope().intTarg=!1,angular.element("body").scope().moveReady=!0,angular.element("body").scope().currHp=angular.element("body").scope().maxHp,angular.element("body").scope().currEn=angular.element("body").scope().maxEn,$scope.currHp=$scope.maxHp,$scope.currEn=$scope.maxEn,combatFac.updateBars($scope.maxHp,$scope.currHp,$scope.maxEn,$scope.currEn,$scope.$parent.intTarg.hp,$scope.$parent.intTarg.currHp),angular.element("body").scope().$apply()},$scope.comb.dieP=function(){$scope.comb.battleStatus={status:!0,title:"Defeat!",
txt:"You've been defeated!",url:"./img/assets/Defeat.jpg"}},$scope.comb.dieM=function(){$scope.comb.battleStatus={status:!0,title:"Victory!",txt:"You are victorious! The "+$scope.intTarg.name+" lies defeated at your feet.",url:"./img/assets/Victory.jpg"}},$scope.comb.updateDoTs=function(){for(n=0;n<$scope.currPRegens;n++)$scope.currHp+=$scope.currPRegens[n].amt,$scope.currPRegens[n].dur--,$scope.currPRegens[n].dur||$scope.currPRegens.splice(n,1);for($scope.currHp>$scope.maxHp&&($scope.currHp=$scope.maxHp),n=0;n<$scope.currPDegens;n++)$scope.currHp-=$scope.currPDegens[n].amt,$scope.currPDegens[n].dur--,$scope.currPDegens[n].dur||$scope.currPDegens.splice(n,1);for(n=0;n<$scope.currMRegens;n++)$scope.intTarg.currHp+=$scope.currMRegens[n].amt,$scope.currMRegens[n].dur--,$scope.currMRegens[n].dur||$scope.currMRegens.splice(n,1);for($scope.intTarg.currHp>$scope.intTarg.hp&&($scope.intTarg.currHp=$scope.intTarg.hp),n=0;n<$scope.currMDegens;n++)$scope.intTarg.currHp+=$scope.currMDegens[n].amt,$scope.currMDegens[n].dur--,$scope.currMDegens[n].dur||$scope.currMDegens.splice(n,1)},$scope.comb.monsTurn=function(){if(console.log("monster taking turn!"),$scope.monsStunned)bootbox.alert($scope.$parent.intTarg.name+" is stunned this turn!",function(){$scope.comb.playersTurn=!0});else{var monDmg=parseInt($scope.comb.calcDmg()),confSelfDmg=Math.random()<.5&&$scope.monsConf;confSelfDmg?($scope.monsConf=!1,$scope.intTarg.currHp-=monDmg,combatFac.updateBars($scope.maxHp,$scope.currHp,$scope.maxEn,$scope.currEn,$scope.$parent.intTarg.hp,$scope.$parent.intTarg.currHp),bootbox.alert($scope.$parent.intTarg.name+" is confused, and attacks itself for "+monDmg+" "+combatFac.getDmgType($scope.$parent.intTarg.type)+"!",function(){$scope.comb.updateDoTs(),$scope.intTarg.currHp<=0?$scope.comb.dieM():$scope.comb.playersTurn=!0})):$scope.intTarg.currHp/$scope.intTarg.hp>.5&&Math.random<$scope.intTarg.healCh?bootbox.alert("The "+$scope.intTarg.name+" heals!",function(){var healAmt=$scope.intTarg.hp*(.07+Math.random()/10);$scope.intTarg.currHp+=healAmt,$scope.intTarg.currHp>$scope.intTarg.hp&&($scope.intTarg.currHp=$scope.currHp),$scope.comb.playersTurn=!0}):$scope.intTarg.currHp/$scope.intTarg.hp>.5&&-3.6*($scope.intTarg.currHp/$scope.intTarg.hp)+3>Math.random()?bootbox.alert("The "+$scope.intTarg.name+" heals!",function(){var healAmt=$scope.intTarg.hp*(.07+Math.random()/10);$scope.intTarg.currHp+=healAmt,$scope.intTarg.currHp>$scope.intTarg.hp&&($scope.intTarg.currHp=$scope.currHp),$scope.comb.playersTurn=!0}):(Math.random()<$scope.$parent.intTarg.stunCh&&($scope.pStunned=!0),$scope.currHp-=monDmg,combatFac.updateBars($scope.maxHp,$scope.currHp,$scope.maxEn,$scope.currEn,$scope.$parent.intTarg.hp,$scope.$parent.intTarg.currHp),bootbox.alert($scope.$parent.intTarg.name+" attacks for "+monDmg+" "+combatFac.getDmgType($scope.$parent.intTarg.type)+"!",function(){$scope.comb.updateDoTs(),$scope.currHp<=0?$scope.comb.dieP():$scope.comb.playersTurn=!0}))}}}),app.factory("econFac",function($http,$q){return{merchInv:function(invArr){return $http.get("/item/allItems").then(function(d){var fullInvArr=[];console.log("GETTING ITEM DATA:invArr",invArr);for(var i=0;i<invArr.length;i++)0==invArr[i].lootType?fullInvArr.push([d.data[2][invArr[i].item[0]],d.data[0][invArr[i].item[1]],d.data[2][invArr[i].item[2]]]):fullInvArr.push([d.data[2][invArr[i].item[0]],d.data[1][invArr[i].item[1]],d.data[2][invArr[i].item[2]]]);return fullInvArr})},getNpc:function(i){return $http.get("/other/oneNpc").then(function(n){return{data:n.data,id:i}})}}}),app.factory("mazeFac",function($http){var cell=function(id,cont){this.id=id,this.x=id.split("-")[0],this.y=id.split("-")[1],this.east=!0,this.west=!0,this.north=!0,this.south=!0,this.visited=!1,this.pViz=!1,this.has=cont},cellNames=[],cellsDone=0,cells=[],currCell="",path=[],possRoomConts=["loot","mons","npcs","jewl"," ","exit"," "," ","mons","mons"],backTrace=function(){for(var good=!1;!good;){if(path.pop(),!path.length)return!1;currCell=path[path.length-1];for(var targDir,posDirs=["n","e","s","w"],pos=cellNames.indexOf(currCell);!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1))}return good};return cell.prototype.dig=function(dir,newCell){switch(dir){case"n":this.north=!1,newCell.south=!1;break;case"e":this.east=!1,newCell.west=!1;break;case"s":this.south=!1,newCell.north=!1;break;default:this.west=!1,newCell.east=!1}},cell.prototype.checkCell=function(dir){var posArr=this.id.split("-"),x=parseInt(posArr[0]),y=parseInt(posArr[1]);switch(dir){case"n":y--;break;case"e":x++;break;case"s":y++;break;default:x--}var newCellName=x+"-"+y,pos=cellNames.indexOf(newCellName);return pos==-1?"e":cells[pos].visited?"v":newCellName},{popCell:function(l,c){return $http.get("/item/beastie/"+l+"/"+c).then(function(res){return res.data})},makeMaze:function(mW,mH){cells=[],cellNames=[],path=[],cellsDone=0,didEx=!1;for(var x=0;x<mW;x++)for(var y=0;y<mH;y++){for(var rItem=possRoomConts[Math.floor(Math.random()*possRoomConts.length)];(0===x||0===y)&&"exit"==rItem;)rItem=possRoomConts[Math.floor(Math.random()*possRoomConts.length)];"exit"==rItem&&(didEx=!0,possRoomConts.splice(5,1)),cells.push(new cell(x+"-"+y,rItem)),cellNames.push(x+"-"+y)}for(didEx||(cells[Math.floor(Math.random()*cells.length)].has="exit"),currCell="0-0";cellsDone<cellNames.length;){path.push(currCell);for(var targDir,posDirs=["n","e","s","w"],pos=cellNames.indexOf(currCell),good=!1;!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1));if(cells[pos].visited=!0,good||(good=backTrace()),!good)break;currCell=good;var newPos=cellNames.indexOf(currCell);cells[pos].dig(posDirs[targDir],cells[newPos]),cellsDone++}return{cells:cells,names:cellNames,path:path}}}}),app.controller("merch-cont",function($scope,$http,$q,$timeout,$window,econFac){console.log("THING RUNNING"),$scope.merchy.prepNpc=function(){if($scope.merchy.buy=!0,$scope.merchy.merch=$scope.currNpc,console.log("FROM MERCH CONT",$scope.merchy),$scope.merchy.merch.sez=$scope.merchy.merch.gossip[Math.floor(Math.random()*$scope.merchy.merch.gossip.length)],console.log(econFac.merchInv,typeof $scope.merchy.merch.inv),!$scope.merchy.merch.alreadyInfoed){econFac.merchInv($scope.merchy.merch.inv).then(function(r){console.log("THIS NPC HAS:",r);for(var n=0;n<$scope.merchy.merch.inv.length;n++)$scope.merchy.merch.inv[n].item=r[n];$scope.merchy.merch.alreadyInfoed=!0,$scope.$apply()})}},$scope.merchy.itemForPlayer=null,$scope.merchy.exchange=function(item,dir,ind){$scope.moveReady=!1,angular.element("body").scope().moveReady=!1;var itemFull=item.item[0].pre+" "+item.item[1].name+"s "+item.item[2].post,itemBaseCost=Math.floor(item.item[1].cost*(10+item.item[0].cost+item.item[2].cost))/10;console.log("ITEM DATA TO EXCHANGE",item,"and dir:",dir),bootbox.dialog({message:"How many "+itemFull+" do you want to "+(dir?"sell":"buy")+"?<hr/><input type=number value=1 min=1 max="+item.num+" id='numExch'>",title:(dir?"Sell":"Buy")+" Items",buttons:{main:{label:(dir?"Sell":"Buy")+" Items",className:"btn-success",callback:function(){var numToExch=parseInt($("#numExch").val());if(dir&&"false"!=dir)numToExch<item.num?$scope.playerItems.inv[ind].num-=numToExch:$scope.playerItems.inv.splice(ind,1),$scope.playerItems.gold+=itemBaseCost*numToExch*.9;else if(numToExch*itemBaseCost<$scope.playerItems.gold){console.log("Scummy merchant didnt even give me my ",item),numToExch<item.num?$scope.merchy.merch.inv[ind].num-=numToExch:$scope.merchy.merch.inv.splice(ind,1);for(var itLoc=-1,i=0;i<$scope.playerItems.inv.length;i++){var compName=$scope.playerItems.inv[i].item[0].pre+" "+$scope.playerItems.inv[i].item[1].name+"s "+$scope.playerItems.inv[i].item[2].post;itemFull==compName&&(itLoc=i)}if(itLoc!=-1)$scope.playerItems.inv[itLoc].num+=numToExch;else{$scope.merchy.itemForPlayer=angular.copy(item),console.log("ITEM FOR PLAYER",$scope.merchy.itemForPlayer),$scope.merchy.itemForPlayer.num=numToExch,$scope.playerItems.inv.push($scope.merchy.itemForPlayer)}$scope.playerItems.gold-=itemBaseCost*numToExch}else bootbox.alert("You don't have enough money to afford "+numToExch+" "+itemFull+"s!");return angular.element("body").scope().moveReady=!0,$scope.moveReady=!0,!0}},danger:{label:"Cancel",className:"btn-danger",callback:function(){return angular.element("body").scope().moveReady=!0,$scope.moveReady=!0,!0}}}})}}),app.factory("socketFac",function($rootScope){var socket=io.connect();return{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}}),app.factory("UIFac",function($http,$q,$location,$window,combatFac){return{getUIObj:function(whichUI,UIStuff){var p=$http.get("/item/"+whichUI).success(function(res){return res});return p},getUIBg:function(which){var UIBgs={Inventory:"../img/UI/inv.jpg",Skills:"",Bestiary:"",Quests:""};return UIBgs[which]},moreInfo:function(el){var addStuff='<ul class="moreInfList">';if(console.log(el),el.slot||0==el.slot){var arType;switch(el.slot){case 0:arType="head";break;case 1:arType="torso";break;case 2:arType="pants";break;case 3:arType="hands";break;case 4:arType="feet";break;default:arType="accessory"}if(addStuff+="<li>Type:"+arType+"</li>",addStuff+="<li>Defense:"+el.def+"</li>",addStuff+="<li>Cost:"+el.cost+" coins</li>",addStuff+="<li>Level:"+el.itemLvl+"</li>",addStuff+="<li>Resistance:",el.res&&el.res.length){addStuff+="<ul>";for(var i=0;i<el.res.length;i++)addStuff+="<li> "+combatFac.getDmgType(el.res[i])+" </li>";addStuff+="</ul>"}else addStuff+="<span> none </span></li>"}else if(el.giver||0===el.giver)$http.get("/item/getGiver/"+el.giver).then(function(res){console.log("results from quest-giver search",res.data[0]),addStuff+="<li>Level:"+el.lvl+"</li>",addStuff+="<li>Given by:"+res.data[0].Name+"</li>",addStuff+="</ul>",$("#moreInf").html(addStuff),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info")});else if(el.energy||0===el.energy)addStuff+="<li>Damage Type:"+combatFac.getDmgType(el.type)+"</li>",addStuff+="<li>Energy:"+el.energy+"</li>",addStuff+=el.heal?"<li>Heal (burst):"+el.heal+" hp</li>":"",addStuff+=el.regen?"<li>Heal (regeneration):"+el.regen+" hp/turn</li>":"",addStuff+=el.burst?"<li>Damage:"+el.burst+" hp</li>":"",addStuff+=el.degen?"<li>Degeneration:"+el.degen+" hp/turn</li>":"",addStuff+=el.stuns?"<li>Stuns</li>":"";else if(el.maxHp)addStuff+="What are you doing? You broke the game!";else if(el.itemLvl||0===el.itemLvl)addStuff+=el.max?"<li>Damage:"+el.min+"-"+el.max+" hp</li>":"",addStuff+=el.def?"<li>Defense:"+el.def+"</li>":"",addStuff+="<li>Level:"+el.itemLvl+"</li>",addStuff+="<li>Cost:"+el.cost+" coins</li>";else if(addStuff+="<li>Level:"+el.lvl+"</li>",addStuff+="<li>Hp:"+el.hp+" hp</li>",addStuff+="<li>Dmg:"+el.min+"-"+el.max+" hp</li>",addStuff+="<li>Damage Type:"+combatFac.getDmgType(el.type)+"</li>",addStuff+="<li>Resistance:",el.res&&el.res.length){addStuff+="<ul>";for(var i=0;i<el.res.length;i++)addStuff+="<li> "+combatFac.getDmgType(el.res[i])+" </li>";addStuff+="</ul>"}else addStuff+="<span> none </span></li>";el.giver||0==el.giver||(addStuff+="</ul>",$("#moreInf").html(addStuff),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info"))},lessInf:function(){$("#moreInf").hide(200),$("div.modal-footer > button.btn.btn-info").html("More info")},saveGame:function(data,lo,rel){$http.post("/user/save",data).then(function(res){lo&&res?$http.get("/logout").then(function(r){window.location.href="./login"}):rel&&res&&$window.location.reload()})},logout:function(usr){bootbox.confirm("<span id='resetWarn'>WARNING:</span> You will lose all progress since your last save! Are you sure you wanna stop playing and log out?",function(r){r&&null!==r&&$http.get("/user/logout").then(function(lo){window.location.href="./login"})})},reset:function(){var addendOne=Math.floor(50*Math.random()),addendTwo=Math.floor(50*Math.random());bootbox.dialog({message:"<span id='resetWarn'>WARNING:</span> Resetting your account is a <i>permanent</i> move. <br/>If you still wish to reset your game account, enter your username and password below, and solve the math question below and click the appropriate button. Be aware that this decision <i>cannot</i> be reversed!<hr/>Username:<input type='text' id='rmun'><br/>Password:<input type='password' id='rmpw'><hr/>Math Check:<br/>"+addendOne+" + "+addendTwo+" = <input type='number' id='mathChk'> ",title:"Reset Account",buttons:{danger:{label:"YES, I would like to reset my account.",className:"btn-danger",callback:function(){return parseInt($("#mathChk").val())==addendOne+addendTwo&&(credObj={name:$("#rmun").val(),pass:$("#rmpw").val()},void $http.post("/user/reset",credObj).then(function(resp){return!!resp&&(window.location.replace("./login"),!0)}))}},main:{label:"NO, I do not wish to reset my account.",className:"btn-primary",callback:function(){return!0}}}})},getRingObjs:function(rNum){var objs;switch(rNum){case 0:objs=[{name:"head",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"chest",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"hands",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"legs",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"feet",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"ring",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 1:objs=[{name:"Change Skill",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Skill Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Attack",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Retreat",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Wait",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Player Status",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 2:objs=[{name:"Current Creature Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"All Creatures Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Search Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Vanquished Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 3:objs=[{name:"Current Side Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Legendary Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Old Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Main Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Stats",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;default:objs=[{name:"Save",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Save and Logout",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Logout without saving",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Reset Account",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Stats",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"About",imgUrl:"",fn:function(){console.log("clicked this!")}}]}var ringData={objs:objs,rot:360/objs.length};return console.log("ring data",ringData),ringData},PlatinumSpinningRings:function(curr,inc){return curr+inc},doPlayerInv:function(stuff,boxes){return $http.get("/item/allItems").then(function(itArr){console.log("BOXES O STUFF",stuff,boxes);for(var itm in stuff)if("gold"!=itm&&"inv"!=itm){for(var fnd=-1,i=0;i<boxes.length;i++)if(boxes[i].name==itm){fnd=i;break}stuff[itm].indexOf(-1)==-1?(console.log("item isnt undefined!",stuff[itm]),boxes[fnd].itName=itArr.data[2][stuff[itm][0]].pre+" "+("weap"==itm?itArr.data[1][stuff[itm][1]].name:itArr.data[0][stuff[itm][1]].name)+" "+itArr.data[2][stuff[itm][2]].post,boxes[fnd].itFullInfo=[itArr.data[2][stuff[itm][0]],"weap"==itm?itArr.data[1][stuff[itm][1]]:itArr.data[0][stuff[itm][1]],itArr.data[2][stuff[itm][2]]]):boxes[fnd].itName="none"}return boxes})},getContMen:function(scp,x,y){return console.log("GOT TO getContMen()"),{x:x,y:y,el:scp.UIEl,num:scp.$index}}}}),app.factory("userFact",function($http){return{checkPwdStr:function(pwd){console.log("password:",pwd);var alphCap=new RegExp("[A-Z]","g"),alphLow=new RegExp("[a-z]","g"),nums=new RegExp("[0-9]","g"),weirds=new RegExp("\\W","g"),pwdStr=0;pwd.search(alphCap)!=-1&&pwdStr++,pwd.search(alphLow)!=-1&&pwdStr++,pwd.search(nums)!=-1&&pwdStr++,pwd.search(weirds)!=-1&&pwdStr++;var len=pwd.length;return len>16?pwdStr+=6:len>11?pwdStr+=4:len>6&&(pwdStr+=2),pwdStr},checkPwdMatch:function(one,two){return one==two},checkName:function(name){return console.log("NAME TO BACKEND",name),$http.get("/user/nameOkay/"+name).then(function(nameRes){return console.log("NAME RESPONSE:",nameRes.data),"okay"!=nameRes.data})},login:function(creds){return console.log("credentials in factory",creds),$http.post("/user/login",creds).then(function(logRes){return console.log("response from backend:",logRes),"yes"==logRes.data})},checkLogin:function(){return $http.get("/user/chkLog").then(function(chkLog){return console.log("CHECKLOG RESULTS",chkLog),chkLog.data})}}});