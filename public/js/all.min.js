var app=angular.module("mazeGame",[]).controller("maze-con",function($scope,$http,$q,$interval,combatFac,UIFac){$scope.width=6,$scope.height=6,$scope.path=[],$scope.backtraceNum,$scope.currCell,$scope.bombsLeft=5,$scope.cellsDone=0,$scope.moveReady=!1,$scope.cells=[],$scope.invActive=!1,$scope.setActive=!1,$scope.intTarg,$scope.playerItems=[],$scope.possRoomConts=["loot","mons","npcs","jewl"," ","exit"," "," ","mons","mons"],$scope.cell=function(id,cont){this.id=id,this.x=id.split("-")[0],this.y=id.split("-")[1],this.east=!0,this.west=!0,this.north=!0,this.south=!0,this.visited=!1,this.pViz=!1,this.has=cont},$scope.dmgType=combatFac.getDmgType,$scope.cell.prototype.dig=function(dir,newCell){switch(console.log("Digging in direction",dir,"from old cell",this,"to new cell",newCell),dir){case"n":this.north=!1,newCell.south=!1;break;case"e":this.east=!1,newCell.west=!1;break;case"s":this.south=!1,newCell.north=!1;break;default:this.west=!1,newCell.east=!1}console.log("After excavation in direction",dir,"from old cell",this,"to new cell",newCell)},$scope.cell.prototype.checkCell=function(dir){var posArr=this.id.split("-"),x=parseInt(posArr[0]),y=parseInt(posArr[1]);switch(dir){case"n":y--;break;case"e":x++;break;case"s":y++;break;default:x--}var newCellName=x+"-"+y,pos=$scope.cellNames.indexOf(newCellName);return-1==pos?"e":$scope.cells[pos].visited?"v":newCellName},$scope.cellNames=[],$scope.makeMaze=function(){$scope.cells=[],$scope.cellNames=[],$scope.path=[],$scope.cellsDone=0,$scope.bombsLeft=5,console.log("Generating maze of dimensions",$scope.width,":",$scope.height);for(var x=0;x<$scope.width;x++)for(var y=0;y<$scope.height;y++){var rItem=$scope.possRoomConts[Math.floor(Math.random()*$scope.possRoomConts.length)];"exit"==rItem&&(console.log("room has exit"),$scope.possRoomConts.splice(5,1)),$scope.cells.push(new $scope.cell(x+"-"+y,rItem)),$scope.cellNames.push(x+"-"+y)}for(console.log("cells:",$scope.cells),$scope.currCell="0-0";$scope.cellsDone<$scope.cellNames.length;){$scope.path.push($scope.currCell);for(var targDir,posDirs=["n","e","s","w"],pos=$scope.cellNames.indexOf($scope.currCell),good=!1;!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=$scope.cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1));if($scope.cells[pos].visited=!0,good||(good=$scope.backTrace()),!good)break;$scope.currCell;$scope.currCell=good;var newPos=$scope.cellNames.indexOf($scope.currCell);$scope.cells[pos].dig(posDirs[targDir],$scope.cells[newPos]),console.log("Cell is now",$scope.currCell),$scope.cellsDone++}$scope.moveReady=!0,$scope.playerCell="0-0",$scope.popCells()},$scope.popCells=function(){$scope.cells.forEach(function(cel){"mons"==cel.has&&$http.get("/getRanMons/"+cel.id).then(function(res){console.log("This room contains an enemy:",res.data.mons),$scope.cells[$scope.cellNames.indexOf(res.data.cell)].has=res.data.mons})})},$scope.compareCell=function(id){return id==$scope.playerCell},$scope.backTrace=function(){for(var good=!1;!good;){if($scope.path.pop(),!$scope.path.length)return!1;$scope.currCell=$scope.path[$scope.path.length-1];for(var targDir,posDirs=["n","e","s","w"],pos=$scope.cellNames.indexOf($scope.currCell);!good&&posDirs.length;)targDir=Math.floor(Math.random()*posDirs.length),good=$scope.cells[pos].checkCell(posDirs[targDir]),"e"!=good&&"v"!=good||(good=!1,posDirs.splice(targDir,1))}return good},$scope.Inventory=[],$scope.Skills=[],$scope.Bestiary=[],$scope.Quests=[],$scope.currUINum=0,$scope.UIPans=["Inventory","Skills","Bestiary","Quests"],$scope.currUIObjs=[],$scope.currUIBg="../img/UI/inv.jpg",$scope.currUIPan=$scope.UIPans[$scope.currUINum],$scope.chInv=function(dir){console.log(dir,$scope.currUINum),!dir&&$scope.currUINum>0?$scope.currUINum--:dir?1==dir&&$scope.currUINum<$scope.UIPans.length-1?$scope.currUINum++:1==dir&&($scope.currUINum=0):$scope.currUINum=$scope.UIPans.length-1,$scope.currUIPan=$scope.UIPans[$scope.currUINum],console.log(UIFac,UIFac.getUIObj),UIFac.getUIObj($scope.currUIPan,$scope[$scope.currUIPan]).then(function(uiRes){$scope.currUIObjs=uiRes.data,console.log("UI OBJS:",$scope.currUIObjs)}),$scope.currUIBg=UIFac.getUIBg($scope.currUIPan)},$scope.chInv(-1),$scope.bombOn=!1,$scope.roomRot=0,$scope.playerFacing=0,window.onkeydown=function(e){if($scope.moveReady){var currCell=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)],x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],dir="north";dir=$scope.playerFacing<45||$scope.playerFacing>315?"north":$scope.playerFacing>=45&&$scope.playerFacing<135?"west":$scope.playerFacing>=225&&$scope.playerFacing<315?"east":"south";var isMoveKey=!1,canMove=!1;if(87==e.which||38==e.which&&!$scope.moving){if(isMoveKey=!0,canMove=!1,currCell[dir]?$scope.bombOn&&(canMove=!0,$scope.bomb(dir),$scope.bombsLeft--):canMove=!0,canMove)switch(dir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}console.log("Attempting to move",dir)}else if(83==e.which||40==e.which&&!$scope.moving){isMoveKey=!0;var revDir;switch(dir){case"north":revDir="south";break;case"south":revDir="north";break;case"east":revDir="west";break;default:revDir="east"}if(canMove=!1,currCell[revDir]?$scope.bombOn&&(canMove=!0,$scope.bomb(revDir),$scope.bombsLeft--):canMove=!0,canMove)switch(revDir){case"north":y--;break;case"south":y++;break;case"east":x++;break;default:x--}}else 68==e.which||39==e.which?(isMoveKey=!0,$scope.roomRot-=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):65==e.which||37==e.which?(isMoveKey=!0,$scope.roomRot+=5,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360):66==e.which&&$scope.bombsLeft&&!$scope.bombOn?$scope.bombOn=!0:66==e.which&&$scope.bombOn?$scope.bombOn=!1:82==e.which?$scope.rotOn=!$scope.rotOn:73==e.which?(console.log("i pressed and damage type 3 is",combatFac.getDmgType(3)),$scope.invActive=!$scope.invActive):192==e.which&&($scope.setActive=!$scope.setActive);isMoveKey&&e.preventDefault(),$scope.playerCell=x+"-"+y,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].pViz=!0,console.log("CURRENT ROOM CONTENTS:",$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has),$scope.intTarg="object"==typeof $scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has?$scope.cells[$scope.cellNames.indexOf($scope.playerCell)].has:!1,$scope.$digest(),87!=e.which&&38!=e.which&&83!=e.which&&40!=e.which||!canMove||$scope.moving||$scope.moveAni()}},$scope.moving=!1,$scope.moveAni=function(){$scope.moving=!0,$("body").fadeOut(500,function(){$("body").fadeIn(500,function(){$scope.moving=!1})})},$scope.turnSpeed=0,window.onmousemove=function(e){$scope.rotOn&&($scope.vertRot=70*(e.y||e.clientY)/$(window).height()+55),$scope.$digest();var horiz=(e.x||e.clientX)/$(window).width();if(Math.abs(horiz-.5)>.3){var lOrR=horiz>.5?-1:1,turnVal=(Math.abs(horiz-.5)-.3)/.2;$scope.turnSpeed=6*lOrR*turnVal/1.5}else $scope.turnSpeed=0},$scope.mouseTurnTimer=$interval(function(){$scope.roomRot+=$scope.turnSpeed,$scope.playerFacing=$scope.roomRot%360>0?$scope.roomRot%360:360+$scope.roomRot%360},50),$scope.bomb=function(dir){var x=$scope.playerCell.split("-")[0],y=$scope.playerCell.split("-")[1],otherDir="";switch(dir){case"north":y--,otherDir="south";break;case"east":x++,otherDir="west";break;case"south":y++,otherDir="north";break;default:x--,otherDir="east"}var bombInCell=x+"-"+y;$scope.cells[$scope.cellNames.indexOf(bombInCell)][otherDir]=!1,$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]=!1,$scope.bombOn=!1},$scope.rotOn=!0,$scope.vertRot=85,$scope.getWallStatus=function(dir){var roomWall=$scope.cells[$scope.cellNames.indexOf($scope.playerCell)][dir]?"./img/wall.jpg":"./img/door.jpg";return roomWall},$scope.makeMaze(),console.log("UI",document.querySelector("#uiloader")),$("#uiloader").draggable({constrain:"body"})});app.factory("combatFac",function($http){var dmgTypes=["Physical","Fire","Ice","Poison","Dark","Holy"];return{getDmgType:function(typeNum){return dmgTypes[parseInt(typeNum)]}}}),app.factory("mazeFac",function($http){return{}}),app.factory("UIFac",function($http,$q){return{getUIObj:function(whichUI,UIStuff){var p=$http.get("/"+whichUI).success(function(res){return res});return p},getUIBg:function(which){var UIBgs={Inventory:"../img/UI/inv.jpg",Skills:"",Bestiary:"",Quests:""};return UIBgs[which]},sendUserUI:function(which){var p=$http.get("/user/"+whichUI).success(function(res){return res});return p}}});