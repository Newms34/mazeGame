"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},app=angular.module("mazeGame",["ngTouch"]).controller("log-con",["$scope","$http","$q","$timeout","$window","userFact","musFac",function(e,t,n,o,a,r,l){e.hazLogd=!1,e.musOn=!0,e.user={prof:"0"},l.createMus(),e.toggleMus=function(){l.toggleMus(),e.musOn=!e.musOn},l.getMusic("intro"),e.profDescs=[{name:"Warrior",txt:"What they lack in magical apptitude, warriors more than make up for in their martial expertise. The warrior uses their weapon training to bring swift and steely death to their foes",img:"./img/assets/war.jpg",ico:"./img/assets/warPick.png",skill:"Berserker's Precision - Your martial training allows you to make more devastating attacks. Chance to cause degen to stunned foes, or stun to degening foes."},{name:"Sorcerer",txt:"The scholarly sorcerer uses their extensive knowledge of the arcane to obliterate their enemies with magical fire, or hinder them with conjured ice and blizzards.",img:"./img/assets/sorc.jpg",ico:"./img/assets/sorcPick.png",skill:"Elemental Boon - By channeling more into your spells, you can renew yourself or devastate your enemies. Chance to grant additional regen or degen. Based on level."},{name:"Paladin",txt:"The holy paladins are bastions of the Holy Ones. Using their faith both offensively as a shield and defensively as a weapon, they can both smite their enemies and renew themselves.",img:"./img/assets/paly.jpg",ico:"./img/assets/palyPick.png",skill:"Redemption - The paladin's fortitude gives them a chance to reflect the enemy's damage back at them. Chance to reflect enemy damage. Based on level."},{name:"Necromancer",txt:'Masters of the so-called "dark" arts, the necromancers are an oft-maligned lot. However, no one would deny their power - or their usefulness - in turning the minds and even fallen bodies of their foes against them.',img:"./img/assets/necro.jpg",ico:"./img/assets/necroPick.png",skill:"Soul Siphon - Calling on some really dark stuff, you rend part of your enemy's life force. Chance to steal some health on attack. Based on level."}],e.newUsr=function(){if(e.regForm.pwd.$viewValue!=e.regForm.pwdTwo.$viewValue)sandalchest.alert("Your passwords don&rsquo;t match!",function(){});else{var n={user:e.regForm.username.$viewValue,password:e.regForm.pwd.$viewValue,prof:e.user.prof+1};console.log("userInf",n),t.post("/user/new",n).then(function(t){"saved!"==t.data&&e.login(!0)})}},e.passMatch=!0,e.passStr=0,e.isNew=!1,e.checkPwdStr=function(){e.regForm.pwd.$viewValue&&(e.passStr=r.checkPwdStr(e.regForm.pwd.$viewValue)),console.log("pwd strength",e.passStr)},e.checkPwds=function(){e.passMatch=r.checkPwdMatch(e.regForm.pwd.$viewValue,e.regForm.pwdTwo.$viewValue)},e.dupName=!1,e.nameCheck=function(){var t=e.regForm.username.$viewValue;console.log("userFact",r.checkName,"name",t),r.checkName(t).then(function(t){e.dupName=t})},e.login=function(t){t?r.login({name:e.regForm.username.$viewValue,pwd:e.regForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):sandalchest.alert("Either your username or password is not correct!")}):r.login({name:e.logForm.username.$viewValue,pwd:e.logForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):sandalchest.alert("Either your username or password is not correct!")})},e.play=function(){a.location.href="./"},e.passInf=function(){sandalchest.alert('<h3>Password Strength</h3><hr/>Here are a few things to include for a stronger password:<ul><li>A lowercase letter</li><li>An uppercase letter</li><li>A number</li><li>A non alpha-numeric symbol (something like "@" or "$")</li></ul>Longer passwords are also generally better!')},e.upd=[],e.getNews=function(){t.get("/other/news").then(function(t){e.upd=t.data.split(/[\n\r]/)})},e.getNews(),e.parseInt=parseInt}]),socket=io();app.controller("maze-con",["$scope","$http","$q","$interval","$timeout","$window","mazeFac","combatFac","UIFac","userFact","econFac","musFac",function(e,t,n,o,a,r,l,s,i,c,u,m){e.width=6,e.height=6,e.path=[],e.backtraceNum,e.currCell,e.bombsLeft=5,e.cellsDone=0,e.moveReady=!1,e.cells=[],e.cellNames=[],e.invActive=!1,e.setActive=!1,e.intTarg,e.lvl=1,e.playerLvl=1,e.playerItems=[],e.questList=[],e.doneQuest=[],e.maxHp=0,e.currHp=0,e.foggy=!0,e.maxEn=0,e.currEn=0,e.isStunned=!1,e.inCombat=!1,e.merchy={},e.beastLib=[],e.turnSpeed=0,e.name="",e.currSkillNum=0,m.createMus(),e.toggleMus=function(){m.toggleMus(),e.musOn=!e.musOn},e.hCent=($(window).width()-1e3)/2,m.getMusic("general"),e.uName="",(e.checkPhone=function(){var e=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(e=!0),e?r.location.href="./mobile":c.checkLogin().then(function(e){console.log("RESPONSE FROM CHECK LOGIN:",e),e||(r.location.href="./login")})})(),e.goVote=function(){sandalchest.dialog("Voting ","Wanna submit your own ideas or vote on other user&rsquo;s ideas? Vote for them by clicking below!<hr><i>Warning!:</i> This will reset your current level progress!",{buttons:[{text:"&#9745; Go Vote!",close:!1,click:function(){r.location.href="./votes"}},{text:"&#9744; Nevermind",close:!0}]})},e.fillCells=function(){console.log("cells:",e.cells);for(var t=[],o=[],a=[],r=[],s=0;s<e.cells.length;s++)"mons"==e.cells[s].has?t.push(l.popCell(e.lvl,e.cells[s].id)):"npcs"==e.cells[s].has&&(console.log(e.cells[s].id,"has an npc."),o.push(u.getNpc(e.cells[s].id)));n.all(t).then(function(t){t.forEach(function(t){e.cells[e.cellNames.indexOf(t.cell)].has=t.mons})}),n.all(o).then(function(t){t.forEach(function(t){console.log("DATA INTO PROMPMERCINVS",t),e.cells[e.cellNames.indexOf(t.id)].has=t.data,t.data.isMerch&&1==t.data.isMerch&&a.push(u.merchInv(t.data.inv,t.id))}),n.all(a).then(function(t){t.forEach(function(t){console.log("INV",t),e.cells[e.cellNames.indexOf(t.id)].has.inv=t.inv,r.push(u.getQuests(e.name,t.id,e.lvl))}),n.all(r).then(function(t){console.log(t),t.forEach(function(t){e.cells[e.cellNames.indexOf(t.id)].has.quest=t.q,console.log("NPC HAS QUEST:",t.q,t.id)});var n={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}};i.saveGame(n,!1,!1)})})})},e.doMaze=function(t,n){var o=l.makeMaze(t,n);e.cells=o.cells,e.path=o.path,e.cellNames=o.names,e.bombsLeft=5,e.moveReady=!0,e.playerCell="0-0",e.fillCells()},e.getUsrData=function(){t.get("/user/currUsrData").then(function(t){console.log("CURR USR DATA","undefined"==typeof t?"undefined":_typeof(t),t),e.playerItems=t.data.equip,e.lvl=t.data.lvl,e.questList=t.data.inProg,e.doneQuest=t.data.questDone,e.maxHp=t.data.maxHp,e.currHp=t.data.currHp,e.maxEn=t.data.maxEn,e.currEn=t.data.currEn,e.isStunned=t.data.isStunned,e.name=t.data.name,e.playerLvl=t.data.playerLvl||1,e.currXp=t.data.currLvlXp||0,e.playerSkills=t.data.skills,e.extraSkillPts=t.data.skillPts||0,e.prof=t.data.prof||1,e.beastLib=t.data.mons,u.merchInv(e.playerItems.inv).then(function(n){for(var o=0;o<n.length;o++)console.log("REPLACING",e.playerItems.inv[o].item,"WITH",n[o]),e.playerItems.inv[o].item=n[o];localStorage.mazeGameReset&&"true"==localStorage.mazeGameReset.toString()||!t.data.currentLevel||!t.data.currentLevel.loc||null==t.data.currentLevel.loc||""==t.data.currentLevel.loc?(console.log("User does not already have level data saved!"),localStorage.removeItem("mazeGameReset"),e.doMaze(e.width,e.height)):(console.log("User DOES have current level data! Reloading!",t.data),e.cells=t.data.currentLevel.data,e.cellNames=t.data.currentLevel.names,e.playerCell=t.data.currentLevel.loc,e.moveReady=!0,e.$digest()),e.popInv()})})},e.getUsrData(),e.getInvName=function(e){var t="";return e.item?(e.item.name?t=e.item.name:e.item.length&&e.item instanceof Array&&e.item.length>2&&(t=e.item[0].pre+" "+e.item[1].name+" "+e.item[2].post),t):"ERROR!"},e.dmgType=s.getDmgType,e.compareCell=function(t){return t==e.playerCell},e.surroundCells=function(t){var n=t.id.split("-"),o=e.playerCell.split("-"),a="";return n[0]-o[0]==-1&&n[1]-o[1]==-1?a="fog-TL":n[0]-o[0]==0&&n[1]-o[1]==-1?a="fog-TC":n[0]-o[0]==1&&n[1]-o[1]==-1?a="fog-TR":n[0]-o[0]==-1&&n[1]-o[1]==0?a="fog-CL":n[0]-o[0]==1&&n[1]-o[1]==0?a="fog-CR":n[0]-o[0]==-1&&n[1]-o[1]==1?a="fog-BL":n[0]-o[0]==0&&n[1]-o[1]==1?a="fog-BC":n[0]-o[0]==1&&n[1]-o[1]==1&&(a="fog-BR"),(""==a&&(Math.abs(n[0]-o[0])>1||Math.abs(n[1]-o[1])>1)||"fog-TL"==a&&(t.south||t.east)||"fog-TC"==a&&t.south||"fog-TR"==a&&(t.south||t.west)||"fog-CL"==a&&t.east||"fog-CR"==a&&t.west||"fog-BL"==a&&(t.north||t.east)||"fog-BC"==a&&t.north||"fog-BR"==a&&(t.north||t.west))&&(a="fog-FF"),a},e.bodyBoxes=[{name:"head",x:81,y:1,imgUrl:"./img/UI/head.jpg"},{name:"chest",x:80,y:115,imgUrl:"./img/UI/chest.jpg"},{name:"legs",x:82,y:361,imgUrl:"./img/UI/legs.jpg"},{name:"hands",x:1,y:285,imgUrl:"./img/UI/hands.jpg"},{name:"feet",x:79,y:510,imgUrl:"./img/UI/feet.jpg"},{name:"weap",x:158,y:284,imgUrl:"./img/UI/weap.jpg"}],e.Skills=[],e.Bestiary=[],e.Quests=[],e.currUINum=0,e.UIPans=["Inventory","Skills","Bestiary","Quests","Menu"],e.currUIObjs=[],e.currUIBg="../img/UI/inv.jpg",e.currUIPan=e.UIPans[e.currUINum],e.popInv=function(){var t={lvl:e.playerLvl,done:e.doneQuest,inProg:e.questList,items:e.playerItems,xp:e.currXp,skills:e.playerSkills,chains:[]};i.getAllUIs(t).then(function(t){e.playerSkills=t.skills,e.playerItems=t.items,e.skillChains=t.chains,e.fullSkills=t.skillsReal,e.inCombat&&angular.element("#combat-box").scope().comb.monsTurn()})},e.log2=function(e){return Math.log2(e)},e.skillPntrCalcs=function(e,t){var n=180-180*Math.atan(105*(t>0&&t%2?e-1:e)/95)/Math.PI,o=95/(2*Math.cos(Math.atan(105*(t>0&&t%2?e-1:e)/95)));return 1==t&&(n=180,o=45),{ang:n,ht:o}},e.didSkills=!1,e.currMons=0,e.adjBeast=function(t){console.log("DIR",t,"MONS",e.currMons),t&&e.currMons<e.currUIObjs.length-2?e.currMons+=2:e.currMons>1&&(console.log("goin backwards"),e.currMons-=2),e.$digest()},e.chInv=function(t){if(!t&&e.currUINum>0?e.currUINum--:t?1==t&&e.currUINum<e.UIPans.length-1?e.currUINum++:1==t&&(e.currUINum=0):e.currUINum=e.UIPans.length-1,e.currUIPan=e.UIPans[e.currUINum],"Menu"!==e.currUIPan&&"Inventory"!==e.currUIPan&&"Skills"!==e.currUIPan)i.getUIObj(e.currUIPan,e[e.currUIPan]).then(function(t){e.currUIObjs=t.data,"Bestiary"==e.currUIPan&&(e.currUIObjs.forEach(function(e){e.imgUrl="/img"+e.imgUrl}),e.currUIObjs=e.currUIObjs.filter(function(t){return!t.quest&&e.beastLib.indexOf(t._id)>-1}),e.currMons=0,e.$apply())});else if("Inventory"==e.currUIPan)i.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv});else if("Skills"==e.currUIPan||!e.didSkills){var n={lvl:e.playerLvl,done:e.doneQuest,inProg:e.questList,items:e.playerItems,xp:e.currXp,skills:e.playerSkills,chains:[]};i.getAllUIs(n).then(function(t){e.skillChains=t.chains,console.log("chains",t.chains),e.$digest()})}e.currUIBg=i.getUIBg(e.currUIPan)},e.chInv(0),e.bombOn=!1,e.roomRot=0,e.playerFacing=0,window.onkeydown=function(t){if(e.moveReady&&73!==t.which){var n=e.cells[e.cellNames.indexOf(e.playerCell)],o=e.playerCell.split("-")[0],a=e.playerCell.split("-")[1],r="north";r=e.playerFacing<45||e.playerFacing>315?"north":e.playerFacing>=45&&e.playerFacing<135?"west":e.playerFacing>=225&&e.playerFacing<315?"east":"south";var l=!1,c=!1;if(87==t.which||38==t.which&&!e.moving){if(l=!0,c=!1,n[r]?e.bombOn&&(c=!0,e.bomb(r),e.bombsLeft--):c=!0,c)switch(r){case"north":a--;break;case"south":a++;break;case"east":o++;break;default:o--}console.log("Attempting to move",r)}else if(83==t.which||40==t.which&&!e.moving){l=!0;var u;switch(r){case"north":u="south";break;case"south":u="north";break;case"east":u="west";break;default:u="east"}if(c=!1,n[u]?e.bombOn&&(c=!0,e.bomb(u),e.bombsLeft--):c=!0,c)switch(u){case"north":a--;break;case"south":a++;break;case"east":o++;break;default:o--}}else 68==t.which||39==t.which?(l=!0,e.roomRot-=5,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360):65==t.which||37==t.which?(l=!0,e.roomRot+=5,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360):66==t.which&&e.bombsLeft&&!e.bombOn?e.bombOn=!0:66==t.which&&e.bombOn?e.bombOn=!1:82==t.which?e.rotOn=!e.rotOn:192==t.which&&(e.setActive=!e.setActive);l&&t.preventDefault(),87!=t.which&&38!=t.which&&83!=t.which&&40!=t.which||!c||e.moving||(e.oldCell=e.playerCell,e.playerCell=o+"-"+a,e.cells[e.cellNames.indexOf(e.playerCell)].pViz=!0,e.intTarg="object"==_typeof(e.cells[e.cellNames.indexOf(e.playerCell)].has)&&!e.cells[e.cellNames.indexOf(e.playerCell)].has.inv&&e.cells[e.cellNames.indexOf(e.playerCell)].has,e.intTarg&&(console.log("cell cons (probly mons):",e.intTarg),e.moveReady=!1,e.inCombat=!0,m.getMusic("battle"),i.saveGame({name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}}),s.combatReady()),"object"==_typeof(e.cells[e.cellNames.indexOf(e.playerCell)].has)&&e.cells[e.cellNames.indexOf(e.playerCell)].has.inv?(e.currNpc=e.cells[e.cellNames.indexOf(e.playerCell)].has,e.merchy.prepNpc(),e.isNearMerch=e.cells[e.cellNames.indexOf(e.playerCell)].has.inv):e.currNpc=null,e.$digest(),e.moveAni())}else 73==t.which&&(console.log("key i was pressed"),e.invActive=!e.invActive,e.invActive?e.moveReady=!1:e.moveReady=!0,e.$digest())},e.moving=!1,e.moveAni=function(t){e.moving=!0,$("body").fadeOut(500,function(){$("body").fadeIn(500,function(){if(e.moving=!1,t&&0!==t){e.lvl++;var n={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:"",data:[],names:[]}};console.log("new lvl!:",e.lvl),i.saveGame(n,!1,!0)}})})},window.onmousemove=function(t){e.$digest();var n=(t.x||t.clientX)/$(window).width();if(Math.abs(n-.5)>.3){var o=n>.5?-1:1,a=(Math.abs(n-.5)-.3)/.2;e.turnSpeed=6*o*a/1.5}else e.turnSpeed=0},e.mouseTurnTimer=o(function(){e.roomRot+=e.turnSpeed,e.playerFacing=e.roomRot%360>0?e.roomRot%360:360+e.roomRot%360},50),e.threedeerooms=["north","south","east","west"],e.bomb=function(t){var n=e.playerCell.split("-")[0],o=e.playerCell.split("-")[1],a="";switch(t){case"north":o--,a="south";break;case"east":n++,a="west";break;case"south":o++,a="north";break;default:n--,a="east"}var r=n+"-"+o;e.cells[e.cellNames.indexOf(r)][a]=!1,e.cells[e.cellNames.indexOf(e.playerCell)][t]=!1,e.bombOn=!1},e.rotOn=!0,e.vertRot=5,e.getWallStatus=function(t){return!(e.cells[e.cellNames.indexOf(e.playerCell)]&&e.cells[e.cellNames.indexOf(e.playerCell)][t])},e.isExit=function(){return"exit"==e.cells[e.cellNames.indexOf(e.playerCell)].has},e.noMove=function(e){e.stopPropagation()},e.floorCursor=function(){return"exit"==e.cells[e.cellNames.indexOf(e.playerCell)].has?"pointer":"auto"},$("#uiloader").draggable({constrain:"body"}),e.inpPhone=function(){e.moveReady=!1,sandalchest.prompt("Enter a name (you get this by visiting the site on your phone)!",function(t){null!==t&&" "!=t&&socket.emit("chkName",{n:t}),e.moveReady=!0})},socket.on("chkNameRes",function(t){t.n&&(e.uName=t.n),console.log("Name:",t.n)}),e.travelOkay=!0,e.phoneMovTimer,socket.on("movOut",function(t){if(t.n==e.uName){var n=null,o=null;"l"==t.x?(n=new Event("keydown"),n.which=65,window.onkeydown(n)):"r"==t.x&&(n=new Event("keydown"),n.which=68,window.onkeydown(n)),"f"==t.y&&e.travelOkay?(o=new Event("keydown"),o.which=87,window.onkeydown(o),e.travelOkay=!1,e.phoneMovTimer=a(function(){e.travelOkay=!0},1e3)):"b"==t.y&&e.travelOkay&&(o=new Event("keydown"),o.which=83,window.onkeydown(o),e.travelOkay=!1,e.phoneMovTimer=a(function(){e.travelOkay=!0},1e3))}}),e.getUIInfo=function(e){var t;console.log("getUIInfo:",e),t=e.item&&e.item.length&&e.item.length>2?e.item[0].pre+" "+e.item[1].name+" "+e.item[2].post:e.name&&e.desc?e.name:e.item[0].name;var n;n=e.item&&e.item.length&&e.item.length>2?e.item[1].desc+"<br/>"+e.item[0].description+"<br/>"+e.item[2].description:e.name&&e.desc?e.desc:e.item[0].desc,sandalchest.dialog("<h3>"+t+"</h3>","<p>"+n+'</p><p id="moreInf" style="display:none;"></p>',{buttons:[{text:"Close",close:!0},{text:"More Info",close:!1,click:function(){return"none"==$("#moreInf").css("display")?i.moreInfo(e):i.lessInf(),!1}}]})},e.skillPurchUI=function(t,n){var o="<h3>"+t.name+"</h3>",a="<p>"+t.desc+'<p id="moreInf" style="display:none;"></p><hr/><table class="table"><tr><td>This skill costs:</td><td>'+t.skillPts+" pts</td></tr><tr><td>You have:</td><td>"+e.extraSkillPts+" pts</td></tr></table>",r={},l=["Nevermind","Okay","I knew that...","Next time, then.","I&rsquo;ll return!","Another time, then."],s=["Gimme that!","Do it!","I want that!","Okay!","Buy it!","Heck yes!"],c=["Nevermind","On second thought...","Cancel","Actually, nah.","Nah","Heck no!"];n?(a+="You already own this skill!",r.buttons=[{text:l[Math.floor(Math.random()*l.length)],close:!0},{text:"More Info",close:!1,click:function(){return"none"==$("#moreInf").css("display")?i.moreInfo(t):i.lessInf(),!1}}]):!n&&t.skillPts>e.extraSkillPts?(a+="You cannot afford this skill!",r.buttons=[{text:l[Math.floor(Math.random()*l.length)],close:!0},{text:"More Info",close:!1,click:function(){return"none"==$("#moreInf").css("display")?i.moreInfo(t):i.lessInf(),!1}}]):(a+="Are you sure you want to purchase this skill?",r.buttons=[{text:s[Math.floor(Math.random()*s.length)],close:!0,click:function(){i.buySkill(t,e.name).then(function(n){if(n)return console.log("Bought skill",t.name),e.getUsrData(),!0})}},{text:c[Math.floor(Math.random()*c.length)],close:!0},{text:"More Info",close:!1,click:function(){return"none"==$("#moreInf").css("display")?i.moreInfo(t):i.lessInf(),!1}}]),console.log(o,a,r),sandalchest.dialog(o,a,r)},e.levelDown=function(){sandalchest.confirm("Ready to go to the next level?",function(t){t&&null!==t&&e.moveAni(1)})},e.saveGame=function(t){var n={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}};console.log("save data to ui fac:",n),i.saveGame(n,!1,t)},e.saveAndLogout=function(){var t={name:e.name,lvl:e.lvl,equip:e.playerItems,questDone:e.questList||[],inProf:e.doneQuest,maxHp:e.maxHp,currHp:e.currHp,maxEn:e.maxEn,currEn:e.currEn,isStunned:e.isStunned,currentLevel:{loc:e.playerCell,data:e.cells,names:e.cellNames}};i.saveGame(t,!0,!1)},e.logout=i.logout,e.reset=i.reset,e.resetLevel=function(){sandalchest.confirm("Reset Level","Are you sure you want to reset this level? Doing so will re-randomize the level!",function(e){e&&(localStorage.mazeGameReset=!0,r.location.reload())})},e.trunc=function(e){return Math.floor(10*e)/10},e.isNearMerch=!1,e.equipItem=function(t,n){if(2==t.lootType)return void alert("JUNK REWARD");console.log("EL",t);var o=t.item&&t.item[1]&&"undefined"!=typeof t.item[1].slot?t.item[1].slot:-1;if(t.item&&t.item.length>2&&o!=-1);else{if(!(t.item&&t.item.length>2))return;o=5}var a=angular.copy(e.bodyBoxes[o]),r={lootType:"weap"==a.name?1:0,item:angular.copy(a.itFullInfo),num:1};e.bodyBoxes[o].itFullInfo=t.item,e.bodyBoxes[o].itName=e.bodyBoxes[o].itFullInfo[0].pre+" "+e.bodyBoxes[o].itFullInfo[1].name+" "+e.bodyBoxes[o].itFullInfo[2].post,console.log("LOCATOR",o,"NAME:",e.bodyBoxes[o].name,"FROM",e.bodyBoxes[o],"TO",e.playerItems[e.bodyBoxes[o].name],"OLD ITEM:",a);for(var l=0;l<e.playerItems[e.bodyBoxes[o].name].length;l++)e.playerItems[e.bodyBoxes[o].name][l]=e.bodyBoxes[o].itFullInfo[l].num;e.playerItems.inv.splice(n,1);"undefined"!=typeof r.item&&e.playerItems.inv.push(r),i.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv})},e.contMenOn=!1,window.oncontextmenu=function(t){"Inventory"==e.currUIPan&&"currUIEl ng-binding ng-scope"==t.target.className&&(t.preventDefault(),t.stopPropagation(),e.contMenOn=i.getContMen(angular.element(t.target).scope(),t.x,t.y),e.$apply())},window.onclick=function(t){console.log(t.target,t.target.id,"contexMen"==t.target.id),t.button&&0!==t.button||"contexMen"==t.target.id||(e.contMenOn=!1)},e.trashItem=function(t,n){sandalchest.confirm("Are you sure you wish to destroy this "+(t.item.length>1?t.item[0].pre+" "+t.item[1].name+" "+t.item[2].post:t.item[0].name)+"?",function(o){console.log("RES",o,t.name),o&&null!==o&&(e.playerItems.inv.splice(n,1),i.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv}))})}}]),app.controller("mob-con",["$scope","$http","$q","$interval","$swipe","$window","UIFac",function(e,t,n,o,a,r,l){e.currRotX=0,e.currRotY=0,e.rotX=null,e.rotY=null,e.uName="retrieving...",e.uiOpts=["Inventory","Skills","Bestiary","Quests","Menu"],e.prevUI="Quests",e.currUI="Menu",e.nextUI="Inventory",e.uiObjs=[],e.getUn=function(){var t=String.fromCharCode(65+Math.floor(25*Math.random())),n=String.fromCharCode(65+Math.floor(25*Math.random()));$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+t+"&cmlimit=500&cmtitle=Category:Nouns",success:function(t){for(var o=" ";o.indexOf(" ")!=-1;)o=t.query.categorymembers[Math.floor(Math.random()*t.query.categorymembers.length)].title;console.log("final noun:",o),$.ajax({dataType:"jsonp",url:"https://simple.wiktionary.org/w/api.php?action=query&list=categorymembers&format=json&cmsort=sortkey&cmstartsortkeyprefix="+n+"&cmlimit=500&cmtitle=Category:Adjectives",success:function(t){for(var n=" ";n.indexOf(" ")!=-1;)n=t.query.categorymembers[Math.floor(Math.random()*t.query.categorymembers.length)].title;e.uName=n.toLowerCase()+" "+o.toLowerCase(),e.movObj.n=e.uName,socket.emit("movData",e.movObj),e.$digest()}})}})},e.getUn(),e.sendMove=o(function(){"retrieving..."!=e.uName&&e.isMoving&&socket.emit("movData",e.movObj)},75),e.isMoving=!1,e.movObj={x:e.rotX,y:e.rotY,n:null},r.addEventListener("deviceorientation",function(t){if("retrieving..."!=e.uName){var n=Math.floor(t.gamma/90*120),o=Math.floor(t.beta/90*120);e.isMoving=!1,n>50?(e.rotX="r",e.isMoving=!0):n<-50?(e.rotX="l",e.isMoving=!0):e.rotX=null,o<-35?(e.rotY="f",e.isMoving=!0):o>35?(e.rotY="b",e.isMoving=!0):e.rotY=null,e.movObj={x:e.rotX,y:e.rotY,n:e.uName}}}),e.ringSize=275,e.currRingRot=0,e.rngChTimer,e.rngChOkay=!0,e.ringChAni=function(t,n){if(!e.rngChOkay)return!1;if([].slice.call($(".RingUIEl")).length)$(".RingUIEl").animate({transform:"rotateY(0deg) translateZ("+e.ringSize+"px);"},{duration:500,complete:function(){e.currUI=e.uiOpts[t],console.log("switched from",e.uiOpts[n],"to",e.uiOpts[t]),t<n?(e.nextUI=e.uiOpts[n],n?e.prevUI=e.uiOpts[n-1]:e.prevUI=e.uiOpts[e.uiOpts.length-1]):(e.prevUI=e.uiOpts[n],t<e.uiOpts.length-2?e.nextUI=e.uiOpts[t+1]:e.nextUI=e.uiOpts[0]),console.log("NEW UI OBJECTS:",l.getRingObjs(t)),console.log("num ui objs"),e.currRingRot=0;var o=l.getRingObjs(t);console.log("DATA",o),e.uiObjs=o.objs,e.rotPer=o.rot}});else{e.currUI=e.uiOpts[t],console.log("switched from",e.uiOpts[n],"to",e.uiOpts[t]),t<n?(e.nextUI=e.uiOpts[n],n?e.prevUI=e.uiOpts[n-1]:e.prevUI=e.uiOpts[e.uiOpts.length-1]):(e.prevUI=e.uiOpts[n],t<e.uiOpts.length-2?e.nextUI=e.uiOpts[t+1]:e.nextUI=e.uiOpts[0]),console.log("NEW UI OBJECTS:",l.getRingObjs(t)),console.log("num ui objs"),e.currRingRot=0;var o=l.getRingObjs(t);console.log("DATA",o),e.uiObjs=o.objs,e.rotPer=o.rot}e.rngChOkay=!1,e.rngChTimer=setTimeout(function(){e.rngChOkay=!0},1e3)},e.uiObjs=l.getRingObjs(0),e.chMenRng=function(t){var n=e.uiOpts.indexOf(e.currUI),o=n;t&&0!==t?n<e.uiOpts.length-1?n++:n=0:n&&0!==n?n--:n=e.uiOpts.length-1,console.log("changing menu ring:",t,n,o),e.ringChAni(n,o)},e.oldX,e.oldY,e.noScroll=function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1},e.parseTouch=function(t){if(e.noScroll(t),!e.oldX||!e.oldY)return e.oldX=t.x,e.oldY=t.y,!1;var n=t.x-e.oldX,o=t.y-e.oldY;if(e.oldX=t.x,e.oldY=t.y,Math.abs(n)>Math.abs(o))e.currRingRot=l.PlatinumSpinningRings(e.currRingRot,n);else{if(!(Math.abs(o)>10))return!1;e.chMenRng(o>0?0:1)}},e.chMenRng(1),e.chMenRng(1),a.bind($("body#mob"),{move:e.parseTouch})}]),app.factory("combatFac",["$http",function(e){var t=["Physical","Fire","Ice","Poison","Dark","Holy"];return{getDmgType:function(e){return t[parseInt(e)]},combatReady:function(){$("#combat-box #enemy .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .health-bar .stat-bar-stat").css("width","100%"),$("#combat-box #player .energy-bar .stat-bar-stat").css("width","100%")},getSkillInf:function(e,t){sandalchest.dialog(e[t].name,e[t].desc,{buttons:[{text:"Okay",close:!0}]})},getItems:function(){return e.get("/item/allItems").then(function(e){return e})},rollLoot:function(t){return e.get("/item/byLvl/"+t.lvl).then(function(e){return e.data})},addXp:function(t,n,o,a){return e.post("/user/addXp",{xp:n,user:t,cells:o,loc:a},function(e){return e})},besties:function(t){return e.post("/user/addBeast",t).then(function(e){return e.data})}}}]),app.controller("comb-con",["$scope","$http","$q","$timeout","$window","combatFac","musFac",function(e,t,n,o,a,r,l){e.comb={},e.comb.playersTurn=!1,e.comb.itemStats,e.comb.attackEffects=[],e.inCombat=!0,e.comb.lastDefeated=null,e.comb.prepComb=function(){e.comb.lastDefeated=e.intTarg.name,e.comb.battleStatus={status:!1,title:"NONE",txt:"NONE",btn:"YOU SHOULD NOT BE HERE"},e.intTarg.currHp=e.intTarg.hp,$(".pre-battle").hide(250),console.log("MONSTER ID:",e.$parent.intTarg),r.besties({id:e.$parent.intTarg._id,u:e.$parent.name}).then(function(t){e.beastLib=t,console.log("BEASTLIB",e.beastLib),r.getItems().then(function(t){e.comb.itemStats=t.data,e.currPRegens=[],e.currPDegens=[],e.currMRegens=[],e.currMDegens=[],e.popInv()})})},e.comb.skillCh=function(t){console.log("prev skill:",e.$parent.fullSkills),t?e.currSkillNum<e.$parent.fullSkills.length-1?e.currSkillNum++:e.currSkillNum=0:e.currSkillNum>0?e.currSkillNum--:e.currSkillNum=e.$parent.fullSkills.length-1},e.currPRegens=[],e.currPDegens=[],e.currMRegens=[],e.currMDegens=[],e.monsStunned=!1,e.comb.fleeMult=1,e.pStunned=!1,e.comb.showSkillInf=function(){r.getSkillInf(e.$parent.fullSkills,e.currSkillNum)},e.comb.attemptFlee=function(){e.comb.fleeMult=1,e.$parent.intTarg.lvl/e.lvl>3?e.comb.fleeMult=4:e.$parent.intTarg.lvl/e.lvl<.2?e.comb.fleeMult=1.2:e.comb.fleeMult=1+e.$parent.intTarg.lvl/e.lvl,Math.random()>.7?(e.comb.fleeMult=1,e.comb.flee()):sandalchest.alert("You attempt to flee the "+e.intTarg.name+", but fail! It attacks!",function(t){e.comb.playersTurn=!1,e.comb.monsTurn()})},e.comb.wait=function(){e.comb.updateDoTs(),e.currHp<=0?e.comb.dieP():(e.comb.playersTurn=!1,e.comb.monsTurn())},e.comb.attack=function(){e.comb.attackEffects=[];var t=parseInt(e.comb.calcDmg(1));e.intTarg.currHp-=t,e.comb.updateDoTs();var n="You attack for "+t+" "+r.getDmgType(e.$parent.fullSkills[e.currSkillNum].type)+" damage, using "+e.$parent.fullSkills[e.currSkillNum].name+"!";if(e.comb.attackEffects.length){var o="nova"==e.comb.attackEffects;o&&e.comb.attackEffects.shift();for(var a=" Your attack is a ",l=0;l<e.comb.attackEffects.length-1;l++)a+=e.comb.attackEffects[l]+", ";a+=e.comb.attackEffects.length>1?"and "+e.comb.attackEffects[e.comb.attackEffects.length-1]+" one.":e.comb.attackEffects[e.comb.attackEffects.length-1]+" one.",n+=a+" "+e.comb.xfx.join("")}sandalchest.alert(n,function(t){e.intTarg.currHp<=0?e.comb.dieM():(e.comb.playersTurn=!1,e.comb.monsTurn())})},e.comb.DoT=function(e,t,n){this.dur="undefined"!=typeof n?n:5,this.name=e,this.amt=t},e.comb.checkDoTDup=function(e,t){for(var n=0;n<e.length;n++)if(e[n].name==t)return!1;return!0},e.resetDoTDur=function(t,n,o){for(var a=0;a<e[t].length;a++)if(e[t][a].name==n){e[t][a].dur="undefined"!=typeof o?o:5;break}},e.comb.xfx=[];var s=function(e,t){for(var n=0;n<t.length;n++)if(t[n].num==e)return t[n]};e.comb.calcDmg=function(t){e.comb.xfx=[];var n=e.comb.itemStats[1],o=e.comb.itemStats[0],a=e.comb.itemStats[2],l=e.comb.itemStats[3];console.log("WEAP IDS",e.playerItems.weap,"WEAPS",n,"ARMOR",o,"AFFIXES",a,"JUNK",l);var i=e.playerItems.weap;"number"==typeof i[0]&&(i[0]=s(i[0],a),i[1]=s(i[1],n),i[2]=s(i[2],a)),console.log("PLAYER WEAPON:",i);var c,u,m,d=0,p=0,g=!1;if(m=e.$parent.intTarg.lvl/e.lvl>2?2:e.$parent.intTarg.lvl/e.lvl<.5?.5:e.$parent.intTarg.lvl/e.lvl,t){if(!e.pStunned&&e.$parent.fullSkills[e.currSkillNum].energy<=e.currEn){c=e.$parent.fullSkills[e.currSkillNum].type,i[0].dmgType!=-1&&(c=i[0].dmgType),i[2].dmgType!=-1&&(c=i[2].dmgType);var f=i?Math.floor(Math.random()*(i[1].max-i[1].min))+i[1].min:0;(Math.random()<i[0].brut||Math.random()<i[2].brut)&&(f*=1.7,e.comb.attackEffects.push("brutal"));var h=e.$parent.fullSkills[e.currSkillNum].burst;if(console.log("ATTACKED USING A SKILL"),console.log("SKILL WAS:",e.$parent.fullSkills[e.currSkillNum]),e.$parent.fullSkills[e.currSkillNum].degen){var v=Math.random()<i[0].crue||Math.random()<i[2].crue?10:5;v>5&&e.comb.attackEffects.push("cruel"),e.comb.checkDoTDup(e.currMDegens,e.$parent.intTarg.name+"-"+e.$parent.fullSkills[e.currSkillNum].name+"-degen")?e.currMDegens.push(new e.comb.DoT(e.$parent.intTarg.name+"-"+e.$parent.fullSkills[e.currSkillNum].name+"-degen",e.$parent.fullSkills[e.currSkillNum].degen,v)):e.resetDoTDur("currMDegens",e.$parent.intTarg.name+"-"+e.$parent.fullSkills[e.currSkillNum].name+"-degen",v)}if(e.$parent.fullSkills[e.currSkillNum].regen){var y=Math.random()<i[0].rejuv||Math.random()<i[2].rejuv?10:5;y>5&&e.comb.attackEffects.push("rejuvenating"),e.comb.checkDoTDup(e.currPRegens,"player-"+e.$parent.fullSkills[e.currSkillNum].name+"-regen")?e.currPRegens.push(new e.comb.DoT("player-"+e.$parent.fullSkills[e.currSkillNum].name+"-regen",e.$parent.fullSkills[e.currSkillNum].regen,y)):e.resetDoTDur("currPRegens","player-"+e.$parent.fullSkills[e.currSkillNum].name+"-regen",y);
}if(e.$parent.fullSkills[e.currSkillNum].heal){var b=Math.random()<i[0].bene||Math.random()<i[2].bene?2:1;y>5&&e.comb.attackEffects.push("benedictive"),e.currHp+=e.$parent.fullSkills[e.currSkillNum].heal*b,e.currHp>e.maxHp&&(e.currHp=e.maxHp)}(e.$parent.fullSkills[e.currSkillNum].stuns||Math.random()<i[0].stunCh||Math.random()<i[2].stunCh)&&(e.monsStunned=!0,e.comb.attackEffects.push("stunning"));var w=Math.random()<i[0].novaChance||Math.random()<i[2].novaChance?.5*f:0;if(w&&e.comb.attackEffects.unshift("nova"),e.intTarg.res.indexOf(i[0].novaType)==-1&&e.intTarg.res.indexOf(i[1].novaType)==-1||(w=Math.floor(w/3)),(Math.random()<i[0].conf||Math.random()<i[2].conf)&&(e.monsConf=!0,e.comb.attackEffects.push("confusing")),i[0].vamp>0||i[2].vamp>0){e.comb.attackEffects.push("life-stealing");var k=.1*Math.random()+.05;e.currHp+=(f+h)*k,e.currHp>e.maxHp&&(e.currHp=e.maxHp)}e.currEn-=e.$parent.fullSkills[e.currSkillNum].energy,console.log("dmg components",h,f,w);var I=h+f+w;e.monsStunned&&e.$parent.fullSkills[e.currSkillNum].extraFx&&e.$parent.fullSkills[e.currSkillNum].extraFx.dmgVsStun&&(I*=1+.7*Math.random(),e.comb.xfx.push("It did extra damage to your stunned foe. ")),e.currMDegens.length&&e.$parent.fullSkills[e.currSkillNum].extraFx&&e.$parent.fullSkills[e.currSkillNum].extraFx.dmgVsDegen&&(I*=1+.7*Math.random(),e.comb.xfx.push("It did extra damage since your foe&rsquo;s suffering from degen. ")),e.$parent.fullSkills[e.currSkillNum].extraFx&&e.$parent.fullSkills[e.currSkillNum].extraFx.critChance&&(I*=1+.5*Math.random(),e.comb.xfx.push("It hit for extra critical damage.")),e.$parent.fullSkills[e.currSkillNum].extraFx&&e.$parent.fullSkills[e.currSkillNum].extraFx.protection&&(e.pProt=!0,e.comb.xfx.push("Using the skill applied protection for one turn!"));var x=100*Math.random()<6.25*Math.max(-6,Math.min(e.lvl-e.$parent.intTarg.lvl,6))+37.5;return x&&(1==e.$parent.prof?e.monsStunned?e.comb.checkDoTDup(e.currMDegens,e.$parent.intTarg.name+"-war-degen")?e.currMDegens.push(new e.comb.DoT(e.$parent.intTarg.name+"-war-degen",2,5)):e.resetDoTDur("currMDegens",e.$parent.intTarg.name+"-war-degen",5):e.currMDegens.length&&(e.monsStunned=!0):2==e.$parent.prof?Math.random()>.5?e.comb.checkDoTDup(e.currMDegens,e.$parent.intTarg.name+"-sorc-degen")?e.currMDegens.push(new e.comb.DoT(e.$parent.intTarg.name+"-sorc-degen",2,5)):e.resetDoTDur("currMDegens",e.$parent.intTarg.name+"-sorc-degen",5):e.comb.checkDoTDup(e.currPRegens,e.$parent.intTarg.name+"-sorc-regen")?e.currPRegens.push(new e.comb.DoT(e.$parent.intTarg.name+"-sorc-regen",3,5)):e.resetDoTDur("currPRegens",e.$parent.intTarg.name+"-sorc-regen",5):3==e.$parent.prof?e.monsRetalled=!0:4==e.$parent.prof&&(e.currHp+=.15*I,I*=1.15)),I}return e.$parent.fullSkills[e.currSkillNum].energy>e.currEn?(sandalChest.alert("You don't have enough energy to use "+e.$parent.fullSkills[e.currSkillNum].name+"."),0):(sandalChest.alert("You've been stunned! You can't attack this turn."),0)}if(e.monsStunned)e.monsStunned=!1;else{c=e.$parent.intTarg.type,d=m*(Math.ceil(Math.random()*(e.$parent.intTarg.max-e.$parent.intTarg.min))+e.$parent.intTarg.min);var T={head:{freq:1},chest:{freq:5},hands:{freq:3},legs:{freq:2},feet:{freq:1}},M=e.comb.freqGen(T),S=M[Math.floor(Math.random()*M.length)],$=0;e.playerItems[S]&&e.playerItems[S][1]&&e.playerItems[S][1]>-1&&($=o[e.playerItems[S][1]].def);var E=0;if(i[1].def&&(E+=i[1].def),console.log("Now running inv item defense",e.playerItems.inv),e.playerItems.inv&&e.playerItems.inv.length){console.log("----Checking defense items:----");for(var C=0;C<e.playerItems.inv.length;C++)0==e.playerItems.inv[C].lootType&&(console.log("CHECKING DEFENSE ON ITEM:",e.playerItems.inv[C]),E+=e.playerItems.inv[C].item[1].def||0),e.playerItems.inv[C].item&&e.playerItems.inv[C].item[1]&&e.playerItems.inv[C].item[1].res&&e.playerItems.inv[C].item[1].res.indexOf(c)!=-1&&(g=!0)}p=$+E}return u=d/(3*Math.log10(p+1)||1),g?u/=3:(1!=i[0].defChanges[r.getDmgType(c)]&&1!=i[2].defChanges[r.getDmgType(c)]||(u/=3),i[0].defChanges[r.getDmgType(c)]!=-1&&i[2].defChanges[r.getDmgType(c)]!=-1||(u*=1.5)),1!=e.$parent.prof&&3!=e.$parent.prof||(console.log("Char has HEAVY ARMOR! Reduction in dmg"),u*=.7),e.pProt&&(u*=.7,e.pProt=!1),e.comb.fleeMult*u},e.comb.freqGen=function(e){for(var t=Object.keys(e),n=[],o=0;o<t.length;o++)for(var a=0;a<e[t[o]].freq;a++)n+=t[o];return n},e.comb.acceptStatus=function(){var t="Victory!"==e.comb.battleStatus.title;$(".pre-battle").show(10),e.comb.battleStatus={status:!1,title:" ",txt:" ",url:"./img/paper.jpg"};var n=0;t?r.rollLoot(e.intTarg).then(function(t){console.log("FROM ROLL LOOT",t);var o="",a={};"junk"==t.type?(o=t.loot.name,a.lootType=2,a.num=t.num,a.item=t.loot,e.playerItems.inv.push(a)):(a.lootType=t.type,a.num=t.num,a.item=[t.loot.pre,t.loot.base,t.loot.post],o=t.loot.pre.pre+" "+t.loot.base.name+" "+t.loot.post.post,e.playerItems.inv.push(a)),sandalchest.alert("After killing the "+e.comb.lastDefeated+", you gain "+n+" experience and recieve "+o+"!",function(t){n=50*e.intTarg.lvl/e.playerLvl||1,angular.element("body").scope().cells[angular.element("body").scope().cellNames.indexOf(angular.element("body").scope().playerCell)].has=null,r.addXp(e.name,n,e.$parent.cells,e.$parent.playerCell).then(function(t){e.inCombat=!1,l.getMusic("general"),console.log("RESULT FROM XP ROUTE",t),angular.element("body").scope().inCombat=!1,angular.element("body").scope().intTarg=!1,angular.element("body").scope().moveReady=!0,angular.element("body").scope().currHp=angular.element("body").scope().maxHp,angular.element("body").scope().currEn=angular.element("body").scope().maxEn,"object"==_typeof(t.data)&&(e.currXp=parseInt(t.data.xp),e.playerLvl=parseInt(t.data.lvl),e.$parent.currXp=parseInt(t.data.xp),e.$parent.playerLvl=parseInt(t.data.lvl)),e.currHp=e.maxHp,e.currEn=e.maxEn,angular.element("body").scope().$apply()})})}):"Flee!"==e.comb.battleStatus.title?(console.log("player fled"),l.getMusic("general"),angular.element("body").scope().playerCell=angular.element("body").scope().oldCell,angular.element("body").scope().inCombat=!1,angular.element("body").scope().intTarg=!1,angular.element("body").scope().moveReady=!0,angular.element("body").scope().intTarg.currHp=angular.element("body").scope().hp,angular.element("body").scope().currEn=angular.element("body").scope().maxEn,e.$parent.intTarg.currHp=e.$parent.intTarg.hp,angular.element("body").scope().$apply()):(console.log("defeat condition"),l.getMusic("general"),angular.element("body").scope().playerCell="0-0",angular.element("body").scope().inCombat=!1,angular.element("body").scope().intTarg=!1,angular.element("body").scope().moveReady=!0,angular.element("body").scope().intTarg.currHp=angular.element("body").scope().hp,angular.element("body").scope().currEn=angular.element("body").scope().maxEn,e.$parent.intTarg.currHp=e.$parent.intTarg.hp,angular.element("body").scope().$apply())},e.comb.battleEndMsgs={win:["Onward!","To victory!","Forward"],lose:["Retry!","I'll be back!","Another time then..."],flee:["I'm not a coward!","I'll be back...","Another time then...","A close one!"]},e.comb.dieP=function(){l.getMusic("defeat"),e.comb.battleStatus={status:!0,title:"Defeat!",txt:"You've been defeated!",url:"./img/assets/Defeat.jpg",btn:e.comb.battleEndMsgs.lose[Math.floor(Math.random()*e.comb.battleEndMsgs.lose.length)]}},e.comb.dieM=function(){l.getMusic("victory"),e.comb.battleStatus={status:!0,title:"Victory!",txt:"You are victorious! The "+e.intTarg.name+" lies defeated at your feet.",url:"./img/assets/Victory.jpg",btn:e.comb.battleEndMsgs.win[Math.floor(Math.random()*e.comb.battleEndMsgs.win.length)]}},e.comb.flee=function(){console.log("flee worked!"),e.comb.battleStatus={status:!0,title:"Flee!",txt:"You've successfully fled the "+e.intTarg.name+".",url:"./img/assets/flee.jpg",btn:e.comb.battleEndMsgs.flee[Math.floor(Math.random()*e.comb.battleEndMsgs.flee.length)]}},e.comb.updateDoTs=function(){var t;for(t=0;t<e.currPRegens;t++)e.currHp+=e.currPRegens[t].amt,e.currPRegens[t].dur--,e.currPRegens[t].dur||e.currPRegens.splice(t,1);for(e.currHp>e.maxHp&&(e.currHp=e.maxHp),t=0;t<e.currPDegens;t++)e.currHp-=e.currPDegens[t].amt,e.currPDegens[t].dur--,e.currPDegens[t].dur||e.currPDegens.splice(t,1);for(t=0;t<e.currMRegens;t++)e.intTarg.currHp+=e.currMRegens[t].amt,e.currMRegens[t].dur--,e.currMRegens[t].dur||e.currMRegens.splice(t,1);for(e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.intTarg.hp),t=0;t<e.currMDegens;t++)e.intTarg.currHp+=e.currMDegens[t].amt,e.currMDegens[t].dur--,e.currMDegens[t].dur||e.currMDegens.splice(t,1)},e.comb.monsTurn=function(){if(console.log("monster taking turn!"),e.monsStunned)sandalchest.alert(e.$parent.intTarg.name+" is stunned this turn!",function(){e.comb.playersTurn=!0,e.comb.fleeMult=1});else{var t=parseInt(e.comb.calcDmg()),n=Math.random()<.5&&e.monsConf;if(e.monsRetalled&&(e.intTarg.currHp-=.15*t),n)e.monsConf=!1,e.intTarg.currHp-=t,sandalchest.alert(e.$parent.intTarg.name+" is confused, and attacks itself for "+t+" "+r.getDmgType(e.$parent.intTarg.type)+"!",function(){e.comb.updateDoTs(),e.intTarg.currHp<=0?e.comb.dieM():(e.comb.playersTurn=!0,e.comb.fleeMult=1,e.currEn+=2,e.currEn>e.maxEn&&(e.currEn=e.maxEn))});else if(e.intTarg.currHp/e.intTarg.hp>.5&&Math.random<e.intTarg.healCh)sandalchest.alert("The "+e.intTarg.name+" heals!",function(){var t=e.intTarg.hp*(.07+Math.random()/10);e.intTarg.currHp+=t,e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.currHp),e.comb.playersTurn=!0,e.comb.fleeMult=1,e.monsRetalled=!1});else if(e.intTarg.currHp/e.intTarg.hp>.5&&-3.6*(e.intTarg.currHp/e.intTarg.hp)+3>Math.random())sandalchest.alert("The "+e.intTarg.name+" heals!",function(){var t=e.intTarg.hp*(.07+Math.random()/10);e.intTarg.currHp+=t,e.intTarg.currHp>e.intTarg.hp&&(e.intTarg.currHp=e.currHp),e.comb.playersTurn=!0,e.comb.fleeMult=1,e.monsRetalled=!1});else{Math.random()<e.$parent.intTarg.stunCh&&(e.pStunned=!0),e.currHp-=t;var o=e.monsRetalled?" Your Redemption trait reflects some of the monster&rsquo;s damage!":"";sandalchest.alert(e.$parent.intTarg.name+" attacks for "+t+" "+r.getDmgType(e.$parent.intTarg.type)+"!"+o,function(){e.comb.updateDoTs(),e.currHp<=0?(e.comb.dieP(),e.monsRetalled=!1):e.intTarg.currHp<=0?(e.comb.dieM(),e.monsRetalled=!1):(e.comb.playersTurn=!0,e.comb.fleeMult=1,e.currEn+=2,e.currEn>e.maxEn&&(e.currEn=e.maxEn),e.monsRetalled=!1)})}}}}]),app.factory("econFac",["$http","$q",function(e,t){return{merchInv:function(t,n){return e.get("/item/allItems/").then(function(e){return console.log("GETTING ITEM DATA:invArr",t,e),t.forEach(function(t){if(0!=t.lootType&&(1!=t.lootType||3!=t.item.length))throw new Error("FOUND JUNK "+JSON.stringify(t)+" in inventory of merch!");for(var n=0;n<e.data[2].length;n++)t.item[0]==e.data[2][n].num&&(t.item[0]=angular.copy(e.data[2][n])),t.item[2]==e.data[2][n].num&&(t.item[2]=angular.copy(e.data[2][n]));if(0==t.lootType)for(var n=0;n<e.data[0].length;n++)t.item[1]==e.data[0][n].num&&(t.item[1]=angular.copy(e.data[0][n]));else for(var n=0;n<e.data[1].length;n++)t.item[1]==e.data[1][n].num&&(t.item[1]=angular.copy(e.data[1][n]))}),console.log("POPULATED MERCH INV",t),{inv:t,id:n}})},getNpc:function(t){return e.get("/other/oneNpc/"+t).then(function(e){return{data:e.data.data,id:e.data.i}})},getQuests:function(t,n,o){var a=n.split("-");return e.get("/quest/npcQ/"+a[0]+"/"+a[1]+"/"+o+"/"+t).then(function(e){return e.data})},acceptQuest:function(t,n){return e.post("/quests/acceptQuest",{n:t,qid:n}).then(function(e){return e.data})}}}]),app.factory("mazeFac",["$http",function(e){var t=function(e,t){this.id=e,this.x=e.split("-")[0],this.y=e.split("-")[1],this.east=!0,this.west=!0,this.north=!0,this.south=!0,this.visited=!1,this.pViz=!1,this.has=t},n=[],o=0,a=[],r="",l=[],s=["loot","mons","npcs","jewl"," ","exit"," "," ","mons","mons"],i=function(){for(var e=!1;!e;){if(l.pop(),!l.length)return!1;r=l[l.length-1];for(var t,o=["n","e","s","w"],s=n.indexOf(r);!e&&o.length;)t=Math.floor(Math.random()*o.length),e=a[s].checkCell(o[t]),"e"!=e&&"v"!=e||(e=!1,o.splice(t,1))}return e};return t.prototype.dig=function(e,t){switch(e){case"n":this.north=!1,t.south=!1;break;case"e":this.east=!1,t.west=!1;break;case"s":this.south=!1,t.north=!1;break;default:this.west=!1,t.east=!1}},t.prototype.checkCell=function(e){var t=this.id.split("-"),o=parseInt(t[0]),r=parseInt(t[1]);switch(e){case"n":r--;break;case"e":o++;break;case"s":r++;break;default:o--}var l=o+"-"+r,s=n.indexOf(l);return s==-1?"e":a[s].visited?"v":l},{popCell:function(t,n){return e.get("/item/beastie/"+t+"/"+n).then(function(e){return e.data})},makeMaze:function(e,c){a=[],n=[],l=[],o=0;for(var u=!1,m=0;m<e;m++)for(var d=0;d<c;d++){for(var p=s[Math.floor(Math.random()*s.length)];(0===m||0===d)&&"exit"==p;)p=s[Math.floor(Math.random()*s.length)];"exit"==p&&(u=!0,s.splice(5,1)),a.push(new t(m+"-"+d,p)),n.push(m+"-"+d)}for(u||(a[Math.floor(Math.random()*a.length)].has="exit"),r="0-0";o<n.length;){l.push(r);for(var g,f=["n","e","s","w"],h=n.indexOf(r),v=!1;!v&&f.length;)g=Math.floor(Math.random()*f.length),v=a[h].checkCell(f[g]),"e"!=v&&"v"!=v||(v=!1,f.splice(g,1));if(a[h].visited=!0,v||(v=i()),!v)break;r=v;var y=n.indexOf(r);a[h].dig(f[g],a[y]),o++}return{cells:a,names:n,path:l}}}}]),app.controller("merch-cont",["$scope","$http","$q","$timeout","$window","econFac","UIFac",function(e,t,n,o,a,r,l){e.merchy.prepNpc=function(){e.merchy.buy=!0,e.merchy.merch=e.currNpc,e.merchy.merch.sez=e.merchy.merch.gossip[Math.floor(Math.random()*e.merchy.merch.gossip.length)]},e.merchy.itemForPlayer=null,e.acceptQuest=function(){sandalchest.confirm("Accept Quest","Are you sure you want to accept this quest?",function(t){t&&r.acceptQuest(e.user.$scope.merchy.merch.quest.id)})},e.merchy.exchange=function(t,n,o){e.moveReady=!1,angular.element("body").scope().moveReady=!1,console.log(t);var a=t.item[0].pre+" "+t.item[1].name+"s "+t.item[2].post,r=Math.floor(t.item[1].cost*(10+t.item[0].cost+t.item[2].cost))/10;console.log("ITEM DATA TO EXCHANGE",t,"and dir:",n),sandalchest.dialog((n?"Sell":"Buy")+" Items","How many "+a+" do you want to "+(n?"sell":"buy")+"?<hr/><input type=number value=1 min=1 max="+t.num+" id='numExch'>",{buttons:[{text:(n?"Sell":"Buy")+" Items",close:!0,click:function(){var s=parseInt($("#numExch").val());if(n&&"false"!=n)s<t.num?e.playerItems.inv[o].num-=s:e.playerItems.inv.splice(o,1),e.playerItems.gold+=r*s*.9;else if(s*r<e.playerItems.gold){s<t.num?e.merchy.merch.inv[o].num-=s:e.merchy.merch.inv.splice(o,1);for(var i=-1,c=0;c<e.playerItems.inv.length;c++){var u=e.playerItems.inv[c].item[0].pre+" "+e.playerItems.inv[c].item[1].name+"s "+e.playerItems.inv[c].item[2].post;a==u&&(i=c)}if(i!=-1)e.playerItems.inv[i].num+=s;else{e.merchy.itemForPlayer=angular.copy(t),console.log("ITEM FOR PLAYER",e.merchy.itemForPlayer),e.merchy.itemForPlayer.num=s,e.playerItems.inv.push(e.merchy.itemForPlayer)}e.playerItems.gold-=r*s}else sandalchest.alert("You don't have enough money to afford "+s+" "+a+"s!");l.doPlayerInv(e.playerItems,e.bodyBoxes).then(function(t){e.bodyBoxes=t,e.currUIObjs=e.playerItems.inv}),angular.element("body").scope().moveReady=!0,e.moveReady=!0}},{text:"Cancel",close:!0,click:function(){angular.element("body").scope().moveReady=!0,e.moveReady=!0}}]})}}]),app.factory("musFac",["$http",function(e){return{createMus:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.context=new AudioContext,window.gain=context.createGain(),gain.gain.value=.5},getMusic:function(e){function t(e){window.source=window.context.createBufferSource(),window.context.decodeAudioData(e,function(e){window.source.buffer=e,window.source.connect(gain),window.gain.connect(context.destination),window.source.start(context.currentTime)})}window.context&&window.source&&window.source.stop();var n=new XMLHttpRequest;n.open("GET","./other/mus/"+e,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;t(e)},n.send()},toggleMus:function(){window.gain&&window.gain.gain.value&&window.gain.gain.value>0?window.gain.gain.value=0:window.gain&&0==window.gain.gain.value&&(window.gain.gain.value=.5)}}}]);var sandalchest={};sandalchest.drawDiv=function(e,t,n){var o=e.options&&e.options.speed||1e3,a=e.options&&e.options.rotation||2,r=e.options&&e.options.parent||"body",l=document.createElement("div");l.id="sandalchest-modal-bg",l.innerHTML="&nbsp;";var s=document.createElement("div");s.className="col-sm-12 col-md-4 col-md-offset-4 sandalchest-modal-main",s.innerHTML="<h2>"+(e.title||" ")+'</h2><div class="sandalchest-text-main">'+(e.text||"")+"</div>",s.style.transform="rotateZ("+a+"deg)",$(l).append(s);var i=document.createElement("div"),c=document.createElement("div");i.className="sandalchest-modal-scroll-top",c.className="sandalchest-modal-scroll-bot",$(s).append(i),$(s).append(c);var u=document.createElement("div");u.className="sandalchest-modal-scroll-right",$(i).append(u);var m=document.createElement("div");m.className="sandalchest-modal-scroll-right",$(c).append(m);var d=document.createElement("div");d.className="sandalchest-modal-scroll-left",$(i).append(d);var p=document.createElement("div");p.className="sandalchest-modal-scroll-left",$(c).append(p),$(r).append(l),$(l).fadeIn(250),$(s).animate({height:"80vh",top:"10vh"},{duration:o,queue:!1}),$(i).animate({height:"0%"},{duration:o,queue:!1}),$(c).animate({height:"0%"},{duration:o,queue:!1}),$(".sandalchest-modal-scroll-right").animate({width:".25%"},{duration:o,queue:!1}),$(".sandalchest-modal-scroll-left").animate({width:".25%"},{duration:o,queue:!1});var g=document.createElement("div");if(g.className="sandalchest-modal-buttons",$(s).append(g),3>t){var f=document.createElement("button"),h=document.createElement("button"),v=document.createElement("input");f.className="btn btn-stone",h.className="btn btn-stone",f.id="sandalchest-okay",h.id="sandalchest-nope",f.tabIndex=0,h.tabIndex=1,f.innerHTML="Okay",h.innerHTML="Cancel",v.id="sandalchest-input";var y=null;$(g).append(f),0==t||($(g).append(h),1==t||($(".sandalchest-text-main").append("<br/><br/>").append(v),v.tabIndex=0,f.tabIndex=1,h.tabIndex=2)),document.querySelector("#sandalchest-okay").onkeyup=function(e){27==e.which&&$("#sandalchest-nope").click()},2>t?document.querySelector("#sandalchest-okay").focus():(document.querySelector("#sandalchest-input").focus(),document.querySelector("#sandalchest-input").onkeyup=function(e){console.log(e),27==e.which?$("#sandalchest-nope").click():13==e.which&&$("#sandalchest-okay").click()}),f.onclick=function(){$(l).fadeOut(250,function(){t>1?y=$("#sandalchest-input").val()||!1:1==t&&(y=!0),n&&n(y),$(this).remove()})},h.onclick=function(){$(l).fadeOut(250,function(){n&&n(null),console.log(null),$(this).remove()})}}else for(var b=0;b<e.options.buttons.length;b++){var w=document.createElement("button");w.className="btn btn-stone",w.id="customButton"+b,w.innerHTML=e.options.buttons[b].text||"Undefined",e.options.buttons[b].click&&(console.log("Applying custom cb ",e.options.buttons[b].click),w.onclick=e.options.buttons[b].click),e.options.buttons[b].close&&(w.onmouseup=function(){$(l).fadeOut(250,function(){$(this).remove()})}),$(g).append(w)}},sandalchest.alert=function(e,t,n,o){console.log(arguments);for(var a=null,r=null,l=null,s=null,i=0;i<arguments.length;i++){if("string"==typeof arguments[i]&&null==a)a=arguments[i];else if("string"==typeof arguments[i]&&null==r)r=arguments[i];else if("string"==typeof arguments[i])throw new Error("Too many string params supplied!");if("object"==_typeof(arguments[i])&&null==l)l=arguments[i];else if("object"==_typeof(arguments[i]))throw new Error("Too many configuration objects supplied!");if("function"==typeof arguments[i]&&null==s)s=arguments[i];else if("function"==typeof arguments[i])throw new Error("You can only have one callback function!")}var c={title:a,text:r,options:l};sandalchest.drawDiv(c,0,s)},sandalchest.confirm=function(e,t,n,o){console.log(arguments);for(var a=null,r=null,l=null,s=null,i=0;i<arguments.length;i++){if("string"==typeof arguments[i]&&null==a)a=arguments[i];else if("string"==typeof arguments[i]&&null==r)r=arguments[i];else if("string"==typeof arguments[i])throw new Error("Too many string params supplied!");if("object"==_typeof(arguments[i])&&null==l)l=arguments[i];else if("object"==_typeof(arguments[i]))throw new Error("Too many configuration objects supplied!");if("function"==typeof arguments[i]&&null==s)s=arguments[i];else if("function"==typeof arguments[i])throw new Error("You can only have one callback function!")}var c={title:a,text:r,options:l};sandalchest.drawDiv(c,1,s)},sandalchest.prompt=function(e,t,n,o){for(var a=null,r=null,l=null,s=null,i=0;i<arguments.length;i++){if("string"==typeof arguments[i]&&null==a)a=arguments[i];else if("string"==typeof arguments[i]&&null==r)r=arguments[i];else if("string"==typeof arguments[i])throw new Error("Too many string params supplied!");if("object"==_typeof(arguments[i])&&null==l)l=arguments[i];else if("object"==_typeof(arguments[i]))throw new Error("Too many configuration objects supplied!");if("function"==typeof arguments[i]&&null==s)s=arguments[i];else if("function"==typeof arguments[i])throw new Error("You can only have one callback function!")}var c={title:a,text:r,options:l};sandalchest.drawDiv(c,2,s)},sandalchest.dialog=function(e,t,n,o){for(var a=null,r=null,l=null,s=null,i=0;i<arguments.length;i++){if("string"==typeof arguments[i]&&null==a)a=arguments[i];else if("string"==typeof arguments[i]&&null==r)r=arguments[i];else if("string"==typeof arguments[i])throw new Error("Too many string params supplied!");if("object"==_typeof(arguments[i])&&null==l)l=arguments[i];else if("object"==_typeof(arguments[i]))throw new Error("Too many configuration objects supplied!");if("function"==typeof arguments[i]&&null==s)s=arguments[i];else if("function"==typeof arguments[i])throw new Error("You can only have one callback function!")}if(!l||!l.buttons)throw new Error("Custom dialog specified without any buttons!");if(!a||!r)throw new Error("Custom dialogs MUST have both a title and body text!");var c={title:a,text:r,options:l};sandalchest.drawDiv(c,3,s)},app.factory("socketFac",["$rootScope",function(e){var t=io.connect();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,a){t.emit(n,o,function(){var n=arguments;e.$apply(function(){a&&a.apply(t,n)})})}}}]),app.factory("UIFac",["$http","$q","$location","$window","combatFac",function(e,t,n,o,a){var r=function(e,t){for(var n=0;n<e.length;n++)if(e[n].num==t||e[n].id==t)return e[n];return!1},l=function(e,t,n){this.data=t,this.p=e,this.owned=n};return{buySkill:function(t,n){return e.post("/user/buySkill/",{usr:n,skill:t.id},function(e){return e.data})},getUIObj:function(t,n){var o=e.get("/item/"+t).then(function(e){return e});return o},getAllUIs:function(t){return e.get("/item/allUI").then(function(e){var n=null,o=null,a=null,s=null,i=null,c=null,u=null,m=["weap","feet","legs","head","hands","chest"];console.log(e.data);for(var d=0;d<e.data.length;d++)e.data[d][0].slot||0===e.data[d][0].slot?n=e.data[d]:e.data[d][0].post?a=e.data[d]:e.data[d][0].cost&&e.data[d][0].min?o=e.data[d]:e.data[d][0].cost&&e.data[d][0].desc?s=e.data[d]:e.data[d][0].stunCh||0===e.data[d][0].stunCh?u=e.data[d]:e.data[d][0].burst||0===e.data[d][0].burst?c=e.data[d]:i=e.data[d];console.log("armor:",n[0],"\nAffix",a[0],"\nJunk",s[0],"\nWeap",o[0],"\nMon",u[0],"\nSkill",c[0],"\nQuest",i[0]),t.inProg.forEach(function(e){for(d=0;d<i.length;d++)e==i[d].id&&(e=angular.copy(i[d]))}),t.done.forEach(function(e){for(d=0;d<i.length;d++)e==i[d].id&&(e=angular.copy(i[d]))}),t.mon=u,console.log("RAW ITEMS DATA",t.items),m.forEach(function(e){!t.items[e][1]&&0!==t.items[e][1]||t.items[e][1]==-1||"number"!=typeof t.items[e]||(t.items[e][0]=r(a,t.items[e][0]),t.items[e][2]=r(a,t.items[e][2]),"weap"!=e?t.items[e][1]=r(n,t.items[e][1]):t.items[e][1]=r(o,t.items[e][1]))}),t.items.inv.forEach(function(e){2==e.lootType&&e.item.length&&1==e.item.length&&"number"==typeof e.item[0]?e.item[0]=r(s,e.item[0]):1!=e.lootType&&0!=e.lootType||!e.item.length||3!=e.item.length||"number"!=typeof e.item[0]||(e.item[0]=r(a,e.item[0]),e.item[2]=r(a,e.item[2]),0==e.lootType?e.item[1]=r(n,e.item[1]):e.item[1]=r(o,e.item[1]))}),console.log("FINAL ITEMS:",t.items);for(var p=[],d=0;d<c.length;d++)if(console.log("looking at skill",c[d].name,"to see if base"),c[d].prevSkill==-1&&t.skills.indexOf(c[d].id)>-1){var g={skills:[c[d].id]};g[c[d].id]=new l(0,c[d],(!0)),p.push(g)}for(var f=!0;f;)for(f=!1,d=0;d<p.length;d++)for(var h=0;h<c.length;h++)p[d].skills.indexOf(c[h].id)<0&&p[d][c[h].prevSkill]&&(console.log("Found another skill!",c[h]),f=!0,p[d].skills.push(c[h].id),p[d][c[h].id]=new l(c[h].prevSkill,c[h],t.skills.indexOf(c[h].id)>-1));for(var v=[],d=0;d<p.length;d++){for(var y={skills:p[d].skills,lvls:[]},h=0;h<p[d].skills.length;h++)y.lvls.indexOf(p[d][p[d].skills[h]].data.skillPts)<0?(console.log("new lvl!",p[d][p[d].skills[h]].data.skillPts,"skill num",p[d].skills[h],"chain",p[d]),y.lvls.push(p[d][p[d].skills[h]].data.skillPts),y[p[d][p[d].skills[h]].data.skillPts]=[p[d][p[d].skills[h]]]):y[p[d][p[d].skills[h]].data.skillPts].push(p[d][p[d].skills[h]]);v.push(y)}return t.chains=v,console.log("finalChains",v),t.skillsReal=t.skills.map(function(e){return console.log("skill id",e,r(c,e)),r(c,e)}),t})},getUIBg:function(e){var t={Inventory:"../img/UI/inv.jpg",Skills:"",Bestiary:"",Quests:""};return t[e]},moreInfo:function(t){var n=["Physical","Fire","Ice","Poison","Dark","Holy"],o='<ul class="moreInfList">',r=!1;if(console.log(t,!!t.item,t.item),t.item&&(t.item[1].slot||0==t.item[1].slot)){var l;switch(t.item[1].slot){case 0:l="head";break;case 1:l="torso";break;case 2:l="pants";break;case 3:l="hands";break;case 4:l="feet";break;default:l="accessory"}o+="<li>Type:"+l+"</li>",o+="<li>Defense:"+t.item[1].def||"None</li>",o+="<li>Cost:"+t.item[1].cost+" coins</li>",o+="<li>Level:"+t.item[1].itemLvl+"</li>",o+="<li>Resistance:";for(var s=[],i=[],c=0;c<t.item[1].res.length;c++)s.indexOf(n[t.item[1].res[c]])==-1&&s.push(n[t.item[1].res[c]]);for(var u in t.item[0].defChanges)1==t.item[0].defChanges[u]&&s.indexOf(t.item[0].defChanges[u])==-1?s.push(t.item[0].defChanges[u]):t.item[0].defChanges[u]==-1&&vuln.indexOf(t.item[0].defChanges[u])==-1&&vuln.push(t.item[0].defChanges[u]);for(var u in t.item[2].defChanges)1==t.item[2].defChanges[u]&&s.indexOf(t.item[2].defChanges[u])==-1?s.push(t.item[2].defChanges[u]):t.item[2].defChanges[u]==-1&&vuln.indexOf(t.item[2].defChanges[u])==-1&&vuln.push(t.item[2].defChanges[u]);o+=(s.length?s.join(", "):"none")+"</li>",o+="<li>Vulnerabilities:"+(i.length?i.join(", "):"none")+"</li>"}else if(t.giver||0===t.giver)e.get("/item/getGiver/"+t.giver).then(function(e){console.log("results from quest-giver search",e.data[0]),o+="<li>Level:"+t.lvl+"</li>",o+="<li>Given by:"+e.data[0].Name+"</li>",o+="</ul>",$("#moreInf").html(o),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info")});else if(t.energy||0===t.energy)r=!0,(t.burst&&t.burst>0||t.degen&&t.degen>0)&&(o+="<li>Damage Type:"+a.getDmgType(t.type)+"</li>"),o+="<li>Energy:"+t.energy+"</li>",o+=t.heal?"<li>Heal (burst):"+t.heal+" hp</li>":"",o+=t.regen?"<li>Heal (regeneration):"+t.regen+" hp/turn</li>":"",o+=t.burst?"<li>Damage:"+t.burst+" hp</li>":"",o+=t.degen?"<li>Degeneration:"+t.degen+" hp/turn</li>":"",o+=t.stuns?"<li>Stuns</li>":"";else if(t.maxHp)o+="What are you doing? You broke the game!";else if(t.item&&!t.item[1].slot)o+=t.item[1].max?"<li>Damage:"+t.item[1].min+"-"+t.item[1].max+" hp</li>":"",o+=t.item[1].def?"<li>Defense:"+t.item[1].def+"</li>":"",o+="<li>Level:"+t.item[1].itemLvl+"</li>",o+="<li>Cost:"+t.item[1].cost+" coins</li>";else if(r=!0,o+="<li>Level:"+t.lvl+"</li>",o+="<li>Hp:"+t.hp+" hp</li>",o+="<li>Dmg:"+t.min+"-"+t.max+" hp</li>",o+="<li>Damage Type:"+a.getDmgType(t.type)+"</li>",o+="<li>Resistance:",t.res&&t.res.length){o+="<ul>";for(var c=0;c<t.res.length;c++)o+="<li> "+a.getDmgType(t.res[c])+" </li>";o+="</ul>"}else o+="<span> none </span></li>";t.giver||0==t.giver||(o+="</ul>",$("#moreInf").html(o),r&&$("#moreInf").css({background:"linear-gradient(rgba(241,241,212,.4),rgba(241,241,212,.4)),url("+t.imgUrl+")","background-size":"contain","background-repeat":"no-repeat","background-position":"right"}),$("#moreInf").show(200),$("div.modal-footer > button.btn.btn-info").html("Less info"))},lessInf:function(){$("#moreInf").hide(200),$("div.modal-footer > button.btn.btn-info").html("More info")},saveGame:function(t,n,a){for(var r=0;r<t.equip.inv.length;r++){if(console.log("ITEM:",t.equip.inv[r]),t.equip.inv[r].item instanceof Array||"object"!=_typeof(t.equip.inv[r].item))for(var l=0;l<t.equip.inv[r].item.length;l++)t.equip.inv[r].item[l]=t.equip.inv[r].item[l].num;else t.equip.inv[r].item=[t.equip.inv[r].item.num];console.log("Inventory reducified!:",JSON.stringify(t.equip.inv))}console.log("data to save:",t),e.post("/user/save",t).then(function(t){n&&t?e.get("/user/logout").then(function(e){window.location.href="./login"}):a&&t&&o.location.reload()})},logout:function(t){sandalchest.confirm("Logout","<span id='resetWarn'>WARNING:</span> You will lose all progress since your last save! Are you sure you wanna stop playing and log out?",function(t){t&&null!==t&&e.get("/user/logout").then(function(e){window.location.href="./login"})})},reset:function(){var t=Math.floor(50*Math.random()),n=Math.floor(50*Math.random());sandalchest.dialog("Reset Account","<div id='resetWarn'>WARNING:</div> Resetting your account is a <i>permanent</i> move. <br/>If you still wish to reset your game account, enter your username and password below, and solve the math question below and click the appropriate button. Be aware that this decision <i>cannot</i> be reversed!<hr/>Username:<input type='text' id='rmun'><br/>Password:<input type='password' id='rmpw'><hr/>Math Check:<br/>"+t+" + "+n+" = <input type='number' id='mathChk'> ",{buttons:[{text:"YES, reset.",close:!1,click:function(){return parseInt($("#mathChk").val())==t+n&&(credObj={name:$("#rmun").val(),pass:$("#rmpw").val()},void e.post("/user/reset",credObj).then(function(e){return!!e&&(window.location.replace("./login"),!0)}))}},{text:"NO, don't.",close:!0}]})},resetLevel:function(){sandalchest.confirm("Are you sure you wanna reset this level?",function(t){t&&e.get("/resetLevel").then(function(e){o.location.reload()})})},getRingObjs:function(e){var t;switch(e){case 0:t=[{name:"head",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"chest",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"hands",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"legs",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"feet",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"ring",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 1:t=[{name:"Change Skill",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Skill Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Attack",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Retreat",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Wait",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Player Status",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 2:t=[{name:"Current Creature Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"All Creatures Info",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Search Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Vanquished Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Creatures",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;case 3:t=[{name:"Current Side Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Legendary Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Old Quests",imgUrl:"",fn:function(){
console.log("clicked this!")}},{name:"Main Quests",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Quest Stats",imgUrl:"",fn:function(){console.log("clicked this!")}}];break;default:t=[{name:"Save",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Save and Logout",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Logout without saving",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Reset Account",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"Stats",imgUrl:"",fn:function(){console.log("clicked this!")}},{name:"About",imgUrl:"",fn:function(){console.log("clicked this!")}}]}var n={objs:t,rot:360/t.length};return console.log("ring data",n),n},PlatinumSpinningRings:function(e,t){return e+t},doPlayerInv:function(t,n){return e.get("/item/allItems").then(function(e){for(var o in t)if("gold"!=o&&"inv"!=o){for(var a=-1,r=0;r<n.length;r++)if(n[r].name==o){a=r;break}t[o].indexOf(-1)==-1?(console.log("item isnt undefined!",t[o]),n[a].itName=e.data[2][t[o][0]].pre+" "+("weap"==o?e.data[1][t[o][1]].name:e.data[0][t[o][1]].name)+" "+e.data[2][t[o][2]].post,n[a].itFullInfo=[e.data[2][t[o][0]],"weap"==o?e.data[1][t[o][1]]:e.data[0][t[o][1]],e.data[2][t[o][2]]]):n[a].itName="none"}return n})},getContMen:function(e,t,n){return{x:t,y:n,el:e.UIEl,num:e.$index}}}}]),app.factory("userFact",["$http",function(e){return{checkPwdStr:function(e){console.log("password:",e);var t=new RegExp("[A-Z]","g"),n=new RegExp("[a-z]","g"),o=new RegExp("[0-9]","g"),a=new RegExp("\\W","g"),r=0;e.search(t)!=-1&&r++,e.search(n)!=-1&&r++,e.search(o)!=-1&&r++,e.search(a)!=-1&&r++;var l=e.length;return l>16?r+=6:l>11?r+=4:l>6&&(r+=2),r},checkPwdMatch:function(e,t){return e==t},checkName:function(t){return console.log("NAME TO BACKEND",t),e.get("/user/nameOkay/"+t).then(function(e){return console.log("NAME RESPONSE:",e.data),"okay"!=e.data})},login:function(t){return console.log("credentials in factory",t),e.post("/user/login",t).then(function(e){return console.log("response from backend:",e),"yes"==e.data})},checkLogin:function(){return e.get("/user/chkLog").then(function(e){return console.log("CHECKLOG RESULTS",e),e.data})},getVoteExpl:function(e){console.log("Clicked",e);var t={Name:"Your armor, weapon or skill&rsquo;s Name.",Desc:"Your armor, weapon or skill&rsquo;s Description.",Def:"Some weapons provide defense!",DefArmor:"How much this armor reduces damage.",Lvl:"The armor, weapon or skill&rsquo;s level. This is roughly equivalent to a dungeon level!",Cost:"How much your armor, weapon or skill costs in gold pieces",Min:"Weapons do a random amount of damage between a minimum and maximum amount (not counting skill effects). This is the LOWER end of that range.",Max:"Weapons do a random amount of damage between a minimum and maximum amount (not counting skill effects). This is the HIGHER end of that range.",Slot:'Armor pieces fit on a particular slot: Head, Chest, Pants, Gloves, Boots, or None. Items in a "none" slot simply stay in inventory.',Res:"Your armor can provide resistance against certain damage types.",Heavy:"Armors are restricted by weight, so a necromancer and sorcerer can only wear LIGHT armor, while a paladin and warrior can only wear HEAVY armor.",Energy:"How much energy your skill takes to cast.",Heal:"Heal, or Burst Heal, is a one-time effect that restores a portion of your health on casting. Generally, Burst Heals are stronger than Regen heals per unit time, but they don&rsquo;t last as long. Compare with Regeneration.",Regen:"Regen, or Regeneration, is a heal-over-time effect. Generally, regen heals are weaker per unit time than Burst Heals, but this is counteracted by their heal-over-time effect. Compare with Burst Heal.",Burst:"Burst, Damage, or Burst Damage is pretty much what it sounds like: one walloping great smack of damage. It happens all at once tho, so if your enemy survives it, you will need to come up with a new plan.",Degen:"Caused by effects like Burning, Bleeding, and Poison, Degeneration allows you to damage your foe a little bit over time. Great for adding a bit of pressure!",Type:"The type of damage done by your skill. Be aware that certain enemies are resistant to certain damage types, so attacking a Flame Elemental with a fire-based attack may not be the best use of your time.",Prev:'Except for the base skills - Bandage, Swing, Fireball, Chill, Curse, Smite, and Divine Blessing - every skill in the game has a "previous skill". In order to learn your skill, a player will need to have enough skill points AND own the previous skill.',ExtraFx:"Certain skills have additional effects. For example, the warrior&rsquo;s Uppercut stuns.",Image:"All skills require a skill icon!"};sandalchest.alert("Explanation",t[e])}}}]),app.controller("vote-con",["$scope","$http","userFact","$window",function(e,t,n,o){n.checkLogin().then(function(t){t?(e.user=t,a()):o.location.href="./login"}),e.skillVotes=[],e.newSlots=[{lbl:" Head",num:0},{lbl:" Chest",num:1},{lbl:" Pants",num:2},{lbl:" Gloves",num:3},{lbl:" Boots",num:4},{lbl:" None",num:5}],e.explVoteFld=n.getVoteExpl,e.armorVotes=[],e.weapVotes=[],e.slots=["","","","","",""],e.dtypes=["Physical","Fire","Ice","Poison","Dark","Holy"],e.items={armors:[],weaps:[],skills:[]},e.sortCols={weaps:"num",skills:"id",armors:"num"},e.sortRev={weaps:!1,skills:!1,armors:!1},e.newItemCat="weap",e.chSort=function(t,n){console.log("CHSORT",t,n,e.sortCols[n]),t==e.sortCols[n]?e.sortRev[n]=!e.sortRev[n]:(e.sortRev[n]=!1,e.sortCols[n]=t)},e.moveBar=function(e,t){e.voted||(e.voteCurr=5*t.offsetX/$(t.target).width(),e.voteCurr>5&&(e.voteCurr=5))},e.resetBar=function(e){e.voteCurr=e.votes},e.scrt=-40,e.scrollToDiv=function(e){console.log(e,$("#"+e).position().top),$(window).scrollTop($("#"+e).position().top)},window.onscroll=function(t){e.scrt=$(window).scrollTop()-40,e.$digest()},e.goGame=function(){sandalchest.confirm("Return to Game","Are you sure you want to stop voting and return to the game?",function(e){e&&(o.location.href="./")},{parent:".vote-nav"})},e.newItemCat="weap",e.chVotePan=function(t){return t!=e.newItemCat&&void $("#"+e.newItemCat+"-vote").hide(200,function(){e.newItemCat=t,$("#"+e.newItemCat+"-vote").show(200),e.$digest()})};var a=function(){t.get("./voting/voteList").then(function(t){e.skillVotes=[],e.armorVotes=[],e.weapVotes=[],e.items={armors:[],weaps:[],skills:[]},console.log(t.data.votes),t.data.votes.forEach(function(t){0==t.type?(t.weap.votes=t.votes.reduce(function(e,t){return e+t})/t.votes.length,t.weap.voteCurr=t.weap.votes,t.weap.vid=t.vid,t.weap.voted=t.votedUsrs&&t.votedUsrs.indexOf(e.user)>-1,e.weapVotes.push(t.weap)):1==t.type?(t.armor.votes=t.votes.reduce(function(e,t){return e+t})/t.votes.length,t.armor.voteCurr=t.armor.votes,t.armor.vid=t.vid,t.armor.voted=t.votedUsrs&&t.votedUsrs.indexOf(e.user)>-1,e.armorVotes.push(t.armor)):2==t.type&&(t.skill.votes=t.votes.reduce(function(e,t){return e+t})/t.votes.length,t.skill.voteCurr=t.skill.votes,t.skill.vid=t.vid,t.skill.voted=t.votedUsrs&&t.votedUsrs.indexOf(e.user)>-1,e.skillVotes.push(t.skill),console.log(t.skill))}),e.items.armors=t.data.armor,e.items.weaps=t.data.weaps,e.items.skills=t.data.skills,e.items.skills.forEach(function(e){e.effectList=[],e.stuns&&e.effectList.push("Stuns"),e.extraFx.dmgVsStun&&e.effectList.push("Extra dmg vs. Stunned"),e.extraFx.protection&&e.effectList.push("Adds Protection on next hit"),e.extraFx.dmgVsDegen&&e.effectList.push("Extra dmg vs. Degenned Foes"),e.extraFx.critChance&&e.effectList.push("Chance of critical hit")}),e.items.armors.forEach(function(t){t.resList=[],t.res.forEach(function(n){t.resList.push(e.dtypes[n])})})})};e.concatRes=function(t){var n=[];return e.dtypes.forEach(function(e,o){t[e]&&n.push(o)}),n},e.doVote=function(n,o){console.log("VID",n);var r={id:n.vid,val:5*o.offsetX/$(o.target).width(),usr:e.user};n.voted?sandalchest.alert("Sorry, but you've already voted for this item!",{parent:".vote-nav"}):(n.voted=!0,console.log("user wants to vote ",n.voteCurr,"for",n.name,"voted",n.voted),t.post("./voting/doVote",r).then(function(e){console.log("RESPONSE FROM VOTES:",e),a()}))},e.subArmorVote=function(){var n={type:1};n.armor={name:e.newIt.name,desc:e.newIt.desc,cost:e.newIt.cost,def:e.newIt.def,slot:e.newIt.slot,res:e.concatRes(e.newIt.res),itemLvl:e.newIt.itemLvl,heavy:e.newIt.heavy},n.vid=Math.floor(99999*Math.random()).toString(32),n.votedUsrs=e.user,n.votes=[],n.votesOpen=!0,n.user=e.user,t.post("./voting/subVote",n).then(function(e){"done"!=e.data?sandalchest.alert("Too Many Submissions","Sorry, but you&rsquo;ve submitted too many items recently. Please wait for one of your items to expire before submitting another!"):a()}),console.log("NEW ARMOR:",n)},e.subWeapVote=function(){var n={type:0};err||(n.weap={name:e.newIt.name,desc:e.newIt.desc,cost:e.newIt.cost,def:e.newIt.def,itemLvl:e.newIt.itemLvl,min:e.newIt.min,max:e.newIt.max},n.vid=Math.floor(99999*Math.random()).toString(32),n.votedUsrs=e.user,n.votes=[],n.votesOpen=!0,t.post("./voting/subVote",n).then(function(e){"done"!=e.data?sandalchest.alert("Too Many Submissions","Sorry, but you&rsquo;ve submitted too many items recently. Please wait for one of your items to expire before submitting another!"):a()}),console.log("NEW WEAPON:",n))},e.newIt={},e.subSkillVote=function(){var n={type:2};console.log("imgData",e.icon),e.icon.icon?e.icon.width>170||e.icon.height>170?sandalchest.alert("Error","Your image is too large! Please use the bars to resize it, or considering picking a different image.",function(){return!1},{parent:".vote-nav"}):e.icon.width<15||e.icon.height<15?sandalchest.alert("Error","Your image is too small! What is this, an image for ants?",function(){return!1},{parent:".vote-nav"}):e.icon.width/e.icon.height>2||e.icon.width/e.icon.height<.5?sandalchest.alert("Error","Your image has strange dimensions! Images should be approximately square",function(){return!1},{parent:".vote-nav"}):e.newIt.name&&e.newIt.desc&&(e.newIt.energy||0===e.newIt.energy)&&(e.newIt.heal||e.newIt.burst||e.newIt.regen||e.newIt.degen)&&e.newIt.type&&e.newIt.prevSkill?(n.skill={name:e.newIt.name,desc:e.newIt.desc,energy:e.newIt.energy,heal:e.newIt.heal||0,regen:e.newIt.regen||0,burst:e.newIt.burst||0,degen:e.newIt.degen||0,type:e.dtypes.indexOf(e.newIt.type)>-1?e.dtypes.indexOf(e.newIt.type):0,prevSkill:e.newIt.prevSkill||0,stuns:e.newIt.stuns,extraFx:e.newIt.extraFx,imgUrl:e.icon.icon},n.vid=Math.floor(99999*Math.random()).toString(32),n.votedUsrs=e.user,n.votes=[],n.votesOpen=!0,t.post("./voting/subVote",n).then(function(e){"done"!=e.data?sandalchest.alert("Too Many Submissions","Sorry, but you&rsquo;ve submitted too many items recently. Please wait for one of your items to expire before submitting another!"):a()}),console.log("NEW SKILL:",n)):sandalchest.alert("Error","One or more of your skill&rsquo;s parameters is undefined!",function(){return!1},{parent:".vote-nav"}):sandalchest.alert("Error","Skills require a skill icon! Please pick one.",function(){return!1},{parent:".vote-nav"})},e.sayIt=function(){console.log(e.newIt)},e.canv=document.querySelector("canvas"),e.ctx=e.canv.getContext("2d"),e.icon={width:100,height:100,maxWidth:100,maxHeight:100},e.getImage=function(t){console.log(t);var n=new FileReader;n.onload=function(t){var n=new Image;n.onload=function(){e.icon.width=n.width,e.icon.height=n.height,e.icon.maxWidth=n.width,e.icon.maxHeight=n.height,e.canv.style.width=n.width+"px",e.canv.style.height=n.height+"px",e.$digest(),console.log(e.icon.maxWidth,n.width,e.icon.maxHeight,n.height),e.ctx.drawImage(n,0,0),e.icon.width=n.width,e.icon.height=n.height,e.$digest(),setTimeout(function(){e.icon.width=n.width,e.icon.height=n.height,e.$digest()},1),e.icon.icon=e.canv.toDataURL()},n.src=t.target.result},n.readAsDataURL(t.target.files[0])},document.querySelector("#filepkr").addEventListener("change",e.getImage,!1)}]);